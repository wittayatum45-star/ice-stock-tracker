<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ice Commander V39 (Perfect UI)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Global Theme --- */
        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 0; background: #f4f6f8; color: #37474f; padding-bottom: 90px; font-size: 14px; }
        * { box-sizing: border-box; }

        /* --- 1. Dashboard (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ) --- */
        .dashboard {
            position: sticky; top: 0; z-index: 1000;
            background: #263238; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ */
            color: white;
            padding: 15px 10px;
            display: flex; justify-content: space-around;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .dash-item { text-align: center; }
        .dash-item span { font-size: 0.85rem; color: #b0bec5; display: block; margin-bottom: 5px; }
        .dash-item div { font-size: 1.6rem; font-weight: 700; }
        /* ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô Dash */
        .val-pos { color: #00e676; } /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
        .val-neg { color: #ff1744; } /* ‡πÅ‡∏î‡∏á */
        .val-zero { color: #cfd8dc; } /* ‡πÄ‡∏ó‡∏≤ */

        /* --- 2. Navigation Bar (‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏Ñ‡∏õ‡∏ã‡∏π‡∏•) --- */
        .nav-container { background: white; padding: 10px; position: sticky; top: 80px; z-index: 900; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .nav-bar {
            display: flex; background: #eceff1; border-radius: 50px; padding: 5px;
        }
        .nav-btn {
            flex: 1; padding: 10px; border: none; background: none; 
            font-weight: 600; color: #78909c; cursor: pointer; border-radius: 50px;
            transition: all 0.2s; font-size: 0.9rem;
        }
        .nav-btn.active { background: #0277bd; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* --- Page Layout --- */
        .page { display: none; padding: 15px; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }

        /* --- Card Styles --- */
        .card { 
            background: white; border-radius: 16px; padding: 20px; 
            margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); 
            border: 1px solid #eceff1;
        }
        .card h3 { 
            margin: 0 0 15px 0; color: #01579b; font-size: 1.1rem; 
            display: flex; align-items: center; gap: 8px;
        }
        .sub-text { color: #90a4ae; font-size: 0.85rem; margin-top: -10px; margin-bottom: 15px; }

        /* --- Table Styles (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πä‡∏∞) --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { 
            background: #eceff1; color: #546e7a; font-weight: 700; padding: 12px 8px; 
            font-size: 0.9rem; border-bottom: 2px solid #cfd8dc;
        }
        th:first-child { border-top-left-radius: 8px; }
        th:last-child { border-top-right-radius: 8px; }
        
        td { border-bottom: 1px solid #f0f0f0; padding: 12px 8px; text-align: center; font-size: 0.95rem; }
        tr:last-child td { border-bottom: none; }
        
        /* ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ñ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤ */
        .truck-col { font-weight: 700; color: #37474f; text-align: left; padding-left: 15px; }

        /* --- Status Pills (‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ) --- */
        .pill { 
            display: inline-block; padding: 4px 10px; border-radius: 6px; 
            font-weight: 700; font-size: 0.85rem; min-width: 60px;
        }
        /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ (‡πÄ‡∏Å‡∏¥‡∏ô) ‡πÅ‡∏ö‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ */
        .st-over { background: #e3f2fd; color: #1565c0; } 
        /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á (‡∏Ç‡∏≤‡∏î) */
        .st-miss { background: #ffebee; color: #c62828; }
        /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏Ñ‡∏£‡∏ö) */
        .st-ok { background: #e8f5e9; color: #2e7d32; }
        /* ‡∏Ç‡∏µ‡∏î‡πÄ‡∏â‡∏¢‡πÜ */
        .st-none { color: #cfd8dc; }

        /* --- Inputs --- */
        input[type="number"] {
            width: 100%; padding: 8px; text-align: center; font-size: 1rem; font-weight: 600;
            border: 1px solid #cfd8dc; border-radius: 8px; background: #fafafa; color: #37474f;
        }
        input[type="number"]:focus { border-color: #29b6f6; background: white; outline: none; }

        /* --- FAB Button (+) --- */
        .fab {
            position: fixed; bottom: 25px; right: 25px; width: 65px; height: 65px;
            background: #00c853; color: white; border-radius: 50%; border: none;
            font-size: 32px; box-shadow: 0 6px 16px rgba(0,200,83,0.4); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .fab:active { transform: scale(0.95); }

        /* ‡∏´‡∏ô‡πâ‡∏≤ 2 List Styles */
        .drop-item {
            background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 12px;
            border-left: 6px solid #00c853; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }
        .drop-time { font-weight: 700; font-size: 1.1rem; color: #263238; }
        .badge-prod { background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-left: 5px; }
        .del-btn { position: absolute; top: 10px; right: 10px; background: #ffebee; color: #c62828; border:none; padding: 5px 10px; border-radius: 6px; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

    <div class="dashboard">
        <div class="dash-item">
            <span>üßä ‡∏´‡∏•‡∏≠‡∏î</span>
            <div id="dash_hl" class="val-zero">0</div>
        </div>
        <div class="dash-item">
            <span>üî® ‡∏´‡∏¢‡∏≤‡∏ö</span>
            <div id="dash_bh" class="val-zero">0</div>
        </div>
        <div class="dash-item">
            <span>‚ùÑÔ∏è ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
            <div id="dash_bl" class="val-zero">0</div>
        </div>
    </div>

    <div class="nav-container">
        <div class="nav-bar">
            <button class="nav-btn active" onclick="switchPage('page1', this)">1. ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á (‡πÄ‡∏õ‡πâ‡∏≤)</button>
            <button class="nav-btn" onclick="switchPage('page2', this)">2. ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏™‡πà‡∏á)</button>
            <button class="nav-btn" onclick="switchPage('page3', this)">3. ‡∏™‡∏£‡∏∏‡∏õ (‡∏ú‡∏•)</button>
        </div>
    </div>

    <div id="page1" class="page active">
        <div class="card">
            <h3>üìù ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Order)</h3>
            <p class="sub-text">‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏™‡∏≤‡∏¢‡∏£‡∏ñ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
            <div id="order_table_container"></div>
        </div>
        <div class="card">
             <h3>üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πâ‡∏≤)</h3>
             <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                 <div><label>üßä ‡∏´‡∏•‡∏≠‡∏î</label><input type="number" id="init_hl" value="0" oninput="saveAndCalc()"></div>
                 <div><label>üî® ‡∏´‡∏¢‡∏≤‡∏ö</label><input type="number" id="init_bh" value="0" oninput="saveAndCalc()"></div>
                 <div><label>‚ùÑÔ∏è ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><input type="number" id="init_bl" value="0" oninput="saveAndCalc()"></div>
             </div>
        </div>
    </div>

    <div id="page2" class="page">
        <div id="drops_list"></div>
        <div style="text-align:center; color:#cfd8dc; margin-top:30px; font-weight:300;">
            ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° + ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á
        </div>
    </div>

    <div id="page3" class="page">
        <div class="card">
            <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡∏Ñ‡∏±‡∏ô (Real-time)</h3>
            <p class="sub-text">( ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ - ‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á = ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ )</p>
            <div id="summary_table_container"></div>
        </div>
        
        <div class="card">
            <h3>üè≠ ‡∏¢‡∏≠‡∏î‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
            <table style="text-align:left;">
                <tr><td style="text-align:left;">üßä ‡∏ú‡∏•‡∏¥‡∏ï‡∏´‡∏•‡∏≠‡∏î:</td><td id="sum_prod_hl" style="font-weight:bold;">0</td></tr>
                <tr><td style="text-align:left;">üî® ‡∏ú‡∏•‡∏¥‡∏ï‡∏´‡∏¢‡∏≤‡∏ö:</td><td id="sum_prod_bh" style="font-weight:bold;">0</td></tr>
                <tr><td style="text-align:left;">‚ùÑÔ∏è ‡∏ú‡∏•‡∏¥‡∏ï‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</td><td id="sum_prod_bl" style="font-weight:bold;">0</td></tr>
                <tr style="background:#f1f8e9;"><td style="text-align:left; font-weight:bold;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</td><td id="sum_prod_total" style="font-weight:bold; color:#2e7d32;">0</td></tr>
            </table>
        </div>
    </div>

    <button class="fab" onclick="addDrop()">+</button>

<script>
    // --- Config ---
    const TRUCKS = ["‡∏£‡∏ñ 1", "‡∏£‡∏ñ 2", "‡∏£‡∏ñ 3", "‡∏£‡∏ñ 4", "‡∏£‡∏ñ 5", "‡∏£‡∏ñ 6", "‡∏£‡∏ñ 7", "‡∏£‡∏ñ 8", "‡∏£‡∏ñ 9"];
    const TYPES = [
        {id: 'hl', label: '‡∏´‡∏•‡∏≠‡∏î', icon: 'üßä'}, 
        {id: 'bh', label: '‡∏´‡∏¢‡∏≤‡∏ö', icon: 'üî®'}, 
        {id: 'bl', label: '‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', icon: '‚ùÑÔ∏è'}
    ];
    
    let DATA = {
        orders: {}, 
        drops: [], 
        initStock: { hl:0, bh:0, bl:0 }
    };

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        renderPage1();
        renderPage2();
        calcAll();
    });

    // --- Page 1 Render ---
    function renderPage1() {
        let html = `<table><thead><tr><th style="text-align:left; padding-left:15px;">‡∏£‡∏ñ</th><th>üßä</th><th>üî®</th><th>‚ùÑÔ∏è</th></tr></thead><tbody>`;
        TRUCKS.forEach((t, i) => {
            const tid = `t${i+1}`;
            html += `<tr>
                <td class="truck-col">${t}</td>
                <td><input type="number" value="${DATA.orders[tid+'_hl']||''}" placeholder="-" oninput="updateOrder('${tid}_hl', this.value)"></td>
                <td><input type="number" value="${DATA.orders[tid+'_bh']||''}" placeholder="-" oninput="updateOrder('${tid}_bh', this.value)"></td>
                <td><input type="number" value="${DATA.orders[tid+'_bl']||''}" placeholder="-" oninput="updateOrder('${tid}_bl', this.value)"></td>
            </tr>`;
        });
        html += `</tbody></table>`;
        document.getElementById('order_table_container').innerHTML = html;
        
        document.getElementById('init_hl').value = DATA.initStock.hl;
        document.getElementById('init_bh').value = DATA.initStock.bh;
        document.getElementById('init_bl').value = DATA.initStock.bl;
    }

    function updateOrder(key, val) {
        DATA.orders[key] = parseFloat(val) || 0;
        saveAndCalc();
    }

    // --- Page 2 Logic ---
    function addDrop() {
        const now = new Date();
        const timeStr = now.toTimeString().substring(0, 5);
        DATA.drops.push({
            id: Date.now(),
            time: timeStr,
            prod: { hl:0, bh:0, bl:0 },
            dist: []
        });
        saveAndCalc();
        renderPage2();
        switchPage('page2', document.querySelectorAll('.nav-btn')[1]);
    }

    function renderPage2() {
        const container = document.getElementById('drops_list');
        container.innerHTML = '';
        
        DATA.drops.slice().reverse().forEach((d) => {
            let distHtml = '';
            d.dist.forEach((item, idx) => {
                distHtml += `
                <div style="display:flex; gap:5px; margin-top:5px; align-items:center; background:#f9f9f9; padding:5px; border-radius:6px;">
                    <select onchange="updateDist(${d.id}, ${idx}, 'truck', this.value)" style="flex:1; padding:5px; border:1px solid #ddd; border-radius:4px;">
                        ${TRUCKS.map((t, ti) => `<option value="t${ti+1}" ${item.truck==='t'+(ti+1)?'selected':''}>${t}</option>`).join('')}
                    </select>
                    <select onchange="updateDist(${d.id}, ${idx}, 'type', this.value)" style="width:70px; padding:5px; border:1px solid #ddd; border-radius:4px;">
                        ${TYPES.map(ty => `<option value="${ty.id}" ${item.type===ty.id?'selected':''}>${ty.label}</option>`).join('')}
                    </select>
                    <input type="number" value="${item.qty}" oninput="updateDist(${d.id}, ${idx}, 'qty', this.value)" style="width:50px; padding:5px;">
                    <button onclick="removeDist(${d.id}, ${idx})" style="color:red; border:none; background:none;">√ó</button>
                </div>`;
            });

            const html = `
            <div class="drop-item">
                <div style="display:flex; justify-content:space-between;">
                    <span class="drop-time">üïí ${d.time} <span class="badge-prod">‡∏£‡∏≠‡∏ö‡∏ú‡∏•‡∏¥‡∏ï/‡∏™‡πà‡∏á</span></span>
                    <button class="del-btn" onclick="deleteDrop(${d.id})">‡∏•‡∏ö</button>
                </div>
                
                <div style="margin-top:10px; padding-bottom:10px; border-bottom:1px dashed #eee;">
                    <div style="font-size:0.85rem; color:#546e7a; margin-bottom:5px;">üè≠ ‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á:</div>
                    <div style="display:flex; gap:5px;">
                        <input type="number" placeholder="‡∏´‡∏•‡∏≠‡∏î" value="${d.prod.hl||''}" oninput="updateProd(${d.id}, 'hl', this.value)">
                        <input type="number" placeholder="‡∏´‡∏¢‡∏≤‡∏ö" value="${d.prod.bh||''}" oninput="updateProd(${d.id}, 'bh', this.value)">
                        <input type="number" placeholder="‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" value="${d.prod.bl||''}" oninput="updateProd(${d.id}, 'bl', this.value)">
                    </div>
                </div>

                <div style="margin-top:10px;">
                    <div style="font-size:0.85rem; color:#546e7a; margin-bottom:5px;">üöö ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å:</div>
                    ${distHtml}
                    <button onclick="addDist(${d.id})" style="width:100%; margin-top:5px; padding:8px; background:#eceff1; border:none; border-radius:6px; color:#546e7a; font-weight:bold;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</button>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- Update Functions ---
    function updateProd(id, type, val) {
        const d = DATA.drops.find(x => x.id === id);
        if(d) { d.prod[type] = parseFloat(val) || 0; saveAndCalc(); }
    }
    function addDist(id) {
        const d = DATA.drops.find(x => x.id === id);
        if(d) { d.dist.push({truck:'t1', type:'hl', qty:0}); saveAndCalc(); renderPage2(); }
    }
    function updateDist(id, idx, field, val) {
        const d = DATA.drops.find(x => x.id === id);
        if(d) {
            if(field === 'qty') d.dist[idx][field] = parseFloat(val) || 0;
            else d.dist[idx][field] = val;
            saveAndCalc();
        }
    }
    function removeDist(id, idx) {
        const d = DATA.drops.find(x => x.id === id);
        if(d) { d.dist.splice(idx, 1); saveAndCalc(); renderPage2(); }
    }
    function deleteDrop(id) {
        if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) { DATA.drops = DATA.drops.filter(x => x.id !== id); saveAndCalc(); renderPage2(); }
    }

    // --- Page 3: Summary Logic & Rendering ---
    function renderPage3(stats) {
        const container = document.getElementById('summary_table_container');
        let html = `<table><thead><tr><th>‡∏£‡∏ñ</th><th>‡∏´‡∏•‡∏≠‡∏î</th><th>‡∏´‡∏¢‡∏≤‡∏ö</th><th>‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr></thead><tbody>`;
        
        TRUCKS.forEach((t, i) => {
            const tid = `t${i+1}`;
            html += `<tr><td class="truck-col">${t}</td>`;
            
            TYPES.forEach(type => {
                const target = DATA.orders[`${tid}_${type.id}`] || 0;
                const sent = stats.sent[`${tid}_${type.id}`] || 0;
                const remaining = target - sent;
                
                let cellContent = `<span class="st-none">-</span>`;
                
                // Logic ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ (Pill Style)
                if (target > 0 || sent > 0) {
                    if (remaining > 0) {
                        // ‡∏Ç‡∏≤‡∏î
                        cellContent = `<span class="pill st-miss">‡∏Ç‡∏≤‡∏î ${remaining}</span>`;
                    } else if (remaining < 0) {
                        // ‡πÄ‡∏Å‡∏¥‡∏ô (‡πÅ‡∏ö‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ "‡πÄ‡∏Å‡∏¥‡∏ô 30" ‡∏™‡∏µ‡∏ü‡πâ‡∏≤)
                        cellContent = `<span class="pill st-over">‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(remaining)}</span>`;
                    } else {
                        // ‡∏Ñ‡∏£‡∏ö
                        cellContent = `<span class="pill st-ok">‡∏Ñ‡∏£‡∏ö</span>`;
                    }
                }
                html += `<td>${cellContent}</td>`;
            });
            html += `</tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;

        document.getElementById('sum_prod_hl').innerText = stats.prod.hl;
        document.getElementById('sum_prod_bh').innerText = stats.prod.bh;
        document.getElementById('sum_prod_bl').innerText = stats.prod.bl;
        document.getElementById('sum_prod_total').innerText = stats.prod.hl + stats.prod.bh + stats.prod.bl;
    }

    // --- Calculation Core ---
    function calcAll() {
        let totalProd = { hl:0, bh:0, bl:0 };
        let totalSentByTruck = {}; 
        
        DATA.drops.forEach(d => {
            totalProd.hl += d.prod.hl || 0;
            totalProd.bh += d.prod.bh || 0;
            totalProd.bl += d.prod.bl || 0;
            
            d.dist.forEach(item => {
                const key = `${item.truck}_${item.type}`;
                if(!totalSentByTruck[key]) totalSentByTruck[key] = 0;
                totalSentByTruck[key] += item.qty;
            });
        });

        // Stock Logic
        let currentStock = {
            hl: (parseFloat(document.getElementById('init_hl').value)||0) + totalProd.hl,
            bh: (parseFloat(document.getElementById('init_bh').value)||0) + totalProd.bh,
            bl: (parseFloat(document.getElementById('init_bl').value)||0) + totalProd.bl
        };
        
        // ‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å
        for(let key in totalSentByTruck) {
            if(key.includes('_hl')) currentStock.hl -= totalSentByTruck[key];
            if(key.includes('_bh')) currentStock.bh -= totalSentByTruck[key];
            if(key.includes('_bl')) currentStock.bl -= totalSentByTruck[key];
        }

        // Update Dashboard with Colors
        updateDash('dash_hl', currentStock.hl);
        updateDash('dash_bh', currentStock.bh);
        updateDash('dash_bl', currentStock.bl);

        renderPage3({ sent: totalSentByTruck, prod: totalProd });
    }

    function updateDash(id, val) {
        const el = document.getElementById(id);
        el.innerText = val;
        el.className = ''; // Reset class
        if(val > 0) el.classList.add('val-pos');
        else if(val < 0) el.classList.add('val-neg');
        else el.classList.add('val-zero');
    }

    function switchPage(pageId, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
    }

    function saveAndCalc() {
        DATA.initStock = {
            hl: parseFloat(document.getElementById('init_hl').value)||0,
            bh: parseFloat(document.getElementById('init_bh').value)||0,
            bl: parseFloat(document.getElementById('init_bl').value)||0
        };
        localStorage.setItem('ICE_V39', JSON.stringify(DATA));
        calcAll();
    }
    
    function loadData() {
        const d = localStorage.getItem('ICE_V39');
        if(d) {
            DATA = JSON.parse(d);
            if(!DATA.orders) DATA.orders = {};
            if(!DATA.drops) DATA.drops = [];
            if(!DATA.initStock) DATA.initStock = { hl:0, bh:0, bl:0 };
        }
    }
</script>
</body>
</html>
