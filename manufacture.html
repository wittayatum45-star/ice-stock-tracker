<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ice Commander V15</title>
    <style>
        /* --- Global Theme --- */
        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 0; background: #eceff1; color: #37474f; padding-bottom: 80px; font-size: 14px; }
        * { box-sizing: border-box; }

        /* --- Sticky Dashboard (Live Stock) --- */
        .dashboard {
            position: sticky; top: 0; z-index: 1000;
            background: #263238; color: white;
            padding: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .dash-row { display: flex; justify-content: space-between; gap: 5px; }
        .stock-box {
            flex: 1; background: #37474f; border-radius: 6px; padding: 5px; text-align: center;
            border: 1px solid #455a64;
        }
        .stock-title { font-size: 0.75rem; color: #b0bec5; display: block; }
        .stock-val { font-size: 1.2rem; font-weight: bold; color: #69f0ae; display: block; }
        .stock-val.neg { color: #ff5252; }

        /* --- Tabs --- */
        .nav-bar { display: flex; background: white; border-bottom: 1px solid #cfd8dc; position: sticky; top: 68px; z-index: 900; }
        .nav-btn { flex: 1; padding: 12px; text-align: center; border: none; background: none; font-weight: bold; color: #78909c; cursor: pointer; }
        .nav-btn.active { color: #0277bd; border-bottom: 3px solid #0277bd; background: #e1f5fe; }

        /* --- Page Content --- */
        .page { display: none; padding: 10px; max-width: 800px; margin: 0 auto; }
        .page.active { display: block; }

        /* --- Cards & Inputs --- */
        .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card h3 { margin: 0 0 10px 0; font-size: 1.1rem; color: #0277bd; border-bottom: 1px dashed #eceff1; padding-bottom: 5px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 3px; color: #546e7a; }
        
        input[type="number"], input[type="time"], input[type="date"] {
            width: 100%; padding: 8px; font-size: 1.1rem; text-align: center;
            border: 1px solid #cfd8dc; border-radius: 4px; background: #fafafa;
            -moz-appearance: textfield;
        }
        input[type="number"]:focus { background: #fff8e1; border-color: #ffa000; outline: none; }

        /* --- Truck Order Table --- */
        .order-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .order-table th { text-align: left; color: #78909c; font-size: 0.8rem; }
        .order-table td { padding: 5px 0; border-bottom: 1px solid #eceff1; }
        .order-table input { font-size: 1rem; padding: 5px; }

        /* --- The "Drop" Card (Complex) --- */
        .drop-card { border-left: 5px solid #00e676; position: relative; }
        .drop-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #e8f5e9; padding: 8px; border-radius: 4px; }
        .drop-time { font-weight: bold; font-size: 1.1rem; }
        .btn-del { background: #ffcdd2; color: #c62828; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }

        /* Production Inputs */
        .prod-section { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; background: #f1f8e9; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #c8e6c9; }
        .prod-section div { text-align: center; }
        .prod-section label { color: #2e7d32; }

        /* Distribution List */
        .dist-list { margin-top: 10px; }
        .dist-item { background: #fff; border: 1px solid #eee; margin-bottom: 5px; padding: 8px; border-radius: 6px; display: flex; flex-direction: column; gap: 5px; }
        .dist-header { display: flex; justify-content: space-between; font-weight: bold; color: #0277bd; }
        
        .dist-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; align-items: end; }
        .dist-inputs input { font-size: 1rem; padding: 5px; }
        .label-fresh { color: #2e7d32; font-size: 0.75rem; } /* ‡∏™‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á */
        .label-stock { color: #0277bd; font-size: 0.75rem; } /* ‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á */
        .input-fresh { background-color: #e8f5e9 !important; border-color: #a5d6a7 !important; }
        .input-stock { background-color: #e1f5fe !important; border-color: #81d4fa !important; }

        .btn-add-dist { width: 100%; padding: 8px; background: #eceff1; color: #546e7a; border: 1px dashed #b0bec5; border-radius: 6px; margin-top: 5px; cursor: pointer; }
        
        /* Floating Action Button */
        .fab {
            position: fixed; bottom: 20px; right: 20px;
            background: #00e676; color: #004d40;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: none; cursor: pointer; z-index: 999;
        }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="dash-row" style="margin-bottom: 5px; justify-content: center; font-size: 0.9rem;">
            <span id="dash_time_status">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: 0 ‡∏ô‡∏≤‡∏ó‡∏µ</span>
        </div>
        <div class="dash-row">
            <div class="stock-box">
                <span class="stock-title">üßä ‡∏´‡∏•‡∏≠‡∏î (‡∏´‡πâ‡∏≠‡∏á)</span>
                <span id="stk_hl" class="stock-val">0</span>
            </div>
            <div class="stock-box">
                <span class="stock-title">üî® ‡∏ö‡∏î‡∏´‡∏¢‡∏≤‡∏ö</span>
                <span id="stk_bh" class="stock-val">0</span>
            </div>
            <div class="stock-box">
                <span class="stock-title">‚ùÑÔ∏è ‡∏ö‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
                <span id="stk_bl" class="stock-val">0</span>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchPage('setup')">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤/‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
        <button class="nav-btn" onclick="switchPage('production')">2. ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï</button>
    </div>

    <div id="page-setup" class="page active">
        
        <div class="card">
            <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="setup_date" onchange="saveData()">
            
            <div class="form-grid" style="margin-top: 10px;">
                <div><label>üü¢ ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="time" id="time_start" onchange="saveData(); calcTime();"></div>
                <div><label>üî¥ ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="time" id="time_stop" onchange="saveData(); calcTime();"></div>
            </div>
        </div>

        <div class="card">
            <h3>üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ (‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô)</h3>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div><label>‡∏´‡∏•‡∏≠‡∏î</label><input type="number" id="init_hl" value="0" oninput="saveData(); calcAll();"></div>
                <div><label>‡∏´‡∏¢‡∏≤‡∏ö</label><input type="number" id="init_bh" value="0" oninput="saveData(); calcAll();"></div>
                <div><label>‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><input type="number" id="init_bl" value="0" oninput="saveData(); calcAll();"></div>
            </div>
        </div>

        <div class="card">
            <h3>üöö ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢)</h3>
            <table class="order-table">
                <thead>
                    <tr><th style="width:40%">‡∏£‡∏ñ</th><th>‡∏´‡∏•‡∏≠‡∏î</th><th>‡∏´‡∏¢‡∏≤‡∏ö</th><th>‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr>
                </thead>
                <tbody id="order_list_body">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="page-production" class="page">
        
        <div id="drops_container">
            </div>

        <div style="text-align: center; color: #90a4ae; margin-top: 20px;">
            ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏Å
        </div>
    </div>

    <button class="fab" onclick="addDrop()">+</button>

<script>
    // --- CONFIG ---
    const TRUCKS = [
        "‡∏£‡∏ñ 1", "‡∏£‡∏ñ 2", "‡∏£‡∏ñ 3", "‡∏£‡∏ñ 4", "‡∏£‡∏ñ 5", "‡∏£‡∏ñ 6", "‡∏£‡∏ñ 7", "‡∏£‡∏ñ 8", "‡∏£‡∏ñ 9"
    ];
    const TYPES = ['hl', 'bh', 'bl']; // IDs used in code

    // --- STATE ---
    let DATA = {
        date: new Date().toISOString().split('T')[0],
        times: { start: "22:00", stop: "06:00" },
        initStock: { hl: 0, bh: 0, bl: 0 },
        orders: {}, // { 'truck1_hl': 50, ... }
        drops: []   // The main event log
    };

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        renderOrders();
        renderDrops();
        calcAll();
        calcTime();
    });

    // --- CORE FUNCTIONS ---

    function addDrop() {
        const id = Date.now();
        // Auto time
        const now = new Date();
        const timeStr = now.toTimeString().substring(0, 5);

        const newDrop = {
            id: id,
            time: timeStr,
            prod: { hl: 0, bh: 0, bl: 0 }, // Produced (Input)
            dist: [] // Array of { truck: "‡∏£‡∏ñ 1", type: "hl", src: "fresh/stock", qty: 10 }
        };
        DATA.drops.push(newDrop);
        saveData();
        renderDrops();
        // Scroll to bottom
        setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
    }

    function deleteDrop(id) {
        if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) {
            DATA.drops = DATA.drops.filter(d => d.id !== id);
            saveData();
            renderDrops();
            calcAll();
        }
    }

    // --- DISTRIBUTION LOGIC ---
    // Users add a "Distribution Row" to a drop card
    function addDistRow(dropId) {
        const drop = DATA.drops.find(d => d.id === dropId);
        if(drop) {
            drop.dist.push({ truck: "‡∏£‡∏ñ 1", type: "hl", fresh: 0, stock: 0 });
            saveData();
            renderDrops(); // Re-render just this card ideally, but full render is safer for now
        }
    }

    function removeDistRow(dropId, distIndex) {
        const drop = DATA.drops.find(d => d.id === dropId);
        if(drop) {
            drop.dist.splice(distIndex, 1);
            saveData();
            renderDrops();
            calcAll();
        }
    }

    // --- RENDERING ---

    function renderOrders() {
        const tbody = document.getElementById('order_list_body');
        let html = '';
        TRUCKS.forEach((t, i) => {
            const tid = `t${i+1}`;
            html += `
            <tr>
                <td>${t}</td>
                <td><input type="number" placeholder="0" value="${DATA.orders[tid+'_hl']||''}" onchange="updateOrder('${tid}_hl', this.value)"></td>
                <td><input type="number" placeholder="0" value="${DATA.orders[tid+'_bh']||''}" onchange="updateOrder('${tid}_bh', this.value)"></td>
                <td><input type="number" placeholder="0" value="${DATA.orders[tid+'_bl']||''}" onchange="updateOrder('${tid}_bl', this.value)"></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    function renderDrops() {
        const container = document.getElementById('drops_container');
        container.innerHTML = '';

        // Reverse to show latest at bottom? Or Top? Usually Production logs go Top-Down. 
        // Let's keep array order (Oldest first) to match user's flow.
        
        DATA.drops.forEach((d, idx) => {
            // Distribution HTML
            let distHtml = '';
            d.dist.forEach((item, dIdx) => {
                distHtml += `
                <div class="dist-item">
                    <div class="dist-header">
                        <select onchange="updateDist(${d.id}, ${dIdx}, 'truck', this.value)">
                            ${TRUCKS.map(t => `<option value="${t}" ${item.truck===t?'selected':''}>${t}</option>`).join('')}
                        </select>
                        <select onchange="updateDist(${d.id}, ${dIdx}, 'type', this.value)">
                            <option value="hl" ${item.type==='hl'?'selected':''}>‡∏´‡∏•‡∏≠‡∏î</option>
                            <option value="bh" ${item.type==='bh'?'selected':''}>‡∏ö‡∏î‡∏´‡∏¢‡∏≤‡∏ö</option>
                            <option value="bl" ${item.type==='bl'?'selected':''}>‡∏ö‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</option>
                        </select>
                        <button style="background:none; border:none; color:red;" onclick="removeDistRow(${d.id}, ${dIdx})">‚úñ</button>
                    </div>
                    <div class="dist-inputs">
                        <div>
                            <span class="label-fresh">üî• ‡∏™‡∏î (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</span>
                            <input type="number" class="input-fresh" value="${item.fresh||''}" placeholder="0" oninput="updateDist(${d.id}, ${dIdx}, 'fresh', this.value)" onfocus="clearZero(this)">
                        </div>
                        <div>
                            <span class="label-stock">‚ùÑÔ∏è ‡πÄ‡∏Å‡πà‡∏≤ (‡∏´‡πâ‡∏≠‡∏á)</span>
                            <input type="number" class="input-stock" value="${item.stock||''}" placeholder="0" oninput="updateDist(${d.id}, ${dIdx}, 'stock', this.value)" onfocus="clearZero(this)">
                        </div>
                    </div>
                </div>`;
            });

            const html = `
            <div class="card drop-card">
                <div class="drop-header">
                    <span class="drop-time">‡∏ï‡∏Å‡∏ó‡∏µ‡πà ${idx+1} (@<input type="time" value="${d.time}" onchange="updateDrop(${d.id}, 'time', this.value)" style="width:auto; border:none; background:none; font-weight:bold;">)</span>
                    <button class="btn-del" onclick="deleteDrop(${d.id})">‡∏•‡∏ö‡∏ï‡∏Å</button>
                </div>

                <div class="prod-section">
                    <div><label>‡∏ú‡∏•‡∏¥‡∏ï‡∏´‡∏•‡∏≠‡∏î</label><input type="number" class="bg-green" value="${d.prod.hl||''}" placeholder="0" oninput="updateDrop(${d.id}, 'prod.hl', this.value)" onfocus="clearZero(this)"></div>
                    <div><label>‡∏ú‡∏•‡∏¥‡∏ï‡∏´‡∏¢‡∏≤‡∏ö</label><input type="number" class="bg-green" value="${d.prod.bh||''}" placeholder="0" oninput="updateDrop(${d.id}, 'prod.bh', this.value)" onfocus="clearZero(this)"></div>
                    <div><label>‡∏ú‡∏•‡∏¥‡∏ï‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><input type="number" class="bg-green" value="${d.prod.bl||''}" placeholder="0" oninput="updateDrop(${d.id}, 'prod.bl', this.value)" onfocus="clearZero(this)"></div>
                </div>

                <div class="dist-list">
                    ${distHtml}
                    <button class="btn-add-dist" onclick="addDistRow(${d.id})">+ ‡πÉ‡∏™‡πà‡∏£‡∏ñ (‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á)</button>
                </div>
            </div>`;
            
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- DATA UPDATERS ---

    function updateOrder(key, val) {
        DATA.orders[key] = parseFloat(val) || 0;
        saveData();
    }

    function updateDrop(id, fieldPath, val) {
        const drop = DATA.drops.find(d => d.id === id);
        if(!drop) return;

        if(fieldPath === 'time') {
            drop.time = val;
        } else {
            // Handle prod.hl etc.
            const parts = fieldPath.split('.');
            if(parts.length === 2) {
                drop[parts[0]][parts[1]] = parseFloat(val) || 0;
            }
        }
        saveData();
        calcAll();
    }

    function updateDist(dropId, distIdx, field, val) {
        const drop = DATA.drops.find(d => d.id === dropId);
        if(!drop || !drop.dist[distIdx]) return;

        if(field === 'fresh' || field === 'stock') {
            drop.dist[distIdx][field] = parseFloat(val) || 0;
        } else {
            drop.dist[distIdx][field] = val;
        }
        saveData();
        calcAll();
    }

    // --- CALCULATIONS (THE BRAIN) ---

    function calcAll() {
        // 1. Start with Initial Stock
        let current = {
            hl: parseFloat(document.getElementById('init_hl').value) || 0,
            bh: parseFloat(document.getElementById('init_bh').value) || 0,
            bl: parseFloat(document.getElementById('init_bl').value) || 0
        };

        // 2. Iterate drops
        DATA.drops.forEach(d => {
            // ADD Production
            current.hl += d.prod.hl;
            current.bh += d.prod.bh;
            current.bl += d.prod.bl;

            // SUBTRACT Distribution
            d.dist.forEach(item => {
                // item.type is 'hl', 'bh', 'bl'
                // item.fresh -> Taken from machine (Does not affect Room Stock? Wait.)
                // LOGIC CHECK: 
                // If I produce 100 (added to current).
                // If I give 20 Fresh -> It leaves the system immediately. So subtract it.
                // If I give 20 Stock -> It leaves the room. Subtract it.
                // Conclusion: Both subtract from the "Running Balance" of the system.
                
                if(current[item.type] !== undefined) {
                    current[item.type] -= item.fresh;
                    current[item.type] -= item.stock;
                }
            });
        });

        // 3. Update Dashboard
        updateDash('stk_hl', current.hl);
        // Sum Crushed types for dashboard (as per user request usually crushed is grouped, but user asked for 3 types. Let's show distinct)
        updateDash('stk_bh', current.bh);
        updateDash('stk_bl', current.bl);
    }

    function updateDash(id, val) {
        const el = document.getElementById(id);
        el.textContent = val;
        if(val <= 0) el.className = "stock-val neg";
        else el.className = "stock-val";
    }

    function calcTime() {
        const start = document.getElementById('time_start').value;
        const stop = document.getElementById('time_stop').value;
        if(start && stop) {
            let s = parseInt(start.split(':')[0])*60 + parseInt(start.split(':')[1]);
            let e = parseInt(stop.split(':')[0])*60 + parseInt(stop.split(':')[1]);
            let diff = e - s;
            if(diff < 0) diff += 1440; // Midnight fix
            document.getElementById('dash_time_status').textContent = `‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${diff} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
    }

    // --- UTILS ---
    function switchPage(pid) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('page-'+pid).classList.add('active');
        // Toggle active class for buttons is lazy here, assume order 0,1
        if(pid==='setup') document.querySelectorAll('.nav-btn')[0].classList.add('active');
        else document.querySelectorAll('.nav-btn')[1].classList.add('active');
    }

    function clearZero(el) {
        if(el.value == '0') el.value = '';
    }

    function saveData() {
        // Update state from setup inputs
        DATA.date = document.getElementById('setup_date').value;
        DATA.times.start = document.getElementById('time_start').value;
        DATA.times.stop = document.getElementById('time_stop').value;
        DATA.initStock.hl = document.getElementById('init_hl').value;
        DATA.initStock.bh = document.getElementById('init_bh').value;
        DATA.initStock.bl = document.getElementById('init_bl').value;
        
        localStorage.setItem('ICE_V15', JSON.stringify(DATA));
    }

    function loadData() {
        const str = localStorage.getItem('ICE_V15');
        if(str) {
            DATA = JSON.parse(str);
            document.getElementById('setup_date').value = DATA.date;
            document.getElementById('time_start').value = DATA.times.start;
            document.getElementById('time_stop').value = DATA.times.stop;
            document.getElementById('init_hl').value = DATA.initStock.hl;
            document.getElementById('init_bh').value = DATA.initStock.bh;
            document.getElementById('init_bl').value = DATA.initStock.bl;
        } else {
            document.getElementById('setup_date').value = new Date().toISOString().split('T')[0];
        }
    }
</script>
</body>
</html>
