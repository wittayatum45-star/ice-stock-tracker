<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Ice V22 (Separated Logic)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Global Theme --- */
        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 0; background: #eceff1; color: #37474f; padding-bottom: 100px; font-size: 14px; }
        * { box-sizing: border-box; }

        /* --- Sticky Dashboard --- */
        .dashboard {
            position: sticky; top: 0; z-index: 1000;
            background: #263238; color: white;
            padding: 15px 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;
            text-align: center;
        }
        .dash-item span { font-size: 0.8rem; color: #b0bec5; display: block; margin-bottom: 2px; }
        .dash-item div { font-size: 1.4rem; font-weight: bold; color: #69f0ae; line-height: 1; }
        /* ‡πÅ‡∏¢‡∏Å‡∏™‡∏µ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
        .txt-tube { color: #69f0ae !important; }
        .txt-coarse { color: #ffab40 !important; }
        .txt-fine { color: #40c4ff !important; }

        /* --- Navigation --- */
        .nav-bar { display: flex; background: white; border-bottom: 1px solid #cfd8dc; position: sticky; top: 70px; z-index: 900; }
        .nav-btn { flex: 1; padding: 12px; text-align: center; border: none; background: none; font-weight: bold; color: #78909c; cursor: pointer; transition: 0.2s; }
        .nav-btn.active { color: #0277bd; border-bottom: 3px solid #0277bd; background: #e1f5fe; }

        /* --- Pages --- */
        .page { display: none; padding: 10px; max-width: 800px; margin: 0 auto; }
        .page.active { display: block; }

        /* --- Components --- */
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h3, h4 { margin: 0 0 10px 0; color: #455a64; }

        input[type="number"], input[type="time"], input[type="date"] {
            width: 100%; padding: 10px; font-size: 1.1rem; text-align: center;
            border: 1px solid #cfd8dc; border-radius: 8px; background: #fafafa;
            -moz-appearance: textfield;
        }
        input:focus { background: #fff8e1; border-color: #ffa000; outline: none; }

        /* --- Page 2: Production & Stock Cards --- */
        /* Production Card (Green Theme) */
        .card-prod { border-left: 6px solid #00e676; }
        .card-prod .type-badge { background: #e8f5e9; color: #2e7d32; }

        /* Stock Card (Orange Theme) */
        .card-stock { border-left: 6px solid #ff9100; }
        .card-stock .type-badge { background: #fff3e0; color: #ef6c00; }
        .card-stock .sack-calc-row { display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö‡∏ñ‡πâ‡∏≤‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å */
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-time { font-size: 1.2rem; font-weight: bold; background: none; border: none; width: auto; padding: 0; text-align: left; }
        .type-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }

        .sack-calc-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; background: #f1f8e9; padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center; }
        .sack-calc-item label { font-size: 0.7rem; color: #558b2f; display: block; }
        .sack-calc-item div { font-weight: bold; font-size: 1.2rem; }

        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        /* Dist Item */
        .dist-list { margin-top: 15px; border-top: 1px dashed #cfd8dc; padding-top: 10px; }
        .dist-item { background: #f5f5f5; border-radius: 8px; padding: 10px; margin-bottom: 8px; position: relative; }
        .dist-row { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
        
        .btn-del-card { background: #ffcdd2; color: #c62828; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; margin-left: auto; }
        .btn-add-dist { width: 100%; padding: 10px; background: #eceff1; border: 1px dashed #90a4ae; border-radius: 8px; color: #546e7a; font-weight: bold; margin-top: 5px; }

        /* --- Floating Action Button & Menu (UX Upgrade) --- */
        .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .fab-main { width: 65px; height: 65px; border-radius: 50%; background: #263238; color: white; border: none; font-size: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; justify-content: center; }
        .fab-main.rotate { transform: rotate(45deg); background: #ef5350; }
        
        .fab-menu { display: none; flex-direction: column; gap: 10px; align-items: flex-end; }
        .fab-menu.show { display: flex; }
        
        .fab-btn { display: flex; align-items: center; gap: 10px; border: none; background: none; cursor: pointer; }
        .fab-btn span { background: white; padding: 5px 10px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-weight: bold; color: #455a64; font-size: 0.9rem; }
        .fab-icon { width: 50px; height: 50px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 3px 8px rgba(0,0,0,0.3); }
        
        .bg-green { background: #00e676; color: #004d40; }
        .bg-orange { background: #ff9100; color: #3e2723; }

        /* Report Table */
        .truck-report-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        .truck-report-table th { background: #37474f; color: white; padding: 8px; text-align: center; }
        .truck-report-table td { border-bottom: 1px solid #eee; padding: 8px; text-align: center; }
        .val-missing { color: #d32f2f; font-weight: bold; }
        .val-ok { color: #388e3c; font-weight: bold; }

    </style>
</head>
<body>

    <div class="dashboard">
        <div class="dash-item">
            <span>üßä ‡∏´‡∏•‡∏≠‡∏î</span>
            <div id="dash_hl" class="txt-tube">0</div>
        </div>
        <div class="dash-item">
            <span>üî® ‡∏´‡∏¢‡∏≤‡∏ö</span>
            <div id="dash_bh" class="txt-coarse">0</div>
        </div>
        <div class="dash-item">
            <span>‚ùÑÔ∏è ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
            <div id="dash_bl" class="txt-fine">0</div>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchPage('setup')">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        <button class="nav-btn" onclick="switchPage('production')">2. ‡∏ú‡∏•‡∏¥‡∏ï/‡∏à‡πà‡∏≤‡∏¢</button>
        <button class="nav-btn" onclick="switchPage('summary')">3. ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button>
    </div>

    <div id="page-setup" class="page active">
        <div class="card">
            <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="setup_date" onchange="saveData()">
            <div class="grid-2" style="margin-top:10px;">
                <div><label>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="time" id="time_start" value="22:00" onchange="saveData()"></div>
                <div><label>‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="time" id="time_stop" value="06:00" onchange="saveData()"></div>
            </div>
        </div>
        <div class="card">
            <h3>üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ (‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á)</h3>
            <div class="grid-3">
                <div><label>‡∏´‡∏•‡∏≠‡∏î</label><input type="number" id="init_hl" value="0" oninput="saveData(); calcAll();" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                <div><label>‡∏´‡∏¢‡∏≤‡∏ö</label><input type="number" id="init_bh" value="0" oninput="saveData(); calcAll();" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                <div><label>‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><input type="number" id="init_bl" value="0" oninput="saveData(); calcAll();" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
            </div>
        </div>
        <div class="card">
            <h3>üöö ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Master Order)</h3>
            <div id="order_inputs"></div>
        </div>
    </div>

    <div id="page-production" class="page">
        <div id="drops_list"></div>
        <div style="height: 100px;"></div> </div>

    <div class="fab-container">
        <div class="fab-menu" id="fab_menu">
            <button class="fab-btn" onclick="addDrop('stock')">
                <span>‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏¢‡πá‡∏ô (‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤)</span>
                <div class="fab-icon bg-orange">üì¶</div>
            </button>
            <button class="fab-btn" onclick="addDrop('prod')">
                <span>‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ï‡∏Å (‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà)</span>
                <div class="fab-icon bg-green">‚ùÑÔ∏è</div>
            </button>
        </div>
        <button class="fab-main" onclick="toggleFab(this)">+</button>
    </div>

    <div id="page-summary" class="page">
        <div class="card">
            <h4>üè≠ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ú‡∏•‡∏¥‡∏ï (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏Å)</h4>
            <div class="grid-3" style="text-align:center; margin-bottom:10px;">
                <div><small>‡∏´‡∏•‡∏≠‡∏î</small><div id="rpt_hl" style="font-weight:bold; color:#2e7d32;">0</div></div>
                <div><small>‡∏´‡∏¢‡∏≤‡∏ö</small><div id="rpt_bh" style="font-weight:bold; color:#ef6c00;">0</div></div>
                <div><small>‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</small><div id="rpt_bl" style="font-weight:bold; color:#0277bd;">0</div></div>
            </div>
            
            <hr style="border: 0; border-top: 1px dashed #ddd; margin: 10px 0;">
            
            <h4>üì• ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</h4>
            <div class="grid-3" style="text-align:center;">
                <div><small>‡πÄ‡∏ö‡∏¥‡∏Å‡∏°‡∏≤</small><div id="rpt_sack_withdraw">0</div></div>
                <div><small>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</small><div id="rpt_sack_used">0</div></div>
                <div><small class="val-missing">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∑‡∏ô</small><div id="rpt_sack_remain" class="val-missing">0</div></div>
            </div>
        </div>

        <div class="card">
            <h4>üöö ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå)</h4>
            <div id="truck_report_container"></div>
        </div>
    </div>

<script>
    // --- CONFIG ---
    const TRUCKS = ["‡∏£‡∏ñ 1", "‡∏£‡∏ñ 2", "‡∏£‡∏ñ 3", "‡∏£‡∏ñ 4", "‡∏£‡∏ñ 5", "‡∏£‡∏ñ 6", "‡∏£‡∏ñ 7", "‡∏£‡∏ñ 8", "‡∏£‡∏ñ 9"];
    const ICE_TYPES = [
        { id: 'hl', label: '‡∏´‡∏•‡∏≠‡∏î' }, { id: 'bh', label: '‡∏´‡∏¢‡∏≤‡∏ö' }, { id: 'bl', label: '‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' }
    ];
    // --- STATE ---
    let DATA = {
        date: new Date().toISOString().split('T')[0],
        times: { start: "22:00", stop: "06:00" },
        initStock: { hl: 0, bh: 0, bl: 0 },
        orders: {}, 
        drops: [] 
    };

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        renderOrderInputs();
        renderDrops();
        calcAll();
    });

    // --- UX: FAB MENU ---
    function toggleFab(btn) {
        document.getElementById('fab_menu').classList.toggle('show');
        btn.classList.toggle('rotate');
    }

    // --- CORE LOGIC ---
    function addDrop(type) {
        // type = 'prod' (‡∏ú‡∏•‡∏¥‡∏ï) or 'stock' (‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏¢‡πá‡∏ô)
        const now = new Date();
        const timeStr = now.toTimeString().substring(0, 5);
        
        DATA.drops.push({
            id: Date.now(),
            type: type, // ‡∏à‡∏≥‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            time: timeStr,
            sackWithdraw: type === 'prod' ? 80 : 0, // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
            p: { hl: 0, bh: 0, bl: 0 }, // ‡∏ú‡∏•‡∏¥‡∏ï
            dist: [] // ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á
        });
        
        saveData();
        renderDrops();
        toggleFab(document.querySelector('.fab-main')); // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
        setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
    }

    function deleteDrop(id) {
        if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
            DATA.drops = DATA.drops.filter(d => d.id !== id);
            saveData();
            renderDrops();
            calcAll();
        }
    }

    // --- RENDER DROPS ---
    function renderDrops() {
        const container = document.getElementById('drops_list');
        container.innerHTML = '';

        DATA.drops.forEach((d, idx) => {
            const isProd = d.type === 'prod';
            const cardClass = isProd ? 'card-prod' : 'card-stock';
            const typeLabel = isProd ? '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ï‡∏Å (‡∏ú‡∏•‡∏¥‡∏ï)' : '‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏¢‡πá‡∏ô (Stock)';
            
            // Production Calculation (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ö‡∏ö‡∏ú‡∏•‡∏¥‡∏ï)
            const totalProd = (d.p.hl||0) + (d.p.bh||0) + (d.p.bl||0);
            const sackRemain = (d.sackWithdraw||0) - totalProd;
            
            // Inputs HTML for Production (Hidden if Stock mode)
            let productionHTML = '';
            if(isProd) {
                productionHTML = `
                <div class="sack-calc-row">
                    <div class="sack-calc-item"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</label><input type="number" value="${d.sackWithdraw}" oninput="updateDropValue(${d.id}, 'sackWithdraw', null, this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="padding:5px;"></div>
                    <div class="sack-calc-item"><label>‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏î‡πâ</label><div style="margin-top:5px;" id="prod_total_${d.id}">${totalProd}</div></div>
                    <div class="sack-calc-item"><label>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∑‡∏ô</label><div class="${sackRemain<0?'val-missing':'val-ok'}" style="margin-top:5px;" id="sack_remain_${d.id}">${sackRemain}</div></div>
                </div>
                <div class="grid-3">
                    <div><label style="font-size:0.7rem; color:#2e7d32">‡∏´‡∏•‡∏≠‡∏î</label><input type="number" value="${d.p.hl||''}" placeholder="0" oninput="updateDropValue(${d.id}, 'p', 'hl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                    <div><label style="font-size:0.7rem; color:#ef6c00">‡∏´‡∏¢‡∏≤‡∏ö</label><input type="number" value="${d.p.bh||''}" placeholder="0" oninput="updateDropValue(${d.id}, 'p', 'bh', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                    <div><label style="font-size:0.7rem; color:#0277bd">‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><input type="number" value="${d.p.bl||''}" placeholder="0" oninput="updateDropValue(${d.id}, 'p', 'bl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                </div>
                `;
            }

            // Distribution List HTML
            let distHtml = '';
            d.dist.forEach((item, dIdx) => {
                distHtml += `
                <div class="dist-item">
                    <div class="dist-row">
                        <select onchange="updateDist(${d.id}, ${dIdx}, 'truck', this.value); renderDrops();" style="flex:1; padding:8px; border-radius:4px;">
                            ${TRUCKS.map((t,i) => `<option value="t${i+1}" ${item.truck===`t${i+1}`?'selected':''}>${t}</option>`).join('')}
                        </select>
                        <select onchange="updateDist(${d.id}, ${dIdx}, 'type', this.value); renderDrops();" style="width:80px; padding:8px; border-radius:4px;">
                            ${ICE_TYPES.map(t => `<option value="${t.id}" ${item.type===t.id?'selected':''}>${t.label}</option>`).join('')}
                        </select>
                        <button class="btn-del-card" onclick="removeDistRow(${d.id}, ${dIdx})">‡∏•‡∏ö</button>
                    </div>
                    <div class="grid-2">
                        ${isProd ? `<div><input type="number" class="input-fresh" value="${item.fresh||''}" placeholder="‡∏™‡∏î" oninput="updateDist(${d.id}, ${dIdx}, 'fresh', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="background:#e8f5e9; border:1px solid #a5d6a7;"></div>` : ''}
                        
                        <div><input type="number" class="input-stock" value="${item.stock||''}" placeholder="‡∏™‡∏ï‡πá‡∏≠‡∏Å" oninput="updateDist(${d.id}, ${dIdx}, 'stock', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="background:#e1f5fe; border:1px solid #81d4fa;"></div>
                    </div>
                </div>`;
            });

            // Main Card HTML
            const html = `
            <div class="card ${cardClass}">
                <div class="card-header">
                    <div>
                        <div class="type-badge">${typeLabel}</div>
                    </div>
                    <input type="time" class="card-time" value="${d.time}" onchange="updateDropTime(${d.id}, this.value)">
                    <button class="btn-del-card" onclick="deleteDrop(${d.id})">‚ùå</button>
                </div>
                
                ${productionHTML}

                <div class="dist-list">
                    <div style="font-size:0.8rem; font-weight:bold; margin-bottom:5px; color:#78909c;">‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ñ (‡∏™‡∏î / ‡∏™‡∏ï‡πá‡∏≠‡∏Å)</div>
                    ${distHtml}
                    <button class="btn-add-dist" onclick="addDistRow(${d.id})">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</button>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- DISTRIBUTION LOGIC ---
    function addDistRow(dropId) {
        const drop = DATA.drops.find(d => d.id === dropId);
        if(drop) {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Prod ‡πÉ‡∏´‡πâ default ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Stock ‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡πâ‡∏ô‡πÉ‡∏™‡πà‡∏ä‡πà‡∏≠‡∏á Stock
            drop.dist.push({ truck: "t1", type: "hl", fresh: 0, stock: 0 });
            saveData();
            renderDrops();
        }
    }
    function removeDistRow(dropId, idx) {
        const drop = DATA.drops.find(d => d.id === dropId);
        if(drop) { drop.dist.splice(idx, 1); saveData(); renderDrops(); calcAll(); }
    }
    function updateDist(dropId, idx, field, val) {
        const drop = DATA.drops.find(d => d.id === dropId);
        if(drop && drop.dist[idx]) {
            if(field==='fresh' || field==='stock') val = parseFloat(val) || 0;
            drop.dist[idx][field] = val;
            saveData(); calcAll();
        }
    }

    // --- CALCULATION ENGINE (Fixing the mixed types bug) ---
    function calcAll() {
        let totals = {
            prod: { hl:0, bh:0, bl:0 },
            sack: { w:0, u:0 }
        };

        // 1. ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏ú‡∏•‡∏¥‡∏ï (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ drop ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô type='prod')
        DATA.drops.forEach(d => {
            if(d.type === 'prod') {
                totals.prod.hl += (d.p.hl || 0);
                totals.prod.bh += (d.p.bh || 0);
                totals.prod.bl += (d.p.bl || 0);
                
                let pTotal = (d.p.hl||0) + (d.p.bh||0) + (d.p.bl||0);
                totals.sack.w += (d.sackWithdraw || 0);
                totals.sack.u += pTotal;
            }
        });

        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÅ‡∏¢‡∏Å ‡∏´‡∏¢‡∏≤‡∏ö/‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô!)
        let initHL = parseFloat(document.getElementById('init_hl').value) || 0;
        let initBH = parseFloat(document.getElementById('init_bh').value) || 0;
        let initBL = parseFloat(document.getElementById('init_bl').value) || 0;

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ
        let currentHL = initHL + totals.prod.hl;
        let currentBH = initBH + totals.prod.bh;
        let currentBL = initBL + totals.prod.bl;

        // ‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢ (Loop ‡∏ó‡∏∏‡∏Å Drops ‡∏ó‡∏±‡πâ‡∏á Prod ‡πÅ‡∏•‡∏∞ Stock)
        DATA.drops.forEach(d => {
            d.dist.forEach(item => {
                let amount = (item.fresh || 0) + (item.stock || 0);
                if(item.type === 'hl') currentHL -= amount;
                else if(item.type === 'bh') currentBH -= amount; // ‡∏´‡∏¢‡∏≤‡∏ö‡∏ï‡∏±‡∏î‡∏´‡∏¢‡∏≤‡∏ö
                else if(item.type === 'bl') currentBL -= amount; // ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏±‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            });
        });

        // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤ Dashboard
        document.getElementById('dash_hl').innerText = currentHL;
        document.getElementById('dash_bh').innerText = currentBH;
        document.getElementById('dash_bl').innerText = currentBL;

        // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Report
        document.getElementById('rpt_hl').innerText = totals.prod.hl;
        document.getElementById('rpt_bh').innerText = totals.prod.bh;
        document.getElementById('rpt_bl').innerText = totals.prod.bl;

        document.getElementById('rpt_sack_withdraw').innerText = totals.sack.w;
        document.getElementById('rpt_sack_used').innerText = totals.sack.u;
        document.getElementById('rpt_sack_remain').innerText = totals.sack.w - totals.sack.u;

        renderTruckSummary();
    }

    function renderTruckSummary() {
        // ... (Logic ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡πÅ‡∏õ‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Code ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)
        const container = document.getElementById('truck_report_container');
        let truckTotals = {}; 
        TRUCKS.forEach((t, i) => { truckTotals[`t${i+1}`] = { hl:0, bh:0, bl:0 }; });

        DATA.drops.forEach(d => {
            d.dist.forEach(item => {
                if(truckTotals[item.truck]) {
                    truckTotals[item.truck][item.type] += (item.fresh + item.stock);
                }
            });
        });

        let html = `<table class="truck-report-table"><thead><tr><th>‡∏£‡∏ñ</th><th>‡∏ä‡∏ô‡∏¥‡∏î</th><th>‡∏™‡∏±‡πà‡∏á</th><th>‡∏™‡πà‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody>`;
        TRUCKS.forEach((t, i) => {
            const tid = `t${i+1}`;
            ICE_TYPES.forEach(type => {
                const order = DATA.orders[`${tid}_${type.id}`] || 0;
                const sent = truckTotals[tid][type.id];
                if(order > 0 || sent > 0) {
                    const diff = sent - order;
                    let stat = diff===0 ? '<span class="val-ok">‡∏Ñ‡∏£‡∏ö</span>' : (diff>0?`+${diff}`:`<span class="val-missing">${diff}</span>`);
                    html += `<tr><td>${t}</td><td>${type.label}</td><td>${order}</td><td>${sent}</td><td>${stat}</td></tr>`;
                }
            });
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    // --- UTILS ---
    function renderOrderInputs() {
        const container = document.getElementById('order_inputs');
        let html = '<div style="display:grid; gap:5px;">';
        TRUCKS.forEach((t, i) => {
            const tid = `t${i+1}`;
            html += `<div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px; align-items:center; background:#f9f9f9; padding:5px; border-radius:4px;">
                <div style="font-weight:bold; font-size:0.8rem;">${t}</div>
                <input type="number" placeholder="‡∏´‡∏•‡∏≠‡∏î" value="${DATA.orders[tid+'_hl']||''}" onchange="updateOrder('${tid}_hl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)">
                <input type="number" placeholder="‡∏´‡∏¢‡∏≤‡∏ö" value="${DATA.orders[tid+'_bh']||''}" onchange="updateOrder('${tid}_bh', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)">
                <input type="number" placeholder="‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" value="${DATA.orders[tid+'_bl']||''}" onchange="updateOrder('${tid}_bl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)">
            </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    }
    
    function updateOrder(k, v) { DATA.orders[k] = parseFloat(v)||0; saveData(); calcAll(); }
    function updateDropValue(id, t, k, v) { 
        const d = DATA.drops.find(x=>x.id===id); 
        if(d) { 
            if(t==='p') d.p[k]=parseFloat(v)||0; 
            else d[t]=parseFloat(v)||0; 
            saveData(); renderDrops(); calcAll(); 
        } 
    }
    function updateDropTime(id, v) { const d=DATA.drops.find(x=>x.id===id); if(d){ d.time=v; saveData(); } }

    function switchPage(pid) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('page-'+pid).classList.add('active');
        // Simple nav logic
        const map = { setup:0, production:1, summary:2 };
        document.querySelectorAll('.nav-btn')[map[pid]].classList.add('active');
        if(pid === 'summary') calcAll();
    }
    
    function clearZero(el) { if(el.value=='0') el.value=''; }
    function fillZero(el) { if(el.value=='') el.value='0'; }

    function saveData() {
        const dateEl = document.getElementById('setup_date');
        if(dateEl) DATA.date = dateEl.value;
        DATA.times.start = document.getElementById('time_start').value;
        DATA.times.stop = document.getElementById('time_stop').value;
        DATA.initStock.hl = parseFloat(document.getElementById('init_hl').value)||0;
        DATA.initStock.bh = parseFloat(document.getElementById('init_bh').value)||0;
        DATA.initStock.bl = parseFloat(document.getElementById('init_bl').value)||0;
        localStorage.setItem('ICE_V22', JSON.stringify(DATA));
    }

    function loadData() {
        const d = localStorage.getItem('ICE_V22');
        if(d) {
            DATA = JSON.parse(d);
            // Patch for old data compatibility
            if(!DATA.drops) DATA.drops = [];
            DATA.drops.forEach(dr => { 
                if(!dr.type) dr.type = 'prod'; // Default old data to production
            });
            
            if(document.getElementById('setup_date')) document.getElementById('setup_date').value = DATA.date || new Date().toISOString().split('T')[0];
            document.getElementById('time_start').value = DATA.times.start;
            document.getElementById('time_stop').value = DATA.times.stop;
            document.getElementById('init_hl').value = DATA.initStock.hl;
            document.getElementById('init_bh').value = DATA.initStock.bh;
            document.getElementById('init_bl').value = DATA.initStock.bl;
        } else {
             if(document.getElementById('setup_date')) document.getElementById('setup_date').value = new Date().toISOString().split('T')[0];
        }
    }
</script>
</body>
</html>
