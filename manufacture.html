<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Ice V19 (Fixed)</title>
    <style>
        /* --- Global Theme --- */
        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 0; background: #eceff1; color: #37474f; padding-bottom: 80px; font-size: 14px; }
        * { box-sizing: border-box; }

        /* --- Sticky Dashboard --- */
        .dashboard {
            position: sticky; top: 0; z-index: 1000;
            background: #263238; color: white;
            padding: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex; justify-content: space-around;
        }
        .dash-item span { font-size: 0.8rem; color: #b0bec5; }
        .dash-item div { font-size: 1.2rem; font-weight: bold; color: #69f0ae; }

        /* --- Navigation --- */
        .nav-bar { display: flex; background: white; border-bottom: 1px solid #cfd8dc; position: sticky; top: 60px; z-index: 900; }
        .nav-btn { flex: 1; padding: 12px; text-align: center; border: none; background: none; font-weight: bold; color: #78909c; cursor: pointer; }
        .nav-btn.active { color: #0277bd; border-bottom: 3px solid #0277bd; background: #e1f5fe; }

        /* --- Pages --- */
        .page { display: none; padding: 10px; max-width: 800px; margin: 0 auto; }
        .page.active { display: block; }

        /* --- Components --- */
        .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* Input Styles */
        input[type="number"], input[type="time"], input[type="date"] {
            width: 100%; padding: 8px; font-size: 1.2rem; text-align: center;
            border: 1px solid #cfd8dc; border-radius: 4px; background: #fafafa;
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        input[type="number"]:focus { background: #fff8e1; border-color: #ffa000; outline: none; }

        /* --- Page 2 Styles --- */
        .drop-card { border-left: 5px solid #00e676; margin-bottom: 20px; padding-bottom: 10px; }
        .drop-header { display: flex; justify-content: space-between; align-items: center; background: #e8f5e9; padding: 8px; margin-bottom: 5px; border-radius: 4px; }
        
        .sack-calc-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; background: #fff3e0; padding: 8px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #ffe0b2; text-align: center; }
        .sack-calc-item label { font-size: 0.75rem; color: #e65100; display: block; }
        .sack-calc-item div { font-weight: bold; font-size: 1.1rem; }
        .val-remain { color: #d32f2f; }
        .val-remain.good { color: #2e7d32; }

        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }

        .input-green { background-color: #e8f5e9 !important; border-color: #a5d6a7 !important; }
        .input-yellow { background-color: #fffde7 !important; border-color: #fff59d !important; }
        .input-fresh { background-color: #e8f5e9 !important; border: 1px solid #a5d6a7 !important; }
        .input-stock { background-color: #e1f5fe !important; border: 1px solid #81d4fa !important; }

        /* Truck Status Badges */
        .dist-item { background: #f9f9f9; border: 1px solid #eee; padding: 10px; margin-top: 5px; border-radius: 6px; }
        .dist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        
        .truck-status { font-size: 0.85rem; padding: 3px 8px; border-radius: 12px; color: white; font-weight: bold; display: inline-block; }
        .truck-status.warn { background: #ff9800; } /* ‡∏Ç‡∏≤‡∏î */
        .truck-status.ok { background: #4caf50; } /* ‡∏Ñ‡∏£‡∏ö */
        .truck-status.over { background: #2962ff; } /* ‡πÄ‡∏Å‡∏¥‡∏ô */

        .btn-add { position: fixed; bottom: 20px; right: 20px; background: #00e676; color: #004d40; width: 60px; height: 60px; border-radius: 50%; font-size: 30px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 999; }
        .btn-del { background: #ffcdd2; color: #c62828; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .btn-add-dist { width: 100%; padding: 8px; background: #cfd8dc; border: none; border-radius: 4px; margin-top: 5px; font-weight: bold; color: #455a64; }

        /* --- Page 3 Summary --- */
        .summary-container { background: white; padding: 15px; border-radius: 8px; border: 1px solid #ccc; }
        .sum-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #eee; }
        .sum-label { font-weight: bold; color: #455a64; }
        .sum-val { font-weight: 900; color: #37474f; }
        .sum-total { color: #0d47a1; border-top: 2px solid #eee; margin-top: 5px; padding-top: 5px; }
        .sum-blue { color: #0277bd; }
        .divider { margin: 15px 0; border-top: 2px dotted #cfd8dc; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="dash-item"><span>üßä ‡∏´‡∏•‡∏≠‡∏î</span><div id="dash_hl">0</div></div>
        <div class="dash-item"><span>üî® ‡∏´‡∏¢‡∏≤‡∏ö</span><div id="dash_bh">0</div></div>
        <div class="dash-item"><span>‚ùÑÔ∏è ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span><div id="dash_bl">0</div></div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchPage('setup')">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        <button class="nav-btn" onclick="switchPage('production')">2. ‡∏ú‡∏•‡∏¥‡∏ï/‡∏à‡πà‡∏≤‡∏¢</button>
        <button class="nav-btn" onclick="switchPage('summary')">3. ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button>
    </div>

    <div id="page-setup" class="page active">
        <div class="card">
            <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="setup_date" onchange="saveData()">
            <div class="grid-2" style="margin-top:10px;">
                <div><label>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="time" id="time_start" value="22:00" onchange="saveData()"></div>
                <div><label>‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="time" id="time_stop" value="06:00" onchange="saveData()"></div>
            </div>
        </div>
        <div class="card">
            <h3>üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ (‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á)</h3>
            <div class="grid-3">
                <div><label>‡∏´‡∏•‡∏≠‡∏î</label><input type="number" inputmode="numeric" id="init_hl" value="0" oninput="saveData(); calcAll();" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                <div><label>‡∏´‡∏¢‡∏≤‡∏ö</label><input type="number" inputmode="numeric" id="init_bh" value="0" oninput="saveData(); calcAll();" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                <div><label>‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><input type="number" inputmode="numeric" id="init_bl" value="0" oninput="saveData(); calcAll();" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
            </div>
        </div>
        <div class="card">
            <h3>üöö ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Master Order)</h3>
            <div id="order_inputs"></div>
        </div>
    </div>

    <div id="page-production" class="page">
        <div id="drops_list"></div>
        <div style="height: 80px;"></div>
        <button class="btn-add" onclick="addDrop()">+</button>
    </div>

    <div id="page-summary" class="page">
        <div class="summary-container">
            <h4>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ú‡∏•‡∏¥‡∏ï</h4>
            <div class="sum-row"><span class="sum-label">‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà:</span> <span class="sum-val" id="rpt_hl">0</span></div>
            <div class="sum-row"><span class="sum-label">‡∏ö‡∏î‡∏´‡∏¢‡∏≤‡∏ö:</span> <span class="sum-val" id="rpt_bh">0</span></div>
            <div class="sum-row"><span class="sum-label">‡∏ö‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</span> <span class="sum-val" id="rpt_bl">0</span></div>
            <div class="sum-row sum-total"><span class="sum-label sum-blue">‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏¥‡∏ï:</span> <span class="sum-val sum-blue" id="rpt_total_prod">0</span></div>
            
            <div class="divider"></div>
            <h4>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</h4>
            <div class="sum-row"><span class="sum-label">‡∏ô‡∏ô.‡∏´‡∏•‡∏≠‡∏î (x20):</span> <span class="sum-val" id="rpt_w_hl">0</span></div>
            <div class="sum-row"><span class="sum-label">‡∏ô‡∏ô.‡∏´‡∏¢‡∏≤‡∏ö (x23):</span> <span class="sum-val" id="rpt_w_bh">0</span></div>
            <div class="sum-row"><span class="sum-label">‡∏ô‡∏ô.‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (x24):</span> <span class="sum-val" id="rpt_w_bl">0</span></div>
            <div class="sum-row sum-total"><span class="sum-label sum-blue">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°:</span> <span class="sum-val sum-blue" id="rpt_total_weight">0</span></div>

            <div class="divider"></div>
            <h4>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h4>
            <div class="sum-row"><span class="sum-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span><span class="sum-val" id="rpt_avg_time">0</span> ‡∏ô‡∏≤‡∏ó‡∏µ/‡∏ï‡∏Å</span></div>
            <div class="sum-row"><span class="sum-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï:</span> <span><span class="sum-val" id="rpt_tons">0</span> ‡∏ï‡∏±‡∏ô/‡∏ß‡∏±‡∏ô</span></div>
            <div class="sum-row"><span class="sum-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span><span class="sum-val" id="rpt_avg_qty">0</span> ‡πÉ‡∏ö/‡∏ï‡∏Å</span></div>

            <div class="divider"></div>
            <h4>‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö‡πÄ‡∏õ‡∏•‡πà‡∏≤</h4>
            <div class="sum-row"><span class="sum-label">‡πÄ‡∏ö‡∏¥‡∏Å‡∏°‡∏≤:</span> <span class="sum-val" id="rpt_sack_withdraw">0</span></div>
            <div class="sum-row"><span class="sum-label">‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á:</span> <span class="sum-val" id="rpt_sack_used">0</span></div>
            <div class="sum-row" style="color:#d32f2f; border-top:2px solid #eee; margin-top:5px; padding-top:5px;"><span class="sum-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span> <span class="sum-val" id="rpt_sack_remain">0</span></div>
        </div>
    </div>

<script>
    const TRUCKS = ["‡∏£‡∏ñ 1", "‡∏£‡∏ñ 2", "‡∏£‡∏ñ 3", "‡∏£‡∏ñ 4", "‡∏£‡∏ñ 5", "‡∏£‡∏ñ 6", "‡∏£‡∏ñ 7", "‡∏£‡∏ñ 8", "‡∏£‡∏ñ 9"];
    const ICE_TYPES = [
        { id: 'hl', label: '‡∏´‡∏•‡∏≠‡∏î' }, { id: 'bh', label: '‡∏´‡∏¢‡∏≤‡∏ö' }, { id: 'bl', label: '‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' }
    ];
    const WEIGHTS = { hl: 20, bh: 23, bl: 24 };

    let DATA = {
        date: new Date().toISOString().split('T')[0],
        times: { start: "22:00", stop: "06:00" },
        initStock: { hl: 0, bh: 0, bl: 0 },
        orders: {}, 
        drops: [] 
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        renderOrderInputs();
        renderDrops();
        calcAll();
    });

    function addDrop() {
        const now = new Date();
        const timeStr = now.toTimeString().substring(0, 5);
        DATA.drops.push({
            id: Date.now(),
            time: timeStr,
            sackWithdraw: 80,
            p: { hl: 0, bh: 0, bl: 0 },
            dist: [] 
        });
        saveData();
        renderDrops();
        setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
    }

    function deleteDrop(id) {
        if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) {
            DATA.drops = DATA.drops.filter(d => d.id !== id);
            saveData();
            renderDrops();
            calcAll();
        }
    }

    function addDistRow(dropId) {
        const drop = DATA.drops.find(d => d.id === dropId);
        if(drop) {
            drop.dist.push({ truck: "t1", type: "hl", fresh: 0, stock: 0 });
            saveData();
            renderDrops();
        }
    }

    function removeDistRow(dropId, idx) {
        const drop = DATA.drops.find(d => d.id === dropId);
        if(drop) {
            drop.dist.splice(idx, 1);
            saveData();
            renderDrops();
            calcAll();
        }
    }

    function getTruckStatusHTML(truckId, typeId) {
        const orderKey = `${truckId}_${typeId}`;
        const orderQty = DATA.orders[orderKey] || 0;
        if (orderQty === 0) return `<span class="truck-status" style="background:#9e9e9e">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏±‡πà‡∏á</span>`;

        let totalGiven = 0;
        DATA.drops.forEach(d => {
            d.dist.forEach(item => {
                if(item.truck === truckId && item.type === typeId) {
                    totalGiven += (item.fresh + item.stock);
                }
            });
        });

        const remaining = orderQty - totalGiven;
        let statusClass = 'warn';
        let statusText = `‡∏Ç‡∏≤‡∏î ${remaining}`;

        if (remaining === 0) {
            statusClass = 'ok';
            statusText = '‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
        } else if (remaining < 0) {
            statusClass = 'over';
            statusText = `‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(remaining)}`;
        }

        return `<span class="truck-status ${statusClass}">‡∏™‡∏±‡πà‡∏á: ${orderQty} | ${statusText}</span>`;
    }

    function renderOrderInputs() {
        const container = document.getElementById('order_inputs');
        let html = '<table style="width:100%; font-size:0.9rem;"><tr><th>‡∏£‡∏ñ</th><th>‡∏´‡∏•‡∏≠‡∏î</th><th>‡∏´‡∏¢‡∏≤‡∏ö</th><th>‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr>';
        TRUCKS.forEach((t, i) => {
            const tid = `t${i+1}`;
            html += `<tr>
                <td>${t}</td>
                <td><input type="number" inputmode="numeric" value="${DATA.orders[tid+'_hl']||''}" onchange="updateOrder('${tid}_hl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="padding:5px;"></td>
                <td><input type="number" inputmode="numeric" value="${DATA.orders[tid+'_bh']||''}" onchange="updateOrder('${tid}_bh', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="padding:5px;"></td>
                <td><input type="number" inputmode="numeric" value="${DATA.orders[tid+'_bl']||''}" onchange="updateOrder('${tid}_bl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="padding:5px;"></td>
            </tr>`;
        });
        html += '</table>';
        container.innerHTML = html;
    }

    function renderDrops() {
        const container = document.getElementById('drops_list');
        container.innerHTML = '';

        DATA.drops.forEach((d, idx) => {
            const totalProd = (d.p.hl||0) + (d.p.bh||0) + (d.p.bl||0);
            const sackRemain = (d.sackWithdraw||0) - totalProd;
            const sackClass = sackRemain < 0 ? 'val-remain' : 'val-remain good';

            let distHtml = '';
            d.dist.forEach((item, dIdx) => {
                distHtml += `
                <div class="dist-item">
                    <div class="dist-header">
                        <div style="flex:1; display:flex; gap:5px; align-items:center;">
                            <select onchange="updateDist(${d.id}, ${dIdx}, 'truck', this.value); renderDrops();" style="width:auto; font-weight:bold;">
                                ${TRUCKS.map((t,i) => `<option value="t${i+1}" ${item.truck===`t${i+1}`?'selected':''}>${t}</option>`).join('')}
                            </select>
                            <select onchange="updateDist(${d.id}, ${dIdx}, 'type', this.value); renderDrops();" style="width:auto;">
                                ${ICE_TYPES.map(t => `<option value="${t.id}" ${item.type===t.id?'selected':''}>${t.label}</option>`).join('')}
                            </select>
                        </div>
                        <button style="background:none; border:none; color:red;" onclick="removeDistRow(${d.id}, ${dIdx})">‚úñ</button>
                    </div>
                    <div style="margin-bottom:5px;">${getTruckStatusHTML(item.truck, item.type)}</div>
                    <div class="grid-2">
                        <div><label style="font-size:0.75rem; color:#2e7d32;">üî• ‡∏™‡∏î</label><input type="number" inputmode="numeric" class="input-fresh" value="${item.fresh||''}" placeholder="0" oninput="updateDist(${d.id}, ${dIdx}, 'fresh', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                        <div><label style="font-size:0.75rem; color:#0277bd;">‚ùÑÔ∏è ‡πÄ‡∏Å‡πà‡∏≤</label><input type="number" inputmode="numeric" class="input-stock" value="${item.stock||''}" placeholder="0" oninput="updateDist(${d.id}, ${dIdx}, 'stock', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                    </div>
                </div>`;
            });

            const html = `
            <div class="card drop-card" id="card_${d.id}">
                <div class="drop-header">
                    <b>#${idx+1} ‡πÄ‡∏ß‡∏•‡∏≤: <input type="time" value="${d.time}" onchange="updateDropTime(${d.id}, this.value)" style="width:auto; background:none; border:none; font-weight:bold;"></b>
                    <button class="btn-del" onclick="deleteDrop(${d.id})">‡∏•‡∏ö</button>
                </div>
                <div class="sack-calc-row">
                    <div class="sack-calc-item"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</label><input type="number" inputmode="numeric" value="${d.sackWithdraw}" oninput="updateDropValue(${d.id}, 'sackWithdraw', null, this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="width:100%; padding:2px; font-size:1rem;"></div>
                    <div class="sack-calc-item"><label>‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏î‡πâ</label><div style="margin-top:5px;" id="prod_total_${d.id}">${totalProd}</div></div>
                    <div class="sack-calc-item"><label>‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label><div class="${sackClass}" style="margin-top:5px;" id="sack_remain_${d.id}">${sackRemain}</div></div>
                </div>
                <div class="grid-3">
                    <input type="number" inputmode="numeric" class="input-green" placeholder="‡∏´‡∏•‡∏≠‡∏î" value="${d.p.hl||''}" oninput="updateDropValue(${d.id}, 'p', 'hl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)">
                    <input type="number" inputmode="numeric" class="input-green" placeholder="‡∏´‡∏¢‡∏≤‡∏ö" value="${d.p.bh||''}" oninput="updateDropValue(${d.id}, 'p', 'bh', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)">
                    <input type="number" inputmode="numeric" class="input-green" placeholder="‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" value="${d.p.bl||''}" oninput="updateDropValue(${d.id}, 'p', 'bl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)">
                </div>
                <div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:5px;">
                    ${distHtml}
                    <button class="btn-add-dist" onclick="addDistRow(${d.id})">+ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ñ</button>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- OPTIMIZED UPDATERS (No Re-render) ---
    function updateOrder(key, val) {
        DATA.orders[key] = parseFloat(val) || 0;
        saveData();
    }

    function updateDropTime(id, val) {
        const drop = DATA.drops.find(d => d.id === id);
        if (drop) {
            drop.time = val;
            saveData();
        }
    }

    function updateDropValue(id, type, key, val) {
        const drop = DATA.drops.find(d => d.id === id);
        if(!drop) return;
        
        const numVal = parseFloat(val) || 0;

        if(type === 'p') drop.p[key] = numVal;
        else if(type === 'sackWithdraw') drop.sackWithdraw = numVal;

        saveData();
        
        // üî• Key Fix: Update only specific DOM elements, DO NOT re-render whole list! üî•
        const totalProd = (drop.p.hl||0) + (drop.p.bh||0) + (drop.p.bl||0);
        const sackRemain = (drop.sackWithdraw||0) - totalProd;
        
        const prodEl = document.getElementById(`prod_total_${id}`);
        const remainEl = document.getElementById(`sack_remain_${id}`);
        
        if(prodEl) prodEl.innerText = totalProd;
        if(remainEl) {
            remainEl.innerText = sackRemain;
            remainEl.className = sackRemain < 0 ? 'val-remain' : 'val-remain good';
        }

        calcAll(); // Update dashboard/summary in background
    }

    function updateDist(dropId, distIdx, field, val) {
        const drop = DATA.drops.find(d => d.id === dropId);
        if(!drop || !drop.dist[distIdx]) return;
        
        if(field === 'fresh' || field === 'stock') val = parseFloat(val) || 0;
        drop.dist[distIdx][field] = val;
        
        saveData();
        // For distribution, re-rendering logic is complex due to status badges.
        // But user issue was mostly about input focus.
        // We can keep simple update here or re-render if truck dropdown changes.
        // If input (fresh/stock) changes, NO re-render needed for UI, just Calc.
        calcAll();
    }

    function calcAll() {
        let sumP = { hl:0, bh:0, bl:0 };
        let sumSack = { withdraw: 0 };
        
        DATA.drops.forEach(d => {
            sumP.hl += d.p.hl; sumP.bh += d.p.bh; sumP.bl += d.p.bl;
            sumSack.withdraw += (d.sackWithdraw || 0);
        });

        let curHL = (parseFloat(document.getElementById('init_hl').value)||0) + sumP.hl;
        let curCrush = (parseFloat(document.getElementById('init_bh').value)||0) + (parseFloat(document.getElementById('init_bl').value)||0) + sumP.bh + sumP.bl;
        
        DATA.drops.forEach(d => {
            d.dist.forEach(item => {
                if(item.type === 'hl') curHL -= (item.fresh + item.stock);
                else curCrush -= (item.fresh + item.stock);
            });
        });

        document.getElementById('dash_hl').textContent = curHL;
        document.getElementById('dash_bh').textContent = (parseFloat(document.getElementById('init_bh').value)||0) + sumP.bh;
        document.getElementById('dash_bl').textContent = (parseFloat(document.getElementById('init_bl').value)||0) + sumP.bl;

        // Report
        setText('rpt_hl', sumP.hl); setText('rpt_bh', sumP.bh); setText('rpt_bl', sumP.bl);
        let totalProd = sumP.hl + sumP.bh + sumP.bl;
        setText('rpt_total_prod', totalProd);

        let wHL = sumP.hl * WEIGHTS.hl;
        let wBH = sumP.bh * WEIGHTS.bh;
        let wBL = sumP.bl * WEIGHTS.bl;
        let totalW = wHL + wBH + wBL;
        setText('rpt_w_hl', wHL); setText('rpt_w_bh', wBH); setText('rpt_w_bl', wBL);
        setText('rpt_total_weight', totalW);

        let start = timeToMins(document.getElementById('time_start').value);
        let stop = timeToMins(document.getElementById('time_stop').value);
        if(stop < start) stop += 1440;
        let mins = stop - start;
        
        let drops = DATA.drops.length;
        setText('rpt_avg_time', drops>0 ? (mins/drops).toFixed(1) : 0);
        setText('rpt_avg_qty', drops>0 ? (totalProd/drops).toFixed(1) : 0);
        let tons = (totalW * 1440 / mins / 1000).toFixed(2);
        if(!isFinite(tons)) tons = 0;
        setText('rpt_tons', tons);

        setText('rpt_sack_withdraw', sumSack.withdraw);
        setText('rpt_sack_used', totalProd);
        setText('rpt_sack_remain', sumSack.withdraw - totalProd);
    }

    function setText(id, val) { document.getElementById(id).textContent = val; }
    function timeToMins(t) { if(!t)return 0; const [h,m]=t.split(':').map(Number); return h*60+m; }
    function switchPage(pid) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('page-'+pid).classList.add('active');
        const btns = document.querySelectorAll('.nav-btn');
        if(pid==='setup') btns[0].classList.add('active');
        if(pid==='production') btns[1].classList.add('active');
        if(pid==='summary') { btns[2].classList.add('active'); calcAll(); }
    }
    function clearZero(el) { if(el.value=='0') el.value=''; }
    function fillZero(el) { if(el.value=='') el.value='0'; }
    function saveData() { 
        DATA.times.start = document.getElementById('time_start').value;
        DATA.times.stop = document.getElementById('time_stop').value;
        localStorage.setItem('ICE_V19', JSON.stringify(DATA)); 
    }
    function loadData() {
        const d = localStorage.getItem('ICE_V19');
        if(d) {
            DATA = JSON.parse(d);
            DATA.drops.forEach(dr => { if(!dr.sackWithdraw) dr.sackWithdraw = 80; });
            document.getElementById('time_start').value = DATA.times.start;
            document.getElementById('time_stop').value = DATA.times.stop;
            document.getElementById('init_hl').value = DATA.initStock.hl;
            document.getElementById('init_bh').value = DATA.initStock.bh;
            document.getElementById('init_bl').value = DATA.initStock.bl;
        }
    }
</script>
</body>
</html>
