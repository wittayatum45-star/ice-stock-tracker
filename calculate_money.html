<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ice Sales Reconciliation (AjarnG)</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 15px; background: #f4f4f9; }
        h1 { color: #007bff; text-align: center; margin-bottom: 25px; font-size: 1.5em; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: white; box-shadow: 0 2px 4px rgba(0 0 0 / 10%); }
        th, td { border: 1px solid #ccc; padding: 6px 4px; text-align: center; font-size: 0.8em; }
        th { background: #e9ecef; font-weight: bold; }
        input[type="number"] { width: 90%; padding: 3px; text-align: right; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box; font-size: 0.9em; }

        .header-group { background: #d0eaff; }
        .data-input input { background: #f9f9c5; } /* ช่องกรอกยอดเบิก/คืน */
        .data-input { background: #f9f9c5; } 
        .calculated { background: #e0f7fa; font-weight: bold; text-align: right; } /* ช่องคำนวณ */
        .total-money { background: #c6e9c6; font-weight: bold; text-align: right; } /* ช่องยอดเงินรวม */
        .cash-box { border: 2px solid #007bff; padding: 10px; margin-bottom: 15px; background: #fff; }
        .final-calc label { display: block; font-weight: bold; margin-top: 8px; }
        .final-calc input, .final-calc span { width: 100%; height: 35px; padding: 5px; box-sizing: border-box; text-align: right; font-weight: bold; font-size: 1em; }
        .final-diff { color: red; }
    </style>
</head>
<body>

    <h1>❄️ ระบบกระทบยอดขายและสต๊อกน้ำแข็ง</h1>
    
    <h2>1. รายการเบิก-คืนและยอดขายสุทธิ</h2>
    <table>
        <thead>
            <tr class="header-group">
                <th>ชนิดน้ำแข็ง</th>
                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th>
                <th>รวมเบิก</th>
                <th>คืนทั้งสิ้น</th>
                <th>คงเหลือสุทธิ</th>
                <th>ยอดที่ขายได้</th>
                <th>แถมบริการ</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>หลอดใหญ่</td>
                <td class="data-input"><input type="number" id="qty_1_hl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_2_hl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_3_hl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_4_hl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_5_hl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_6_hl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="calculated" id="total_out_hl">0</td>
                <td class="data-input"><input type="number" id="returned_hl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="calculated" id="net_remaining_hl">0</td>
                <td class="calculated" id="sold_qty_hl">0</td>
                <td class="data-input"><input type="number" id="free_qty_hl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
            </tr>
            <tr>
                <td>บดหยาบ</td>
                <td class="data-input"><input type="number" id="qty_1_bh" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_2_bh" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_3_bh" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_4_bh" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_5_bh" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_6_bh" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="calculated" id="total_out_bh">0</td>
                <td class="data-input"><input type="number" id="returned_bh" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="calculated" id="net_remaining_bh">0</td>
                <td class="calculated" id="sold_qty_bh">0</td>
                <td class="data-input"><input type="number" id="free_qty_bh" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
            </tr>
            <tr>
                <td>บดละเอียด</td>
                <td class="data-input"><input type="number" id="qty_1_bl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_2_bl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_3_bl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_4_bl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_5_bl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="data-input"><input type="number" id="qty_6_bl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="calculated" id="total_out_bl">0</td>
                <td class="data-input"><input type="number" id="returned_bl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="calculated" id="net_remaining_bl">0</td>
                <td class="calculated" id="sold_qty_bl">0</td>
                <td class="data-input"><input type="number" id="free_qty_bl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
            </tr>
            <tr style="background: #ffffcc;">
                <td colspan="8">รวมทั้งสิ้น</td>
                <td class="calculated" id="total_returned">0</td>
                <td class="calculated" id="grand_net_remaining">0</td>
                <td class="calculated" id="grand_sold_qty">0</td>
                <td></td>
            </tr>
        </tbody>
    </table>

    <hr>

    <h2>2. คำนวณยอดเงิน (บาท)</h2>
    <table>
        <thead>
            <tr class="header-group">
                <th>ชนิดน้ำแข็ง</th>
                <th>ราคากระสอบ</th>
                <th>จำนวนที่ขายได้</th>
                <th>จำนวนเงิน (บาท)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td rowspan="4">หลอดใหญ่</td>
                <td>30</td>
                <td class="data-input"><input type="number" id="price_30_hl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="total-money" id="money_30_hl">0.00</td>
            </tr>
            <tr>
                <td>35</td>
                <td class="data-input"><input type="number" id="price_35_hl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="total-money" id="money_35_hl">0.00</td>
            </tr>
            <tr>
                <td>100/3 (33.33)</td>
                <td class="data-input"><input type="number" id="price_100_hl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="total-money" id="money_100_hl">0.00</td>
            </tr>
            <tr>
                <td>40</td>
                <td class="data-input"><input type="number" id="price_40_hl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="total-money" id="money_40_hl">0.00</td>
            </tr>
            <tr style="background: #fff3cd;">
                <td colspan="3">รวมยอดเงิน หลอดใหญ่</td>
                <td class="total-money" id="sub_total_money_hl">0.00</td>
            </tr>

            <tr>
                <td rowspan="4">บดหยาบ</td>
                <td>30</td>
                <td class="data-input"><input type="number" id="price_30_bh" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="total-money" id="money_30_bh">0.00</td>
            </tr>
            <tr>
                <td>35</td>
                <td class="data-input"><input type="number" id="price_35_bh" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="total-money" id="money_35_bh">0.00</td>
            </tr>
            <tr>
                <td>100/3 (33.33)</td>
                <td class="data-input"><input type="number" id="price_100_bh" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="total-money" id="money_100_bh">0.00</td>
            </tr>
            <tr>
                <td>40</td>
                <td class="data-input"><input type="number" id="price_40_bh" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="total-money" id="money_40_bh">0.00</td>
            </tr>
            <tr style="background: #fff3cd;">
                <td colspan="3">รวมยอดเงิน บดหยาบ</td>
                <td class="total-money" id="sub_total_money_bh">0.00</td>
            </tr>

            <tr>
                <td rowspan="4">บดละเอียด</td>
                <td>30</td>
                <td class="data-input"><input type="number" id="price_30_bl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="total-money" id="money_30_bl">0.00</td>
            </tr>
            <tr>
                <td>35</td>
                <td class="data-input"><input type="number" id="price_35_bl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="total-money" id="money_35_bl">0.00</td>
            </tr>
            <tr>
                <td>100/3 (33.33)</td>
                <td class="data-input"><input type="number" id="price_100_bl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="total-money" id="money_100_bl">0.00</td>
            </tr>
            <tr>
                <td>40</td>
                <td class="data-input"><input type="number" id="price_40_bl" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric"></td>
                <td class="total-money" id="money_40_bl">0.00</td>
            </tr>
            <tr style="background: #fff3cd;">
                <td colspan="3">รวมยอดเงิน บดละเอียด</td>
                <td class="total-money" id="sub_total_money_bl">0.00</td>
            </tr>
            
            <tr style="background: #d4edda;">
                <td colspan="3">ยอดรวมเงินทั้งหมด (Total Sales)</td>
                <td class="total-money" id="grand_total_sales">0.00</td>
            </tr>
        </tbody>
    </table>

    <hr>

    <h2>3. สรุปยอดเงินสุทธิ (หัก/บวก)</h2>
    <div class="cash-box final-calc">
        <label>ยอดรวมเงินก่อนหัก (Total Sales)</label>
        <span class="total-money" id="summary_total_sales">0.00</span>
        
        <label>ยอดหักส่วนลด 4% (4% Off)</label>
        <span class="final-diff" id="discount_amount">0.00</span>

        <label>ยอดค้างรับ (นำไป **ลบ** จากยอดรวม)</label>
        <input type="number" id="debt_in" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric">

        <label>ยอดจ่ายค้าง (นำไป **บวก** กับยอดรวม)</label>
        <input type="number" id="debt_out" value="0" oninput="calculate()" onfocus="clearZero(this)" onblur="setZero(this)" inputmode="numeric">

        <label>ยอดเงินที่ต้องนำส่งสุทธิ (Net Cash Due)</label>
        <span class="total-money" id="net_cash_due" style="background: #b8daff; font-size: 1.2em;">0.00</span>
    </div>

    <script>
        // ชนิดน้ำแข็งและราคา
        const iceTypes = ['hl', 'bh', 'bl'];
        const prices = [30, 35, 40];
        const fractionalPrice = 100 / 3; // 33.33 บาท

        /** จัดรูปแบบเป็นสกุลเงิน (คอมม่า และ ทศนิยม 2 ตำแหน่ง) */
        function formatCurrency(amount) {
            // ใช้ toFixed(2) และ toLocaleString เพื่อให้แสดงผลเป็นรูปแบบสกุลเงินไทย
            return parseFloat(amount).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        /** ดึงค่าตัวเลขจาก Input โดยให้ค่าเริ่มต้นเป็น 0 */
        function getInputValue(id) {
            return parseFloat(document.getElementById(id).value) || 0;
        }

        /** ล้างค่า '0' ทันทีเมื่อช่องถูกคลิก (Focus) */
        function clearZero(inputElement) {
            if (inputElement.value === '0') {
                inputElement.value = ''; 
            }
        }

        /** ใส่ค่า '0' กลับไปเมื่อออกจากช่อง (Blur) หากช่องนั้นว่างเปล่า */
        function setZero(inputElement) {
            if (inputElement.value === '') {
                inputElement.value = '0';
            }
            calculate(); 
        }

        /** ฟังก์ชันหลัก: คำนวณทุกอย่าง */
        function calculate() {
            let grandTotalSales = 0;
            let grandSoldQty = 0;
            let grandReturned = 0;
            let grandNetRemaining = 0;

            // --- ส่วนที่ 1: คำนวณสต๊อกและยอดที่ขายได้ ---
            iceTypes.forEach(type => {
                // คำนวณรวมเบิก
                let totalOut = getInputValue(`qty_1_${type}`) + getInputValue(`qty_2_${type}`) + getInputValue(`qty_3_${type}`) + 
                                getInputValue(`qty_4_${type}`) + getInputValue(`qty_5_${type}`) + getInputValue(`qty_6_${type}`);
                
                // คำนวณคืนทั้งสิ้น
                let returned = getInputValue(`returned_${type}`);
                
                // ** LOGIC ใหม่: คงเหลือสุทธิ = คืนทั้งสิ้น **
                let netRemaining = returned; 
                
                // ** LOGIC ใหม่: ยอดที่ขายได้ = คงเหลือสุทธิ - แถมบริการ **
                let freeQty = getInputValue(`free_qty_${type}`);
                let soldQty = totalOut - returned - freeQty; // ยอดขายจริง (ต้องหักคืนและแถมบริการ)
                
                // อัปเดต UI สต๊อก
                document.getElementById(`total_out_${type}`).textContent = Math.round(totalOut);
                document.getElementById(`net_remaining_${type}`).textContent = Math.round(netRemaining);
                document.getElementById(`sold_qty_${type}`).textContent = Math.round(soldQty);

                // คำนวณยอดรวมใหญ่
                grandSoldQty += soldQty;
                grandReturned += returned;
                grandNetRemaining += netRemaining;
            });
            
            // อัปเดต UI ยอดรวมสต๊อก
            document.getElementById('total_returned').textContent = Math.round(grandReturned);
            document.getElementById('grand_net_remaining').textContent = Math.round(grandNetRemaining);
            document.getElementById('grand_sold_qty').textContent = Math.round(grandSoldQty);


            // --- ส่วนที่ 2: คำนวณยอดเงิน ---
            iceTypes.forEach(type => {
                let subTotalMoney = 0;
                
                // ราคา 30, 35, 40 บาท
                prices.forEach(price => {
                    const qty = getInputValue(`price_${price}_${type}`);
                    const money = qty * price;
                    document.getElementById(`money_${price}_${type}`).textContent = formatCurrency(money);
                    subTotalMoney += money;
                });
                
                // ราคา 100/3 (33.33 บาท)
                const qty100 = getInputValue(`price_100_${type}`);
                const money100 = qty100 * fractionalPrice;
                document.getElementById(`money_100_${type}`).textContent = formatCurrency(money100);
                subTotalMoney += money100;
                
                // อัปเดต UI ยอดรวมเงินของน้ำแข็งชนิดนั้น
                document.getElementById(`sub_total_money_${type}`).textContent = formatCurrency(subTotalMoney);
                grandTotalSales += subTotalMoney;
            });

            // --- ส่วนที่ 3: คำนวณยอดสุทธิ ---
            
            // แสดงยอดรวมเงินทั้งหมด (ก่อนหัก/บวก)
            document.getElementById('grand_total_sales').textContent = formatCurrency(grandTotalSales);
            document.getElementById('summary_total_sales').textContent = formatCurrency(grandTotalSales);
            
            // คำนวณส่วนลด 4%
            const discountRate = 0.04;
            const discountAmount = grandTotalSales * discountRate;
            document.getElementById('discount_amount').textContent = formatCurrency(-discountAmount); // แสดงเป็นยอดลบ

            // ยอดค้าง (หนี้)
            const debtIn = getInputValue('debt_in');
            const debtOut = getInputValue('debt_out');
            
            // สูตร: ยอดรวม - ส่วนลด - ยอดค้าง (รับ) + ยอดจ่ายค้าง (คืน)
            const netCashDue = grandTotalSales - discountAmount - debtIn + debtOut;

            // แสดงยอดเงินที่ต้องนำส่งสุทธิ
            document.getElementById('net_cash_due').textContent = formatCurrency(netCashDue);
            
            // สีของส่วนลด/ยอดสุทธิ (เงินขาด/เกิน)
            if (netCashDue < 0) {
                 document.getElementById('net_cash_due').classList.add('final-diff');
            } else {
                 document.getElementById('net_cash_due').classList.remove('final-diff');
            }
        }

        // เรียกฟังก์ชันคำนวณทันทีที่โหลดหน้าจอ
        document.addEventListener('DOMContentLoaded', calculate);
    </script>
</body>
</html>
