<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Ice V119 (Fixed by AjarnG)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- Theme --- */
        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 0; background: #f5f7fa; color: #37474f; padding-bottom: 100px; font-size: 14px; }
        * { box-sizing: border-box; }
        .dashboard { position: sticky; top: 0; z-index: 1000; background: #263238; color: white; padding: 12px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; justify-content: space-around; }
        .dash-item span { font-size: 0.75rem; color: #b0bec5; display: block; margin-bottom: 2px; }
        .dash-item div { font-size: 1.3rem; font-weight: 800; color: #69f0ae; line-height: 1; }
        .order-status-bar { background: #fff3e0; border-bottom: 1px solid #ffe0b2; padding: 8px; text-align: center; font-size: 0.9rem; color: #ef6c00; font-weight: bold; display: flex; justify-content: space-around; position: sticky; top: 65px; z-index: 950; }
        .nav-bar { display: flex; background: white; margin: 10px; border-radius: 50px; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 105px; z-index: 900; }
        .nav-btn { flex: 1; padding: 10px; text-align: center; border: none; background: none; font-weight: bold; color: #90a4ae; cursor: pointer; border-radius: 40px; transition: 0.2s; }
        .nav-btn.active { background: #0277bd; color: white; box-shadow: 0 2px 8px rgba(2,119,189,0.4); }
        .page { display: none; padding: 10px; max-width: 800px; margin: 0 auto; }
        .page.active { display: block; }
        .modern-card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 20px; overflow: hidden; border: 1px solid #fff; }
        .card-body { padding: 15px; }
        input[type="number"], input[type="tel"] { width: 100%; padding: 12px; font-size: 1.4rem; text-align: center; font-weight: 600; border: 1px solid #e0e0e0; border-radius: 10px; background: #fff; transition: border-color 0.2s; }
        input:focus { border-color: #29b6f6; box-shadow: 0 0 0 3px rgba(41,182,246,0.1); outline: none; background: #fff; }
        input[type="time"], input[type="date"] { width: 100%; padding: 10px; border: 1px solid #cfd8dc; border-radius: 8px; text-align: center; font-size: 1.1rem; background: white; }
        
        .card-header-flex { display: flex; align-items: center; padding: 10px; gap: 10px; background: #f9fafb; border-bottom: 1px solid #eee; }
        .badge-box { border-radius: 12px; padding: 5px; width: 70px; text-align: center; color: white; font-weight: bold; font-size: 0.75rem; display: flex; flex-direction: column; justify-content: center; height: 50px; }
        .bg-prod { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .big-time-input { font-size: 1.8rem; font-weight: 800; color: #37474f; border: none; background: none; width: 100px; text-align: center; }
        .time-diff-badge { font-size: 0.85rem; color: #0277bd; font-weight: bold; background: #e1f5fe; padding: 4px 8px; border-radius: 12px; white-space: nowrap; }
        .btn-close-red { width: 35px; height: 35px; border-radius: 8px; background: #ffebee; color: #c62828; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-left: auto; }
        .sack-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; background: #e0f2f1; padding: 10px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #b2dfdb; }
        .sack-item { text-align: center; }
        .sack-label { font-size: 0.65rem; color: #00695c; font-weight: bold; margin-bottom: 2px; white-space: nowrap; }
        .sack-val { font-size: 1.2rem; font-weight: 800; color: #004d40; }
        .sack-split { font-size: 0.85rem; color: #555; display: flex; justify-content: center; gap: 5px; margin-top: 2px; }
        .ss-hl { color: #2e7d32; font-weight:bold; } .ss-bod { color: #6a1b9a; font-weight:bold; }

        .paper-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 5px; border: 1px solid #546e7a; }
        .paper-table th { background: #cfd8dc; border: 1px solid #90a4ae; padding: 6px 2px; text-align: center; font-weight: bold; color: #37474f; vertical-align: middle; line-height: 1.1; }
        .paper-table td { border: 1px solid #b0bec5; padding: 8px 4px; text-align: center; vertical-align: middle; color: #263238; font-weight: 600; font-size: 0.95rem; }
        .pt-time { background: #eceff1; font-weight: bold; font-size: 0.8rem; }
        .total-row td { background-color: #37474f !important; color: white !important; font-weight: 900 !important; }
        
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background-color: #f5f7fa; margin: 5% auto; border-radius: 16px; width: 95%; max-width: 600px; max-height: 90vh; box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: flex; flex-direction: column; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #fff; border-bottom: 2px solid #e0e0e0; flex-shrink: 0; border-radius: 16px 16px 0 0; }
        .modal-body { overflow-y: auto; padding: 20px; flex-grow: 1; }
        .btn-close-modal { background: #ffebee; color: #c62828; border: none; font-size: 1.5rem; font-weight: bold; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
        .fab-container { position: fixed; bottom: 25px; right: 20px; z-index: 2000; }
        .fab-main { width: 65px; height: 65px; border-radius: 50%; background: #00c853; color: white; border: none; font-size: 32px; box-shadow: 0 6px 20px rgba(0,200,83,0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ */
        .btn-stock-manager, .btn-view-history { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; color: white; }
        .btn-stock-manager { background: #ff9800; }
        .btn-view-history { background: #546e7a; }
        .wiz-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cfd8dc; font-size: 1.1rem; }
        .btn-save-wiz { width: 100%; padding: 15px; background: #00c853; color: white; border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; margin-top: 15px; }
        .dist-container { background: #fafafa; border-radius: 12px; padding: 10px; border: 1px dashed #cfd8dc; margin-top: 15px; }
        .btn-add-dist { width: 100%; padding: 10px; background: #eceff1; border: 1px dashed #90a4ae; border-radius: 10px; }
        .hist-item { background: white; border: 1px solid #eee; padding: 15px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="dash-item"><span>üßä ‡∏´‡∏•‡∏≠‡∏î</span><div id="dash_hl">0</div></div>
        <div class="dash-item"><span>üî® ‡∏´‡∏¢‡∏≤‡∏ö</span><div id="dash_bh">0</div></div>
        <div class="dash-item"><span>‚ùÑÔ∏è ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span><div id="dash_bl">0</div></div>
    </div>
    
    <div class="order-status-bar">
        <div class="os-item">‡∏™‡∏±‡πà‡∏á‡∏£‡∏ß‡∏°: <span id="os_total">0</span></div>
        <div class="os-item">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß: <span id="os_sent">0</span></div>
        <div class="os-item">‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á: <b id="os_remain">0</b></div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchPage('setup')">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        <button class="nav-btn" onclick="switchPage('production')">2. ‡∏ú‡∏•‡∏¥‡∏ï/‡∏à‡πà‡∏≤‡∏¢</button>
        <button class="nav-btn" onclick="switchPage('summary')">3. ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button>
    </div>

    <div id="page-setup" class="page active">
        <div class="modern-card card-body">
            <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="setup_date" onchange="changeDate()">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <div><label>üü¢ ‡πÄ‡∏õ‡∏¥‡∏î</label><input type="time" id="time_start" value="22:00" onchange="saveData()"></div>
                <div><label>üî¥ ‡∏õ‡∏¥‡∏î</label><input type="time" id="time_stop" value="06:00" onchange="saveData()"></div>
            </div>
        </div>
        <div class="modern-card card-body">
            <h3>üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                <div><div class="input-label">‡∏´‡∏•‡∏≠‡∏î</div><input type="tel" id="init_hl" value="0" onchange="updateStock()"></div>
                <div><div class="input-label">‡∏´‡∏¢‡∏≤‡∏ö</div><input type="tel" id="init_bh" value="0" onchange="updateStock()"></div>
                <div><div class="input-label">‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div><input type="tel" id="init_bl" value="0" onchange="updateStock()"></div>
            </div>
        </div>
        <div class="modern-card card-body">
            <h3>üöö ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Master Order)</h3>
            <div id="order_inputs"></div>
        </div>
        <button style="width:100%; padding:10px; background:#ddd; border:none; border-radius:8px;" onclick="if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà?')){localStorage.clear(); location.reload();}">üóëÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div id="page-production" class="page">
        <button class="btn-stock-manager" onclick="openStockManager()">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ (‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏¢‡πá‡∏ô)</button>
        <button class="btn-view-history" onclick="openFullHistory()">üïí ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
        <div id="drops_list"></div>
    </div>
    <div class="fab-container"><button class="fab-main" onclick="addDrop('prod')">+</button></div>

    <div id="page-summary" class="page">
        <div class="modern-card card-body">
             <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡∏Ñ‡∏±‡∏ô</h3>
             <div id="truck_report_container"></div>
        </div>
        <div class="modern-card card-body">
            <h3>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h3>
            <div style="overflow-x:auto;">
                <table class="paper-table">
                    <thead>
                        <tr><th rowspan="2">‡πÄ‡∏ß‡∏•‡∏≤</th><th colspan="2">‡πÄ‡∏ö‡∏¥‡∏Å</th><th colspan="3">‡∏ú‡∏•‡∏¥‡∏ï</th><th colspan="2">‡∏Ñ‡∏∑‡∏ô</th></tr>
                        <tr><th>‡∏´‡∏•‡∏≠‡∏î</th><th>‡∏ö‡∏î</th><th>‡∏´‡∏•‡∏≠‡∏î</th><th>‡∏´‡∏¢‡∏≤‡∏ö</th><th>‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏´‡∏•‡∏≠‡∏î</th><th>‡∏ö‡∏î</th></tr>
                    </thead>
                    <tbody id="prod_log_body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="full_history_modal" class="modal"><div class="modal-content"><div class="modal-header"><h3>üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3><button class="btn-close-modal" onclick="closeFullHistory()">√ó</button></div><div class="modal-body" id="full_history_list"></div></div></div>
    <div id="edit_past_modal" class="modal"><div class="modal-content"><div class="modal-header"><h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3><button class="btn-close-modal" onclick="closeEditPastModal()">√ó</button></div><div class="modal-body" id="edit_past_body"></div></div></div>
    <div id="dist_modal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="wiz_title">üöõ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ñ</h3><button class="btn-close-modal" onclick="closeDistModal()">√ó</button></div><div class="modal-body">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏±‡∏ô‡∏£‡∏ñ</label><select id="wiz_truck" class="wiz-select" onchange="updateWizStats()"></select>
        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="wiz_type" class="wiz-select" onchange="updateWizStats()"></select>
        <div id="wiz_remain" style="text-align:center; padding:10px; font-weight:bold;"></div>
        <input type="tel" id="wiz_r1" placeholder="‡πÅ‡∏ñ‡∏ß 1" oninput="updateWizStats()"><br>
        <input type="tel" id="wiz_r2" placeholder="‡πÅ‡∏ñ‡∏ß 2" oninput="updateWizStats()"><br>
        <input type="tel" id="wiz_r3" placeholder="‡πÅ‡∏ñ‡∏ß 3" oninput="updateWizStats()"><br>
        <button class="btn-save-wiz" onclick="confirmDistSave()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div></div></div>
    <div id="stock_manager_modal" class="modal"><div class="modal-content"><div class="modal-header"><h3>üì¶ ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤</h3><button class="btn-close-modal" onclick="closeStockManager()">√ó</button></div><div class="modal-body" id="stock_list_container"></div></div></div>

<script>
    const TRUCKS = ["‡∏£‡∏ñ 1", "‡∏£‡∏ñ 2", "‡∏£‡∏ñ 3", "‡∏£‡∏ñ 4", "‡∏£‡∏ñ 5", "‡∏£‡∏ñ 6", "‡∏£‡∏ñ 7", "‡∏£‡∏ñ 8", "‡∏£‡∏ñ 9"];
    const ICE_TYPES = [ { id: 'hl', label: '‡∏´‡∏•‡∏≠‡∏î' }, { id: 'bh', label: '‡∏´‡∏¢‡∏≤‡∏ö' }, { id: 'bl', label: '‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' } ];
    let DATA = { times: { start: "22:00", stop: "06:00" }, initStock: { hl:0, bh:0, bl:0 }, orders: {}, drops: [] };
    let CURRENT_DROP_ID = null;

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('setup_date').value = today;
        loadData(today);
        renderOrderInputs();
        renderDrops();
        calcAll();
    });

    function loadData(dateKey) {
        const d = localStorage.getItem(`ICE_DATA_${dateKey}`);
        if(d) DATA = JSON.parse(d);
        document.getElementById('time_start').value = DATA.times.start;
        document.getElementById('init_hl').value = DATA.initStock.hl;
    }

    function saveData() { 
        const dateKey = document.getElementById('setup_date').value;
        DATA.times.start = document.getElementById('time_start').value;
        localStorage.setItem(`ICE_DATA_${dateKey}`, JSON.stringify(DATA)); 
    }

    function addDrop(type) {
        const now = new Date();
        const timeStr = now.toTimeString().substring(0, 5);
        const newId = Date.now();
        DATA.drops.push({ id: newId, type: type, time: timeStr, p_in_room: { hl:0, bh:0, bl:0 }, dist: [] });
        saveData(); renderDrops(); calcAll();
    }

    function renderDrops() {
        const container = document.getElementById('drops_list');
        container.innerHTML = '';
        const prodDrops = DATA.drops.filter(d => d.type === 'prod');
        const latest = prodDrops[prodDrops.length - 1]; 
        if(latest) container.innerHTML = generateCardHtml(latest, 0);
        else container.innerHTML = '<p style="text-align:center; color:#aaa;">‡∏Å‡∏î + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</p>';
    }

    // üî• FIX: ‡πÄ‡∏û‡∏¥‡πà‡∏° ID ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ Logic ‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
    function generateCardHtml(d, diffMin) {
        let hlProd = Number(d.p_in_room.hl);
        let bhProd = Number(d.p_in_room.bh);
        let blProd = Number(d.p_in_room.bl);
        if(d.dist) d.dist.forEach(i => {
            if(i.type === 'hl') hlProd += Number(i.total);
            if(i.type === 'bh') bhProd += Number(i.total);
            if(i.type === 'bl') blProd += Number(i.total);
        });
        
        const hlBatch = Math.ceil(hlProd / 40) * 40;
        const crushBatch = Math.ceil((bhProd + blProd) / 40) * 40;

        return `<div class="modern-card">
            <div class="card-header-flex">
                <div class="badge-box bg-prod">‡∏ú‡∏•‡∏¥‡∏ï</div>
                <input type="time" class="big-time-input" value="${d.time}" onchange="updateDropVal(${d.id}, 'time', null, this.value)">
                <button class="btn-close-red" onclick="deleteDrop(${d.id})">√ó</button>
            </div>
            <div class="card-body">
                <div class="sack-row">
                    <div class="sack-item"><small>‡πÄ‡∏ö‡∏¥‡∏Å</small><div id="dw_${d.id}">${hlBatch}/${crushBatch}</div></div>
                    <div class="sack-item"><small>‡πÉ‡∏ä‡πâ</small><div id="du_${d.id}">${hlProd}/${bhProd+blProd}</div></div>
                    <div class="sack-item"><small>‡∏Ñ‡∏∑‡∏ô</small><div>${hlBatch-hlProd}/${crushBatch-(bhProd+blProd)}</div></div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                    <input type="tel" value="${d.p_in_room.hl}" placeholder="‡∏´‡∏•‡∏≠‡∏î" oninput="updateDropVal(${d.id}, 'p_in_room', 'hl', this.value)">
                    <input type="tel" value="${d.p_in_room.bh}" placeholder="‡∏´‡∏¢‡∏≤‡∏ö" oninput="updateDropVal(${d.id}, 'p_in_room', 'bh', this.value)">
                    <input type="tel" value="${d.p_in_room.bl}" placeholder="‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" oninput="updateDropVal(${d.id}, 'p_in_room', 'bl', this.value)">
                </div>
                <div class="dist-container">
                    <div id="dist_list_${d.id}">
                        ${d.dist ? d.dist.map((item, idx) => `<div style="font-size:0.8rem;">üöõ ${TRUCKS[parseInt(item.truck.substring(1))-1]} - ${item.total} <button onclick="removeDist(${d.id}, ${idx})">üóëÔ∏è</button></div>`).join('') : ''}
                    </div>
                    <button class="btn-add-dist" onclick="openDistModal(${d.id})">+ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ñ</button>
                </div>
            </div>
        </div>`;
    }

    function updateDropVal(id, cat, sub, val) {
        const d = DATA.drops.find(x => x.id === Number(id));
        if(!d) return;
        if(cat === 'time') d.time = val;
        else if(cat === 'p_in_room') d.p_in_room[sub] = Number(val);
        saveData(); calcAll();
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Modal ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if(cat === 'p_in_room') {
            const dw = document.getElementById(`dw_${id}`);
            if(dw) { /* ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Card */ }
        }
    }

    // üî• FIX: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏ñ‡∏∂‡∏á
    function openFullHistory() {
        const container = document.getElementById('full_history_list');
        container.innerHTML = DATA.drops.filter(d => d.type === 'prod').reverse().map(d => `
            <div class="hist-item" onclick="openEditPast(${d.id})">
                <span><b>${d.time}</b> - ‡∏ú‡∏•‡∏¥‡∏ï</span>
                <span> > </span>
            </div>
        `).join('');
        document.getElementById('full_history_modal').style.display = 'block';
    }

    function openEditPast(id) {
        const targetId = Number(id);
        const d = DATA.drops.find(x => x.id === targetId);
        if(!d) return;
        
        const body = document.getElementById('edit_past_body');
        body.innerHTML = generateCardHtml(d, 0);
        
        document.getElementById('edit_past_modal').style.display = 'block';
        document.getElementById('full_history_modal').style.display = 'none';
    }

    function closeEditPastModal() {
        document.getElementById('edit_past_modal').style.display = 'none';
        renderDrops(); // Refresh ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
    }

    function openDistModal(id) {
        CURRENT_DROP_ID = Number(id);
        const tSel = document.getElementById('wiz_truck');
        tSel.innerHTML = TRUCKS.map((t,i) => `<option value="t${i+1}">${t}</option>`).join('');
        const tySel = document.getElementById('wiz_type');
        tySel.innerHTML = ICE_TYPES.map(ty => `<option value="${ty.id}">${ty.label}</option>`).join('');
        document.getElementById('dist_modal').style.display = 'block';
    }

    function confirmDistSave() {
        const d = DATA.drops.find(x => x.id === CURRENT_DROP_ID);
        const r1 = Number(document.getElementById('wiz_r1').value || 0);
        const r2 = Number(document.getElementById('wiz_r2').value || 0);
        const r3 = Number(document.getElementById('wiz_r3').value || 0);
        const total = r1 + r2 + r3;
        
        d.dist.push({
            truck: document.getElementById('wiz_truck').value,
            type: document.getElementById('wiz_type').value,
            r1, r2, r3, total
        });
        
        saveData();
        document.getElementById('dist_modal').style.display = 'none';
        if(document.getElementById('edit_past_modal').style.display === 'block') openEditPast(CURRENT_DROP_ID);
        else renderDrops();
        calcAll();
    }

    function deleteDrop(id) {
        if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
            DATA.drops = DATA.drops.filter(d => d.id !== Number(id));
            saveData(); renderDrops(); calcAll();
            document.getElementById('edit_past_modal').style.display = 'none';
        }
    }

    function calcAll() {
        // Logic ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ï‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡πà‡∏≤ Number ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå)
        let totalSent = 0;
        DATA.drops.forEach(d => {
            if(d.dist) d.dist.forEach(i => totalSent += Number(i.total));
        });
        document.getElementById('os_sent').innerText = totalSent;
        // ... (‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    }

    function switchPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-'+id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    }
    
    function closeFullHistory() { document.getElementById('full_history_modal').style.display = 'none'; }
    function closeDistModal() { document.getElementById('dist_modal').style.display = 'none'; }
    function closeStockManager() { document.getElementById('stock_manager_modal').style.display = 'none'; }
</script>
</body>
</html>
