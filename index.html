<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Ice V111 (Custom Report)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- Global Theme --- */
        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 0; background: #f5f7fa; color: #37474f; padding-bottom: 100px; font-size: 14px; }
        * { box-sizing: border-box; }
        
        /* Dashboard */
        .dashboard { position: sticky; top: 0; z-index: 1000; background: #263238; color: white; padding: 12px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; justify-content: space-around; }
        .dash-item span { font-size: 0.75rem; color: #b0bec5; display: block; margin-bottom: 2px; }
        .dash-item div { font-size: 1.3rem; font-weight: 800; color: #69f0ae; line-height: 1; }
        
        /* Nav & Status */
        .order-status-bar { background: #fff3e0; border-bottom: 1px solid #ffe0b2; padding: 8px; text-align: center; font-size: 0.9rem; color: #ef6c00; font-weight: bold; display: flex; justify-content: space-around; position: sticky; top: 65px; z-index: 950; }
        .nav-bar { display: flex; background: white; margin: 10px; border-radius: 50px; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 105px; z-index: 900; }
        .nav-btn { flex: 1; padding: 10px; text-align: center; border: none; background: none; font-weight: bold; color: #90a4ae; cursor: pointer; border-radius: 40px; transition: 0.2s; }
        .nav-btn.active { background: #0277bd; color: white; box-shadow: 0 2px 8px rgba(2,119,189,0.4); }
        
        /* Layout */
        .page { display: none; padding: 10px; max-width: 800px; margin: 0 auto; }
        .page.active { display: block; }
        .modern-card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 20px; overflow: hidden; border: 1px solid #fff; }
        .card-body { padding: 15px; }
        
        /* Inputs (Zero Fix) */
        input[type="number"], input[type="tel"] { width: 100%; padding: 12px; font-size: 1.4rem; text-align: center; font-weight: 600; border: 1px solid #e0e0e0; border-radius: 10px; background: #fff; -moz-appearance: textfield; transition: border-color 0.2s; }
        input:focus { border-color: #29b6f6; box-shadow: 0 0 0 3px rgba(41,182,246,0.1); outline: none; background: #fff; }
        input[type="time"], input[type="date"] { width: 100%; padding: 10px; border: 1px solid #cfd8dc; border-radius: 8px; text-align: center; font-size: 1.1rem; background: white; }
        
        /* Card UI (Page 2) */
        .card-header-flex { display: flex; align-items: center; padding: 10px; gap: 10px; background: #f9fafb; border-bottom: 1px solid #eee; }
        .badge-box { border-radius: 12px; padding: 5px; width: 70px; text-align: center; color: white; font-weight: bold; font-size: 0.75rem; display: flex; flex-direction: column; justify-content: center; height: 50px; }
        .bg-prod { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .big-time-input { font-size: 1.8rem; font-weight: 800; color: #37474f; border: none; background: none; width: 100px; text-align: center; }
        .time-diff-badge { font-size: 0.85rem; color: #0277bd; font-weight: bold; background: #e1f5fe; padding: 4px 8px; border-radius: 12px; white-space: nowrap; }
        .btn-close-red { width: 35px; height: 35px; border-radius: 8px; background: #ffebee; color: #c62828; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-left: auto; }
        
        .sack-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; background: #e0f2f1; padding: 10px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #b2dfdb; }
        .sack-item { text-align: center; }
        .sack-label { font-size: 0.65rem; color: #00695c; font-weight: bold; margin-bottom: 2px; white-space: nowrap; }
        .sack-val { font-size: 1.2rem; font-weight: 800; color: #004d40; }
        .sack-split { font-size: 0.85rem; color: #555; display: flex; justify-content: center; gap: 5px; margin-top: 2px; }
        .ss-hl { color: #2e7d32; font-weight:bold; } .ss-bod { color: #6a1b9a; font-weight:bold; }

        /* --- PAPER FORM TABLE --- */
        .paper-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 5px; border: 1px solid #546e7a; }
        .paper-table th { background: #cfd8dc; border: 1px solid #90a4ae; padding: 6px 2px; text-align: center; font-weight: bold; color: #37474f; vertical-align: middle; line-height: 1.1; }
        .paper-table td { border: 1px solid #b0bec5; padding: 8px 4px; text-align: center; vertical-align: middle; color: #263238; font-weight: 600; font-size: 0.95rem; }
        .pt-time { background: #eceff1; font-weight: bold; font-size: 0.8rem; }
        .pt-check { background: #e3f2fd; color: #1565c0; } 
        .pt-prod { background: #e8f5e9; color: #2e7d32; } 
        .pt-rem { background: #fff3e0; color: #e65100; } 
        .sub-header { font-size: 0.75rem; color: #546e7a; background: #f5f5f5; }

        /* Custom Report Box */
        .custom-report { border: 2px solid #546e7a; border-radius: 8px; padding: 15px; margin-top: 20px; background: #fff; }
        .cr-section { margin-bottom: 15px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
        .cr-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .cr-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 1rem; }
        .cr-label { font-weight: bold; color: #455a64; }
        .cr-val { font-weight: 900; color: #263238; text-align: right; }
        .cr-total { color: #0277bd; font-size: 1.1rem; }
        .cr-header { font-weight: 800; color: #37474f; margin-bottom: 8px; font-size: 1.05rem; background: #eceff1; padding: 5px; border-radius: 4px; }

        /* Truck Matrix & Detail */
        .truck-matrix-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 5px; border: 1px solid #ddd; }
        .truck-matrix-table th { background: #eceff1; color: #546e7a; padding: 12px 8px; font-weight: 700; border-bottom: 2px solid #cfd8dc; font-size: 0.9rem; }
        .truck-matrix-table td { border-bottom: 1px solid #f0f0f0; padding: 10px 4px; text-align: center; vertical-align: middle; }
        .truck-name-col { text-align: left; padding-left: 15px; font-weight: 800; color: #37474f; font-size: 0.95rem; }
        .st-pill { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: 700; min-width: 60px; }
        .st-over { background: #e3f2fd; color: #1565c0; } .st-miss { background: #ffebee; color: #c62828; } .st-ok { background: #e8f5e9; color: #2e7d32; } .st-none { color: #cfd8dc; font-weight: 400; font-size: 1.2rem; }
        .truck-detail-block { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 2px solid #b0bec5; box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
        .truck-detail-header { font-weight: 800; color: #006064; border-bottom: 2px solid #e0f7fa; padding-bottom: 8px; margin-bottom: 12px; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; }
        .btn-history { background: #ff9800; color: white; border: none; border-radius: 8px; padding: 4px 10px; font-size: 0.85rem; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 5px; }
        .detail-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 0.9rem; }
        .detail-table th { background: #fafafa; padding: 8px; border-bottom: 1px solid #ddd; }
        .detail-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
        .dt-fresh { color: #2e7d32; font-weight: bold; background: #f1f8e9; }
        .dt-stock { color: #1565c0; font-weight: bold; background: #e3f2fd; }
        .dt-total { font-weight: 900; color: #37474f; background: #eceff1; }

        /* Others */
        .dist-container { background: #fafafa; border-radius: 12px; padding: 10px; border: 1px dashed #cfd8dc; margin-top: 15px; }
        .dist-item { background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 8px; position: relative; }
        .dist-header { font-weight: bold; color: #0277bd; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .dist-rows { font-size: 0.85rem; color: #546e7a; margin-top: 5px; background: #f1f8e9; padding: 5px; border-radius: 6px; }
        .btn-del-mini { background: #ffcdd2; color: #c62828; border:none; border-radius:4px; padding: 4px 10px; font-size:0.8rem; cursor: pointer; font-weight:bold; }
        .btn-edit-mini { background: #fff9c4; color: #f57f17; border:1px solid #fbc02d; border-radius:4px; padding: 4px 10px; font-size:0.8rem; cursor: pointer; font-weight:bold; margin-right: 5px; }
        .btn-add-dist { width: 100%; padding: 12px; background: #eceff1; color: #546e7a; border: 1px dashed #90a4ae; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .fab-container { position: fixed; bottom: 25px; right: 20px; z-index: 2000; }
        .fab-main { width: 65px; height: 65px; border-radius: 50%; background: #00c853; color: white; border: none; font-size: 32px; box-shadow: 0 6px 20px rgba(0,200,83,0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background-color: #f5f7fa; margin: 5% auto; border-radius: 16px; width: 95%; max-width: 600px; max-height: 90vh; box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: flex; flex-direction: column; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #fff; border-bottom: 2px solid #e0e0e0; flex-shrink: 0; border-radius: 16px 16px 0 0; }
        .modal-title { font-size: 1.2rem; font-weight: 800; color: #37474f; }
        .btn-close-modal { background: #ffebee; color: #c62828; border: none; font-size: 1.5rem; font-weight: bold; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
        .modal-body { overflow-y: auto; padding: 20px; flex-grow: 1; }
        .wiz-controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .wiz-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cfd8dc; font-size: 1.1rem; font-weight: bold; }
        .wiz-status { text-align: center; background: #e0f7fa; padding: 10px; border-radius: 8px; margin-bottom: 20px; border: 1px dashed #00acc1; }
        .wiz-status-text { font-size: 0.9rem; color: #006064; }
        .wiz-remain { font-size: 1.5rem; font-weight: 900; }
        .row-inputs { display: flex; flex-direction: column; gap: 10px; }
        .row-group { display: flex; align-items: center; gap: 10px; }
        .row-label { font-weight: bold; width: 60px; color: #546e7a; text-align: right; }
        .btn-save-wiz { width: 100%; padding: 15px; background: #00c853; color: white; border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .btn-stock-manager, .btn-view-history { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-stock-manager { background: #ff9800; color: white; box-shadow: 0 4px 10px rgba(255,152,0,0.3); }
        .btn-view-history { background: #546e7a; color: white; box-shadow: 0 4px 10px rgba(84,110,122,0.3); margin-bottom: 20px; }
        .order-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .order-table th { background: #eceff1; padding: 8px; }
        .order-table td { padding: 8px 4px; border-bottom: 1px solid #eee; }
        .order-sum-col { font-weight: bold; color: #0277bd; background: #e1f5fe; text-align: center; }
        .btn-reset { background: #cfd8dc; color: #546e7a; border: none; padding: 10px; width: 100%; margin-top: 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-label { font-size: 0.75rem; color: #78909c; margin-bottom: 4px; font-weight: 600; text-align: center; }
        .hist-item { background: white; border: 1px solid #eee; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .hist-info { font-size: 0.9rem; color: #333; }
        .hist-tag { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-weight: bold; }
        .ht-fresh { background: #e8f5e9; color: #2e7d32; } .ht-stock { background: #e3f2fd; color: #1565c0; }
        .hist-actions { display: flex; gap: 5px; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="dash-item"><span>üßä ‡∏´‡∏•‡∏≠‡∏î</span><div id="dash_hl">0</div></div>
        <div class="dash-item"><span>üî® ‡∏´‡∏¢‡∏≤‡∏ö</span><div id="dash_bh">0</div></div>
        <div class="dash-item"><span>‚ùÑÔ∏è ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span><div id="dash_bl">0</div></div>
    </div>
    
    <div class="order-status-bar">
        <div class="os-item">‡∏™‡∏±‡πà‡∏á‡∏£‡∏ß‡∏°: <span id="os_total">0</span></div>
        <div class="os-item">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß: <span id="os_sent">0</span></div>
        <div class="os-item">‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á: <b id="os_remain">0</b></div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchPage('setup')">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        <button class="nav-btn" onclick="switchPage('production')">2. ‡∏ú‡∏•‡∏¥‡∏ï/‡∏à‡πà‡∏≤‡∏¢</button>
        <button class="nav-btn" onclick="switchPage('summary')">3. ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button>
    </div>

    <div id="page-setup" class="page active">
        <div class="modern-card card-body">
            <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="setup_date" onchange="changeDate()">
            <div class="grid-2" style="margin-top:10px;">
                <div><label>üü¢ ‡πÄ‡∏õ‡∏¥‡∏î</label><input type="time" id="time_start" value="22:00" onchange="saveData()"></div>
                <div><label>üî¥ ‡∏õ‡∏¥‡∏î</label><input type="time" id="time_stop" value="06:00" onchange="saveData()"></div>
            </div>
        </div>
        <div class="modern-card card-body">
            <h3>üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤</h3>
            <div class="grid-3">
                <div><div class="input-label">‡∏´‡∏•‡∏≠‡∏î</div><input type="tel" id="init_hl" value="0" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'" onchange="updateStock()"></div>
                <div><div class="input-label">‡∏´‡∏¢‡∏≤‡∏ö</div><input type="tel" id="init_bh" value="0" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'" onchange="updateStock()"></div>
                <div><div class="input-label">‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div><input type="tel" id="init_bl" value="0" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'" onchange="updateStock()"></div>
            </div>
        </div>
        <div class="modern-card card-body">
            <h3>üöö ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Master Order)</h3>
            <div id="order_inputs"></div>
        </div>
        <button class="btn-reset" onclick="if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){localStorage.clear(); location.reload();}">üóëÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)</button>
        <div style="height:50px;"></div>
    </div>

    <div id="page-production" class="page">
        <button class="btn-stock-manager" onclick="openStockManager()">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ (‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏¢‡πá‡∏ô)</button>
        <button class="btn-view-history" onclick="openFullHistory()">üïí ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
        <div id="drops_list"></div>
        <div style="height: 100px;"></div>
    </div>
    <div class="fab-container"><button class="fab-main" onclick="addDrop('prod')">+</button></div>

    <div id="page-summary" class="page">
        <div class="modern-card card-body">
             <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡∏Ñ‡∏±‡∏ô (‡∏Ç‡∏≤‡∏î/‡πÄ‡∏Å‡∏¥‡∏ô)</h3>
             <div id="truck_report_container"></div>
        </div>

        <div class="modern-card card-body">
            <h3>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°)</h3>
            <div style="overflow-x:auto;">
                <table class="paper-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="pt-time" style="width:15%">‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th colspan="2" class="pt-check" style="width:25%">‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</th>
                            <th colspan="3" class="pt-prod" style="width:35%">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</th>
                            <th colspan="2" class="pt-rem" style="width:25%">‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        </tr>
                        <tr>
                            <th class="pt-check sub-header">‡∏´‡∏•‡∏≠‡∏î</th>
                            <th class="pt-check sub-header">‡∏ö‡∏î</th>
                            <th class="pt-prod sub-header">‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà</th>
                            <th class="pt-prod sub-header">‡∏ö‡∏î‡∏´‡∏¢‡∏≤‡∏ö</th>
                            <th class="pt-prod sub-header">‡∏ö‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                            <th class="pt-rem sub-header">‡∏´‡∏•‡∏≠‡∏î</th>
                            <th class="pt-rem sub-header">‡∏ö‡∏î</th>
                        </tr>
                    </thead>
                    <tbody id="prod_log_body"></tbody>
                </table>
            </div>

            <div class="custom-report">
                <div class="cr-section">
                    <div class="cr-header">üè≠ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ú‡∏•‡∏¥‡∏ï</div>
                    <div class="cr-row"><span class="cr-label">‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà:</span> <span class="cr-val" id="rpt_hl">0</span> ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</div>
                    <div class="cr-row"><span class="cr-label">‡∏ö‡∏î‡∏´‡∏¢‡∏≤‡∏ö:</span> <span class="cr-val" id="rpt_bh">0</span> ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</div>
                    <div class="cr-row"><span class="cr-label">‡∏ö‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</span> <span class="cr-val" id="rpt_bl">0</span> ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</div>
                    <div class="cr-row"><span class="cr-label cr-total">‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏¥‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span> <span class="cr-val cr-total" id="rpt_total_prod">0</span> ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</div>
                </div>

                <div class="cr-section">
                    <div class="cr-header">‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö)</div>
                    <div class="cr-row"><span class="cr-label">‡∏ô‡∏ô.‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà:</span> <span class="cr-val">20</span> ‡∏Å‡∏Å.</div>
                    <div class="cr-row"><span class="cr-label">‡∏ô‡∏ô.‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ö‡∏î‡∏´‡∏¢‡∏≤‡∏ö:</span> <span class="cr-val">23</span> ‡∏Å‡∏Å.</div>
                    <div class="cr-row"><span class="cr-label">‡∏ô‡∏ô.‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ö‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</span> <span class="cr-val">24</span> ‡∏Å‡∏Å.</div>
                    <div class="cr-row"><span class="cr-label cr-total">‡∏ô‡∏ô.‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°:</span> <span class="cr-val cr-total">22</span> ‡∏Å‡∏Å.</div>
                </div>

                <div class="cr-section">
                    <div class="cr-header">üèãÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏° (Production Weight)</div>
                    <div class="cr-row"><span class="cr-label">‡∏ô‡∏ô.‡∏£‡∏ß‡∏° ‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà:</span> <span class="cr-val" id="rpt_w_hl">0</span> ‡∏Å‡∏Å.</div>
                    <div class="cr-row"><span class="cr-label">‡∏ô‡∏ô.‡∏£‡∏ß‡∏° ‡∏ö‡∏î‡∏´‡∏¢‡∏≤‡∏ö:</span> <span class="cr-val" id="rpt_w_bh">0</span> ‡∏Å‡∏Å.</div>
                    <div class="cr-row"><span class="cr-label">‡∏ô‡∏ô.‡∏£‡∏ß‡∏° ‡∏ö‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</span> <span class="cr-val" id="rpt_w_bl">0</span> ‡∏Å‡∏Å.</div>
                    <div class="cr-row"><span class="cr-label cr-total">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span> <span class="cr-val cr-total" id="rpt_total_weight">0</span> ‡∏Å‡∏Å.</div>
                </div>

                <div class="cr-section">
                    <div class="cr-header">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (Performance)</div>
                    <div class="cr-row"><span class="cr-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span class="cr-val" id="rpt_avg_time">0</span> ‡∏ô‡∏≤‡∏ó‡∏µ/‡∏ï‡∏Å</div>
                    <div class="cr-row"><span class="cr-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï):</span> <span class="cr-val" id="rpt_tons_day">0</span> ‡∏ï‡∏±‡∏ô/‡∏ß‡∏±‡∏ô</div>
                    <div class="cr-row"><span class="cr-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span class="cr-val" id="rpt_avg_yield">0</span> ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö/‡∏ï‡∏Å</div>
                </div>

                <div class="cr-section">
                    <div class="cr-header">üì• ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö (Sack Audit)</div>
                    <div class="cr-row" style="background:#fffde7; padding:5px;"><span class="cr-label cr-total">‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á):</span> <span class="cr-val cr-total" id="rpt_sack_withdraw">0</span> ‡πÉ‡∏ö</div>
                    <div class="cr-row"><span class="cr-label">‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</span> <span class="cr-val" id="rpt_sack_used">0</span> ‡πÉ‡∏ö</div>
                    <div class="cr-row" style="color:red;"><span class="cr-label">‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span> <span class="cr-val" id="rpt_rem_total_all">0</span> ‡πÉ‡∏ö</div>
                </div>
            </div>
        </div>

        <div class="modern-card card-body">
             <h3>üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ç‡∏≠‡∏á</h3>
             <div id="truck_detail_container"></div>
        </div>
    </div>

    <div id="dist_modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title" id="wiz_title">üöõ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ñ</div><button class="btn-close-modal" onclick="closeDistModal()">√ó</button></div><div class="modal-body"><div class="wiz-controls"><div style="flex:1;"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏±‡∏ô‡∏£‡∏ñ</label><select id="wiz_truck" class="wiz-select" onchange="updateWizStats()"></select></div><div style="flex:1;"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="wiz_type" class="wiz-select" onchange="updateWizStats()"></select></div></div><div class="wiz-status"><div class="wiz-status-text">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div><div class="wiz-remain" id="wiz_remain">0</div></div><div class="row-inputs"><div class="row-group"><div class="row-label">‡πÅ‡∏ñ‡∏ß 1</div><input type="tel" id="wiz_r1" placeholder="0" oninput="updateWizStats()" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'"></div><div class="row-group"><div class="row-label">‡πÅ‡∏ñ‡∏ß 2</div><input type="tel" id="wiz_r2" placeholder="0" oninput="updateWizStats()" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'"></div><div class="row-group"><div class="row-label">‡πÅ‡∏ñ‡∏ß 3</div><input type="tel" id="wiz_r3" placeholder="0" oninput="updateWizStats()" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'"></div></div><button class="btn-save-wiz" onclick="confirmDistSave()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><div style="text-align:center; margin-top:10px;">‡∏£‡∏ß‡∏°: <span id="wiz_total_sum">0</span></div><div style="height:200px;"></div></div></div></div>
    <div id="stock_manager_modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤</div><button class="btn-close-modal" onclick="closeStockManager()">√ó</button></div><div class="modal-body"><button class="btn-save-dist" style="width:100%; margin-bottom:15px;" onclick="addDrop('stock'); closeStockManager(); openDistModal(DATA.drops[DATA.drops.length-1].id)">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</button><div id="stock_list_container"></div><div style="height:50px;"></div></div></div></div>
    <div id="full_history_modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</div><button class="btn-close-modal" onclick="closeFullHistory()">√ó</button></div><div class="modal-body"><div id="full_history_list"></div><div style="height:50px;"></div></div></div></div>
    <div id="history_modal" class="modal"><div class="modal-content"><div class="modal-header"><div class="modal-title" id="hist_title">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div><button class="btn-close-modal" onclick="closeHistoryModal()">√ó</button></div><div class="modal-body"><div id="history_list"></div><div style="height:50px;"></div></div></div></div>
    <div id="edit_past_modal" class="modal"><div class="modal-content" style="background:#f5f7fa;"><div class="modal-header"><div class="modal-title">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div><button class="btn-close-modal" onclick="closeEditPastModal()">√ó</button></div><div class="modal-body" id="edit_past_body" style="padding:10px;"></div></div></div>

<script>
    const TRUCKS = ["‡∏£‡∏ñ 1", "‡∏£‡∏ñ 2", "‡∏£‡∏ñ 3", "‡∏£‡∏ñ 4", "‡∏£‡∏ñ 5", "‡∏£‡∏ñ 6", "‡∏£‡∏ñ 7", "‡∏£‡∏ñ 8", "‡∏£‡∏ñ 9"];
    const ICE_TYPES = [ { id: 'hl', label: '‡∏´‡∏•‡∏≠‡∏î' }, { id: 'bh', label: '‡∏´‡∏¢‡∏≤‡∏ö' }, { id: 'bl', label: '‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' } ];
    let DATA = getEmptyData();
    let CURRENT_DROP_ID = null;
    let EDITING_DIST_IDX = null;

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('setup_date').value = today;
        loadData(today);
        initWizard();
        renderOrderInputs();
        renderDrops();
        calcAll();
    });

    function getEmptyData() { return { times: { start: "22:00", stop: "06:00" }, initStock: { hl:0, bh:0, bl:0 }, orders: {}, drops: [] }; }
    function saveData() { 
        const dateKey = document.getElementById('setup_date').value;
        DATA.times.start = document.getElementById('time_start').value;
        DATA.times.stop = document.getElementById('time_stop').value;
        DATA.initStock = { hl: getNum(document.getElementById('init_hl').value), bh: getNum(document.getElementById('init_bh').value), bl: getNum(document.getElementById('init_bl').value) };
        localStorage.setItem(`ICE_DATA_${dateKey}`, JSON.stringify(DATA)); 
    }
    function loadData(dateKey) {
        const d = localStorage.getItem(`ICE_DATA_${dateKey}`);
        if(d) { try { DATA = JSON.parse(d); if(!DATA.drops) DATA.drops = []; if(!DATA.orders) DATA.orders = {}; 
            DATA.drops.forEach(drop => {
               if(drop.dist) drop.dist.forEach(i => i.total = getNum(i.r1)+getNum(i.r2)+getNum(i.r3));
            });
        } catch(e) { DATA = getEmptyData(); } } else { DATA = getEmptyData(); }
        document.getElementById('time_start').value = DATA.times.start;
        document.getElementById('time_stop').value = DATA.times.stop;
        document.getElementById('init_hl').value = DATA.initStock.hl;
        document.getElementById('init_bh').value = DATA.initStock.bh;
        document.getElementById('init_bl').value = DATA.initStock.bl;
    }
    function changeDate() { const newDate = document.getElementById('setup_date').value; loadData(newDate); renderOrderInputs(); renderDrops(); calcAll(); }
    function getNum(val) { return parseFloat(val) || 0; }

    function addDrop(type) {
        const now = new Date();
        const timeStr = now.toTimeString().substring(0, 5);
        DATA.drops.push({ id: Date.now(), type: type, time: timeStr, sackWithdraw: 0, p_in_room: { hl:0, bh:0, bl:0 }, dist: [] });
        saveData(); renderDrops(); calcAll();
        if(type === 'prod') setTimeout(() => window.scrollTo(0, 0), 100); else openStockManager();
    }
    
    function deleteDrop(id) { if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) { DATA.drops = DATA.drops.filter(d => d.id !== id); saveData(); renderDrops(); calcAll(); if(document.getElementById('stock_manager_modal').style.display === 'block') openStockManager(); } }
    
    function renderDrops() {
        const container = document.getElementById('drops_list');
        container.innerHTML = '';
        const startTimeStr = document.getElementById('time_start').value;
        const sortedDrops = DATA.drops.slice().sort((a, b) => getAdjustedMinutes(a.time, startTimeStr) - getAdjustedMinutes(b.time, startTimeStr));
        const displayDrops = [...sortedDrops].reverse(); 
        
        const prodDrops = sortedDrops.filter(d => d.type === 'prod');
        const latestProd = prodDrops[prodDrops.length - 1]; 

        if(latestProd) {
             const d = latestProd;
             let prevTime = startTimeStr;
             const idx = prodDrops.findIndex(p => p.id === d.id);
             if(idx > 0) prevTime = prodDrops[idx-1].time;
             const diffMin = getMinDiff(prevTime, d.time);
             container.insertAdjacentHTML('beforeend', generateCardHtml(d, diffMin));
        } else {
            container.innerHTML = '<div style="text-align:center; color:#aaa; margin-top:50px;">‡∏Å‡∏î + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï</div>';
        }
        updateStats();
    }

    function generateCardHtml(d, diffMin) {
        let distHtml = '';
        if(d.dist) {
           d.dist.forEach((item, idx) => {
               distHtml += `<div class="dist-item"><div class="dist-header"><span>üöõ ${getTruckName(item.truck)} - ${getTypeName(item.type)}</span><div><button style="background:#fff9c4; border:none; padding:4px;" onclick="editDist(${d.id}, ${idx})">‚úèÔ∏è</button><button style="background:#ffcdd2; border:none; padding:4px;" onclick="removeDist(${d.id}, ${idx})">üóëÔ∏è</button></div></div><div class="dist-rows">(${item.r1}/${item.r2}/${item.r3}) = <b>${item.total}</b></div></div>`;
           });
        }
        
        let hlProd = getNum(d.p_in_room.hl);
        let bhProd = getNum(d.p_in_room.bh);
        let blProd = getNum(d.p_in_room.bl);
        if(d.dist) {
            d.dist.forEach(i => {
                if(i.type === 'hl') hlProd += getNum(i.total);
                if(i.type === 'bh') bhProd += getNum(i.total);
                if(i.type === 'bl') blProd += getNum(i.total);
            });
        }
        
        const hlBatch = Math.ceil(hlProd / 40) * 40;
        const crushBatch = Math.ceil((bhProd + blProd) / 40) * 40;
        const hlRem = hlBatch - hlProd;
        const crushRem = crushBatch - (bhProd + blProd);

        return `<div class="modern-card"><div class="card-header-flex"><div class="badge-box bg-prod"><span>‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á<br>‡∏ï‡∏Å<br>(‡∏ú‡∏•‡∏¥‡∏ï)</span></div><input type="time" class="big-time-input" value="${d.time}" onchange="updateDropVal(${d.id}, 'time', null, this.value)"><span class="time-diff-badge">(+${diffMin} ‡∏ô.)</span><button class="btn-close-red" onclick="deleteDrop(${d.id})">√ó</button></div><div class="card-body" style="padding-top:0;">
        <div class="sack-row">
            <div class="sack-item"><div class="sack-label">‡πÄ‡∏ö‡∏¥‡∏Å (‡∏´‡∏•‡∏≠‡∏î/‡∏ö‡∏î)</div><div class="sack-val" id="disp_withdraw_${d.id}">${hlBatch} / ${crushBatch}</div></div>
            <div class="sack-item"><div class="sack-label">‡πÉ‡∏ä‡πâ (‡∏´‡∏•‡∏≠‡∏î/‡∏ö‡∏î)</div><div class="sack-val" id="disp_used_${d.id}">${hlProd} / ${bhProd+blProd}</div></div>
            <div class="sack-item"><div class="sack-label">‡∏Ñ‡∏∑‡∏ô (‡∏´‡∏•‡∏≠‡∏î/‡∏ö‡∏î)</div><div class="sack-split"><span class="ss-hl" id="disp_rem_hl_${d.id}">‡∏´‡∏•‡∏≠‡∏î:${hlRem}</span> <span class="ss-bod" id="disp_rem_bod_${d.id}">‡∏ö‡∏î:${crushRem}</span></div></div>
        </div>
        <div class="grid-3"><div><div class="input-label">‡∏´‡∏•‡∏≠‡∏î (‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á)</div><input type="tel" value="${getNum(d.p_in_room.hl)}" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'" oninput="updateDropVal(${d.id}, 'p_in_room', 'hl', this.value)"></div><div><div class="input-label">‡∏´‡∏¢‡∏≤‡∏ö (‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á)</div><input type="tel" value="${getNum(d.p_in_room.bh)}" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'" oninput="updateDropVal(${d.id}, 'p_in_room', 'bh', this.value)"></div><div><div class="input-label">‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á)</div><input type="tel" value="${getNum(d.p_in_room.bl)}" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'" oninput="updateDropVal(${d.id}, 'p_in_room', 'bl', this.value)"></div></div><div class="dist-container"><div style="font-size:0.8rem; color:#90a4ae; font-weight:bold; margin-bottom:5px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ñ</div>${distHtml}<button class="btn-add-dist" onclick="openDistModal(${d.id})">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ñ</button></div></div></div>`;
    }

    function updateDropVal(id, cat, sub, val) {
        const d = DATA.drops.find(x => x.id === id);
        if(!d) return;
        if(cat === 'time') d.time = val;
        else if(cat === 'p_in_room') d.p_in_room[sub] = getNum(val);
        saveData(); 
        
        if(cat === 'p_in_room' || cat === 'dist_update') {
            let hlProd = getNum(d.p_in_room.hl); let bhProd = getNum(d.p_in_room.bh); let blProd = getNum(d.p_in_room.bl);
            if(d.dist) { d.dist.forEach(i => { if(i.type==='hl') hlProd+=getNum(i.total); if(i.type==='bh') bhProd+=getNum(i.total); if(i.type==='bl') blProd+=getNum(i.total); }); }
            const hlBatch = Math.ceil(hlProd/40)*40; const crushBatch = Math.ceil((bhProd+blProd)/40)*40;
            const dw = document.getElementById(`disp_withdraw_${id}`); const du = document.getElementById(`disp_used_${id}`);
            const dr1 = document.getElementById(`disp_rem_hl_${id}`); const dr2 = document.getElementById(`disp_rem_bod_${id}`);
            if(dw) dw.innerText = `${hlBatch} / ${crushBatch}`;
            if(du) du.innerText = `${hlProd} / ${bhProd+blProd}`;
            if(dr1) dr1.innerText = `‡∏´‡∏•‡∏≠‡∏î:${hlBatch-hlProd}`;
            if(dr2) dr2.innerText = `‡∏ö‡∏î:${crushBatch-(bhProd+blProd)}`;
        }
        calcAll();
    }

    function calcAll() {
        let sumP={hl:0,bh:0,bl:0}, curHL=getNum(document.getElementById('init_hl').value), curBH=getNum(document.getElementById('init_bh').value), curBL=getNum(document.getElementById('init_bl').value);
        let totalSent=0, totalWithHL=0, totalWithBod=0, totalRemHL=0, totalRemBod=0, totalUsedAll=0;
        let prodLogHtml = '', startTimeStr = document.getElementById('time_start').value;
        let lastProdTime = startTimeStr;

        let truckMat = {}; let truckDetail = {};
        TRUCKS.forEach((t,i) => { let tid = `t${i+1}`; truckMat[tid] = {hl:{fr:0,st:0}, bh:{fr:0,st:0}, bl:{fr:0,st:0}}; truckDetail[tid] = { hl: { r1:{fr:0,st:0}, r2:{fr:0,st:0}, r3:{fr:0,st:0} }, bh: { r1:{fr:0,st:0}, r2:{fr:0,st:0}, r3:{fr:0,st:0} }, bl: { r1:{fr:0,st:0}, r2:{fr:0,st:0}, r3:{fr:0,st:0} } }; });

        const sortedDrops = DATA.drops.slice().sort((a, b) => getAdjustedMinutes(a.time, startTimeStr) - getAdjustedMinutes(b.time, startTimeStr));

        sortedDrops.forEach(d => {
            let p_hl=0, p_bh=0, p_bl=0;
            if(d.type === 'prod') {
                p_hl = getNum(d.p_in_room.hl); p_bh = getNum(d.p_in_room.bh); p_bl = getNum(d.p_in_room.bl);
                if(d.dist) { d.dist.forEach(i => { if(i.type==='hl') p_hl+=getNum(i.total); if(i.type==='bh') p_bh+=getNum(i.total); if(i.type==='bl') p_bl+=getNum(i.total); }); }
                
                const w_hl = Math.ceil(p_hl/40)*40; const w_bod = Math.ceil((p_bh+p_bl)/40)*40;
                const r_hl = w_hl - p_hl; const r_bod = w_bod - (p_bh+p_bl);

                totalWithHL += w_hl; totalWithBod += w_bod;
                totalRemHL += r_hl; totalRemBod += r_bod;
                totalUsedAll += (p_hl + p_bh + p_bl);
                sumP.hl += p_hl; sumP.bh += p_bh; sumP.bl += p_bl;
                curHL += getNum(d.p_in_room.hl); curBH += getNum(d.p_in_room.bh); curBL += getNum(d.p_in_room.bl);

                const minDiff = getMinDiff(lastProdTime, d.time); lastProdTime = d.time;
                prodLogHtml += `<tr>
                    <td class="pt-time">${d.time}<br><span style="font-size:0.75rem; color:#888;">${minDiff} ‡∏ô‡∏≤‡∏ó‡∏µ</span></td>
                    <td class="pt-check">${w_hl>0?w_hl:'-'}</td><td class="pt-check">${w_bod>0?w_bod:'-'}</td>
                    <td class="pt-prod">${p_hl||'-'}</td><td class="pt-prod">${p_bh||'-'}</td><td class="pt-prod">${p_bl||'-'}</td>
                    <td class="pt-rem">${w_hl>0?r_hl:'-'}</td><td class="pt-rem">${w_bod>0?r_bod:'-'}</td>
                </tr>`;
            }
            if(d.dist) { d.dist.forEach(i => { const total = getNum(i.total); totalSent += total; const field = d.type === 'prod' ? 'fr' : 'st'; truckMat[i.truck][i.type][field] += total; if(truckDetail[i.truck] && truckDetail[i.truck][i.type]) { truckDetail[i.truck][i.type].r1[field] += getNum(i.r1); truckDetail[i.truck][i.type].r2[field] += getNum(i.r2); truckDetail[i.truck][i.type].r3[field] += getNum(i.r3); } if(d.type === 'stock') { if(i.type==='hl') curHL -= total; if(i.type==='bh') curBH -= total; if(i.type==='bl') curBL -= total; } }); }
        });

        document.getElementById('prod_log_body').innerHTML = prodLogHtml;
        document.getElementById('dash_hl').innerText = curHL; document.getElementById('dash_bh').innerText = curBH; document.getElementById('dash_bl').innerText = curBL;
        let totOrd=0; for(let k in DATA.orders) totOrd+=getNum(DATA.orders[k]);
        document.getElementById('os_total').innerText = totOrd; document.getElementById('os_sent').innerText = totalSent; document.getElementById('os_remain').innerText = totOrd - totalSent;

        // --- Custom Report Data Filling ---
        document.getElementById('rpt_hl').innerText = sumP.hl; 
        document.getElementById('rpt_bh').innerText = sumP.bh; 
        document.getElementById('rpt_bl').innerText = sumP.bl;
        document.getElementById('rpt_total_prod').innerText = sumP.hl + sumP.bh + sumP.bl;
        
        const totW = ((sumP.hl*20) + (sumP.bh*23) + (sumP.bl*24));
        document.getElementById('rpt_total_weight').innerText = totW.toLocaleString();
        document.getElementById('rpt_w_hl').innerText = (sumP.hl*20).toLocaleString();
        document.getElementById('rpt_w_bh').innerText = (sumP.bh*23).toLocaleString();
        document.getElementById('rpt_w_bl').innerText = (sumP.bl*24).toLocaleString();
        
        document.getElementById('rpt_with_hl').innerText = totalWithHL; 
        document.getElementById('rpt_with_bod').innerText = totalWithBod;
        document.getElementById('rpt_sack_withdraw').innerText = totalWithHL + totalWithBod;
        document.getElementById('rpt_sack_used').innerText = totalUsedAll;
        document.getElementById('rpt_rem_total_all').innerText = totalRemHL + totalRemBod;

        let lastDropTimeStr = ""; for(let i=DATA.drops.length-1; i>=0; i--) { if(DATA.drops[i].type==='prod'){ lastDropTimeStr=DATA.drops[i].time; break; } }
        let opMins = lastDropTimeStr ? getMinDiff(startTimeStr, lastDropTimeStr) : 0;
        const prodDropsCount = DATA.drops.filter(d => d.type==='prod').length;
        document.getElementById('rpt_avg_time').innerText = prodDropsCount > 0 ? (opMins / prodDropsCount).toFixed(0) : 0;
        
        // Tons per Day (Assuming 24 hrs for calculation or just current progress?) 
        // W041 paper shows "58 ‡∏ï‡∏±‡∏ô/‡∏ß‡∏±‡∏ô". This is roughly TotalWeight / 1000.
        // Let's use simple metric: Total Weight / 1000
        const tons = totW / 1000;
        document.getElementById('rpt_tons_day').innerText = tons.toFixed(2);
        
        // Avg sacks per drop
        document.getElementById('rpt_avg_yield').innerText = prodDropsCount > 0 ? ((sumP.hl+sumP.bh+sumP.bl) / prodDropsCount).toFixed(0) : 0;

        renderSummaryTable(truckMat);
        renderDetailTable(truckDetail);
    }

    function renderSummaryTable(mat) { let h = `<table class="truck-matrix-table"><thead><tr><th style="text-align:left;">‡∏£‡∏ñ</th><th>‡∏´‡∏•‡∏≠‡∏î</th><th>‡∏´‡∏¢‡∏≤‡∏ö</th><th>‡∏•‡∏∞..</th></tr></thead><tbody>`; TRUCKS.forEach((t, i) => { const tid = `t${i+1}`; h += `<tr><td class="truck-name-col">${t}</td>`; ICE_TYPES.forEach(ty => { const target = getNum(DATA.orders[`${tid}_${ty.id}`]); const sent = mat[tid][ty.id].fr + mat[tid][ty.id].st; let cell = `<span class="st-none">-</span>`; if(target > 0 || sent > 0) { const rem = target - sent; if(rem > 0) cell = `<span class="st-pill st-miss">‡∏Ç‡∏≤‡∏î ${rem}</span>`; else if(rem < 0) cell = `<span class="st-pill st-over">‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(rem)}</span>`; else cell = `<span class="st-pill st-ok">‡∏Ñ‡∏£‡∏ö</span>`; } h += `<td>${cell}</td>`; }); h += `</tr>`; }); h += `</tbody></table>`; document.getElementById('truck_report_container').innerHTML = h; }
    function renderDetailTable(det) { let h = ''; TRUCKS.forEach((t, i) => { const tid = `t${i+1}`; if(det[tid]) { let hasData = false; let content = `<div class="truck-detail-block"><div class="truck-detail-header"><span>üöõ ${t}</span><button class="btn-history" onclick="openTruckHistory('${tid}')">üïí ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button></div>`; ICE_TYPES.forEach(ty => { if(det[tid][ty.id]) { const d = det[tid][ty.id]; const t_r1 = d.r1.fr+d.r1.st; const t_r2 = d.r2.fr+d.r2.st; const t_r3 = d.r3.fr+d.r3.st; const grand = t_r1+t_r2+t_r3; const ordered = getNum(DATA.orders[`${tid}_${ty.id}`]); if(grand > 0 || ordered > 0) { hasData = true; content += `<div style="margin-bottom:10px;"><div style="font-weight:bold; color:#0277bd;">${ty.label} <small style="color:#aaa;">(‡πÄ‡∏õ‡πâ‡∏≤: ${ordered})</small></div><table class="detail-table"><thead><tr><th style="width:20%">‡πÅ‡∏ñ‡∏ß</th><th>‡πÄ‡∏Å‡πà‡∏≤</th><th>‡∏™‡∏î</th><th>‡∏£‡∏ß‡∏°</th></tr></thead><tbody><tr><td>1</td><td class="dt-stock">${d.r1.st||'-'}</td><td class="dt-fresh">${d.r1.fr||'-'}</td><td>${t_r1}</td></tr><tr><td>2</td><td class="dt-stock">${d.r2.st||'-'}</td><td class="dt-fresh">${d.r2.fr||'-'}</td><td>${t_r2}</td></tr><tr><td>3</td><td class="dt-stock">${d.r3.st||'-'}</td><td class="dt-fresh">${d.r3.fr||'-'}</td><td>${t_r3}</td></tr><tr><td colspan="3" style="text-align:right; font-weight:bold;">‡∏£‡∏ß‡∏°:</td><td class="dt-total">${grand}</td></tr></tbody></table></div>`; } } }); content += `</div>`; if(hasData) h += content; } }); if(h==='') h='<div style="text-align:center; padding:20px; color:#aaa;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'; document.getElementById('truck_detail_container').innerHTML = h; }
    
    function updateStock() { DATA.initStock.hl = getNum(document.getElementById('init_hl').value); DATA.initStock.bh = getNum(document.getElementById('init_bh').value); DATA.initStock.bl = getNum(document.getElementById('init_bl').value); saveData(); calcAll(); }
    function updateOrder(key, val) { DATA.orders[key] = getNum(val); saveData(); calcAll(); }
    function updateStats() {}
    function openFullHistory() { const container = document.getElementById('full_history_list'); container.innerHTML = ''; const startTimeStr = document.getElementById('time_start').value; const sortedDrops = DATA.drops.filter(d => d.type === 'prod').sort((a, b) => getAdjustedMinutes(a.time, startTimeStr) - getAdjustedMinutes(b.time, startTimeStr)).reverse(); if (sortedDrops.length === 0) { container.innerHTML = '<div style="text-align:center; color:#aaa;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>'; } else { sortedDrops.forEach((d, idx) => { let prodTotal = getNum(d.p_in_room.hl) + getNum(d.p_in_room.bh) + getNum(d.p_in_room.bl); if(d.dist) d.dist.forEach(i => prodTotal += getNum(i.total)); const tag = (idx === 0) ? '<span class="hist-tag ht-fresh">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>' : ''; container.insertAdjacentHTML('beforeend', `<div class="hist-item" onclick="openEditPast(${d.id})" style="cursor:pointer;"><div class="hist-info"><div><b>${d.time}</b> ${tag}</div><div style="color:#666; font-size:0.85rem;">‡∏ú‡∏•‡∏¥‡∏ï: ${prodTotal}</div></div><div style="color:#0277bd;">></div></div>`); }); } document.getElementById('full_history_modal').style.display = 'block'; }
    function closeFullHistory() { document.getElementById('full_history_modal').style.display = 'none'; renderDrops(); calcAll(); }
    function openEditPast(id) { const d = DATA.drops.find(x => x.id === id); if(!d) return; const startTimeStr = document.getElementById('time_start').value; const sortedDrops = DATA.drops.slice().sort((a, b) => getAdjustedMinutes(a.time, startTimeStr) - getAdjustedMinutes(b.time, startTimeStr)); const prodDrops = sortedDrops.filter(x => x.type === 'prod'); let prevTime = startTimeStr; const idx = prodDrops.findIndex(p => p.id === d.id); if(idx > 0) prevTime = prodDrops[idx-1].time; const diffMin = getMinDiff(prevTime, d.time); document.getElementById('edit_past_body').innerHTML = generateCardHtml(d, diffMin); document.getElementById('edit_past_modal').style.display = 'block'; closeFullHistory(); }
    function closeEditPastModal() { document.getElementById('edit_past_modal').style.display = 'none'; openFullHistory(); }
    function openStockManager() { const container = document.getElementById('stock_list_container'); container.innerHTML = ''; const stockDrops = DATA.drops.filter(d => d.type === 'stock').reverse(); if(stockDrops.length === 0) { container.innerHTML = '<div style="text-align:center; color:#aaa; margin-top:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤</div>'; } else { stockDrops.forEach(d => { let details = ''; if(d.dist) { d.dist.forEach((item, idx) => { details += `<div style="background:white; padding:5px; border-radius:4px; margin-top:5px; font-size:0.85rem;">üöõ ${getTruckName(item.truck)} (${getTypeName(item.type)}) : <b>${item.total}</b></div>`; }); } container.insertAdjacentHTML('beforeend', `<div style="background:#fff3e0; padding:10px; border-radius:8px; margin-bottom:10px;"><div style="display:flex; justify-content:space-between; font-weight:bold; color:#ef6c00;"><span>üì¶ ‡πÄ‡∏ö‡∏¥‡∏Å ${d.time}</span><button class="btn-del-mini" onclick="deleteDrop(${d.id})">‡∏•‡∏ö</button></div>${details}<button class="btn-add-dist" style="background:white; margin-top:5px; padding:5px; font-size:0.8rem;" onclick="openDistModal(${d.id})">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡πà‡∏≤‡∏¢</button></div>`); }); } document.getElementById('stock_manager_modal').style.display = 'block'; }
    function closeStockManager() { document.getElementById('stock_manager_modal').style.display = 'none'; renderDrops(); calcAll(); }
    function removeDist(dropId, idx) { const d = DATA.drops.find(x => x.id === dropId); if(d) { d.dist.splice(idx, 1); updateDropVal(dropId, 'dist_update', null, 0); saveData(); if(document.getElementById('stock_manager_modal').style.display === 'block') openStockManager(); else if(document.getElementById('edit_past_modal').style.display === 'block') openEditPast(dropId); else renderDrops(); calcAll(); } }
    function initWizard() { const tSel = document.getElementById('wiz_truck'); const tySel = document.getElementById('wiz_type'); tSel.innerHTML = TRUCKS.map((t,i) => `<option value="t${i+1}">${t}</option>`).join(''); tySel.innerHTML = ICE_TYPES.map(ty => `<option value="${ty.id}">${ty.label}</option>`).join(''); }
    function openDistModal(dropId) { initWizard(); CURRENT_DROP_ID = dropId; EDITING_DIST_IDX = null; const d = DATA.drops.find(x => x.id === dropId); document.getElementById('wiz_r1').value = ''; document.getElementById('wiz_r2').value = ''; document.getElementById('wiz_r3').value = ''; updateWizStats(); document.getElementById('wiz_title').innerText = d.type === 'prod' ? 'üöõ ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà' : 'üì¶ ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤'; document.getElementById('dist_modal').style.display = 'block'; }
    function editDist(dropId, idx) { initWizard(); CURRENT_DROP_ID = dropId; EDITING_DIST_IDX = idx; const d = DATA.drops.find(x => x.id === dropId); const item = d.dist[idx]; document.getElementById('wiz_truck').value = item.truck; document.getElementById('wiz_type').value = item.type; document.getElementById('wiz_r1').value = item.r1; document.getElementById('wiz_r2').value = item.r2; document.getElementById('wiz_r3').value = item.r3; updateWizStats(); document.getElementById('wiz_title').innerText = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'; document.getElementById('dist_modal').style.display = 'block'; }
    function closeDistModal() { document.getElementById('dist_modal').style.display = 'none'; CURRENT_DROP_ID = null; if(document.getElementById('stock_manager_modal').style.display === 'block') openStockManager(); else if(document.getElementById('edit_past_modal').style.display === 'block') openEditPast(CURRENT_DROP_ID); }
    function updateWizStats() { const tid = document.getElementById('wiz_truck').value; const typeId = document.getElementById('wiz_type').value; let totalSent = 0; DATA.drops.forEach(d => { if(d.dist) { d.dist.forEach((item, idx) => { if(d.id === CURRENT_DROP_ID && idx === EDITING_DIST_IDX) return; if(item.truck === tid && item.type === typeId) totalSent += getNum(item.total); }); } }); const r1 = getNum(document.getElementById('wiz_r1').value); const r2 = getNum(document.getElementById('wiz_r2').value); const r3 = getNum(document.getElementById('wiz_r3').value); const currentTotal = r1 + r2 + r3; const target = getNum(DATA.orders[`${tid}_${typeId}`]); const remain = target - (totalSent + currentTotal); document.getElementById('wiz_total_sum').innerText = currentTotal; const remEl = document.getElementById('wiz_remain'); if (target === 0) { remEl.innerText = "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏±‡πà‡∏á"; remEl.className = 'wiz-remain'; } else if (remain > 0) { remEl.innerText = `‡∏Ç‡∏≤‡∏î ${remain}`; remEl.className = 'wiz-remain st-miss'; } else if (remain < 0) { remEl.innerText = `‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(remain)}`; remEl.className = 'wiz-remain st-over'; } else { remEl.innerText = "‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ"; remEl.className = 'wiz-remain st-ok'; } }
    function confirmDistSave() { if (!CURRENT_DROP_ID) return; const d = DATA.drops.find(x => x.id === CURRENT_DROP_ID); const r1 = getNum(document.getElementById('wiz_r1').value); const r2 = getNum(document.getElementById('wiz_r2').value); const r3 = getNum(document.getElementById('wiz_r3').value); const total = r1 + r2 + r3; if (total === 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'); return; } const newData = { truck: document.getElementById('wiz_truck').value, type: document.getElementById('wiz_type').value, r1: r1, r2: r2, r3: r3, total: total }; if(EDITING_DIST_IDX !== null) { d.dist[EDITING_DIST_IDX] = newData; } else { if(!d.dist) d.dist = []; d.dist.push(newData); } updateDropVal(CURRENT_DROP_ID, 'dist_update', null, 0); if(document.getElementById('stock_manager_modal').style.display === 'block') openStockManager(); else if(document.getElementById('edit_past_modal').style.display === 'block') openEditPast(CURRENT_DROP_ID); else renderDrops(); closeDistModal(); calcAll(); }
    function renderOrderInputs() { const c = document.getElementById('order_inputs'); let h = '<table class="order-table"><thead><tr><th>‡∏£‡∏ñ</th><th>‡∏´‡∏•‡∏≠‡∏î</th><th>‡∏´‡∏¢‡∏≤‡∏ö</th><th>‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th class="col-total">‡∏£‡∏ß‡∏°</th></tr></thead><tbody>'; TRUCKS.forEach((t, i) => { const tid = `t${i+1}`; const hl = DATA.orders[tid+'_hl']||0; const bh = DATA.orders[tid+'_bh']||0; const bl = DATA.orders[tid+'_bl']||0; const total = hl + bh + bl; h += `<tr><td>${t}</td><td><input type="tel" value="${hl}" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'" onchange="updateOrder('${tid}_hl',this.value)"></td><td><input type="tel" value="${bh}" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'" onchange="updateOrder('${tid}_bh',this.value)"></td><td><input type="tel" value="${bl}" onfocus="if(this.value=='0')this.value=''" onblur="if(this.value=='')this.value='0'" onchange="updateOrder('${tid}_bl',this.value)"></td><td class="order-sum-col" id="ord_sum_${tid}">${total}</td></tr>`; }); h += '</tbody></table>'; c.innerHTML = h; }
    function openTruckHistory(tid) { const container = document.getElementById('history_list'); container.innerHTML = ''; document.getElementById('hist_title').innerText = `üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ${getTruckName(tid)}`; const startTimeStr = document.getElementById('time_start').value; const sortedDrops = DATA.drops.slice().sort((a, b) => getAdjustedMinutes(a.time, startTimeStr) - getAdjustedMinutes(b.time, startTimeStr)); sortedDrops.forEach(d => { if(d.dist) { d.dist.forEach((item, idx) => { if(item.truck === tid) { const typeName = getTypeName(item.type); const typeLabel = d.type === 'prod' ? '<span class="hist-tag ht-fresh">‡∏ú‡∏•‡∏¥‡∏ï</span>' : '<span class="hist-tag ht-stock">‡∏´‡πâ‡∏≠‡∏á</span>'; container.insertAdjacentHTML('beforeend', `<div class="hist-item"><div class="hist-info"><div><b>${d.time}</b> ${typeLabel} : ${typeName}</div><div style="color:#666;">(${item.r1}/${item.r2}/${item.r3}) = <b>${item.total}</b></div></div></div>`); } }); } }); document.getElementById('history_modal').style.display = 'block'; }
    function closeHistoryModal() { document.getElementById('history_modal').style.display = 'none'; }
    function getTruckName(id) { return TRUCKS[parseInt(id.replace('t',''))-1]; }
    function getTypeName(id) { return ICE_TYPES.find(x=>x.id===id).label; }
    function getAdjustedMinutes(timeStr, startStr) { if(!timeStr || !startStr) return 0; let [h, m] = timeStr.split(':').map(Number); let [sh, sm] = startStr.split(':').map(Number); let mins = h * 60 + m; let sMins = sh * 60 + sm; if (mins < sMins) mins += 1440; return mins; }
    function getMinDiff(start, end) { const anchor = document.getElementById('time_start').value; const mStart = getAdjustedMinutes(start, anchor); const mEnd = getAdjustedMinutes(end, anchor); return mEnd - mStart; }
    function switchPage(id) { document.querySelectorAll('.page').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active')); document.getElementById('page-'+id).classList.add('active'); const map={setup:0,production:1,summary:2}; document.querySelectorAll('.nav-btn')[map[id]].classList.add('active'); if(id==='summary'){calcAll(); window.scrollTo(0,0);} }
</script>
</body>
</html>
