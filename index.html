<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Production & Distribution</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: system-ui; background:#f5f7fa; margin:0; padding:12px }
.modern-card {
  background:#fff; border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  margin-bottom:12px; overflow:hidden
}
.card-header-flex {
  display:flex; justify-content:space-between; align-items:center;
  background:#e3f2fd; font-weight:700
}
.card-body { padding:12px }
button { border:none; border-radius:8px; padding:6px 10px; cursor:pointer }
.btn { background:#1976d2; color:#fff }
.btn-add { background:#2e7d32; color:#fff }
.btn-edit-mini { background:#ffa000; color:#fff }
.btn-del-mini { background:#d32f2f; color:#fff }
input, select {
  width:100%; padding:6px; margin:4px 0;
  border-radius:6px; border:1px solid #ccc
}
.modal {
  position:fixed; inset:0; background:rgba(0,0,0,.4);
  display:none; align-items:center; justify-content:center
}
.modal-content {
  background:#fff; width:90%; max-width:360px;
  border-radius:12px; padding:12px
}
</style>
</head>

<body>

<h2>üì¶ Production</h2>
<div id="dropList"></div>

<button class="btn-add" onclick="addDrop()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏ú‡∏•‡∏¥‡∏ï</button>

<hr>
<h2>üìä Summary</h2>
<div class="modern-card">
  <div class="card-body">
    ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="rpt_sack_used">0</b> ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö<br>
    ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°: <b id="rpt_rem_total_all">0</b> ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö
  </div>
</div>

<!-- MODAL -->
<div class="modal" id="distModal">
  <div class="modal-content">
    <h3>‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ñ</h3>
    <select id="wiz_truck">
      <option value="T1">‡∏£‡∏ñ 1</option>
      <option value="T2">‡∏£‡∏ñ 2</option>
    </select>
    <select id="wiz_type">
      <option value="HL">‡∏´‡∏•‡∏≠‡∏î</option>
      <option value="BOD">‡∏ö‡∏î</option>
    </select>
    ‡πÅ‡∏ñ‡∏ß 1 <input id="wiz_r1" type="number" value="0">
    ‡πÅ‡∏ñ‡∏ß 2 <input id="wiz_r2" type="number" value="0">
    ‡πÅ‡∏ñ‡∏ß 3 <input id="wiz_r3" type="number" value="0">
    <br>
    <button class="btn" onclick="confirmDistSave()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button onclick="closeDistModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>
</div>

<script>
/* ================= DATA ================= */
let DATA = {
  drops: [],
  initStock: 0
};
let CURRENT_DROP_ID = null;
let EDITING_DIST_IDX = null;

/* ================= UTIL ================= */
function getNum(v){ return parseInt(v)||0 }
function saveData(){ localStorage.setItem('prod_data', JSON.stringify(DATA)) }
function loadData(){
  const d = localStorage.getItem('prod_data');
  if(d) DATA = JSON.parse(d)
}
function getTruckName(v){ return v }
function getTypeName(v){ return v }

/* ================= DROP ================= */
function addDrop(){
  DATA.drops.push({
    id: Date.now(),
    time: new Date().toLocaleTimeString(),
    prod: 0,
    dist:[]
  });
  saveData(); renderDrops()
}

/* ================= DIST ================= */
function openDistModal(dropId, idx=null){
  CURRENT_DROP_ID = dropId;
  EDITING_DIST_IDX = idx;

  document.getElementById('wiz_r1').value = 0;
  document.getElementById('wiz_r2').value = 0;
  document.getElementById('wiz_r3').value = 0;

  if(idx !== null){
    const d = DATA.drops.find(x=>x.id===dropId).dist[idx];
    wiz_truck.value = d.truck;
    wiz_type.value = d.type;
    wiz_r1.value = d.r1;
    wiz_r2.value = d.r2;
    wiz_r3.value = d.r3;
  }

  distModal.style.display='flex'
}
function closeDistModal(){
  distModal.style.display='none';
  CURRENT_DROP_ID=null;
  EDITING_DIST_IDX=null
}

function confirmDistSave(){
  if(!CURRENT_DROP_ID) return;
  const d = DATA.drops.find(x=>x.id===CURRENT_DROP_ID);
  if(!d) return;

  const r1=getNum(wiz_r1.value),
        r2=getNum(wiz_r2.value),
        r3=getNum(wiz_r3.value);
  const total = r1+r2+r3;
  if(total===0){ alert('‡πÉ‡∏™‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß'); return }

  const item = {
    truck:wiz_truck.value,
    type:wiz_type.value,
    r1,r2,r3,total
  };

  if(EDITING_DIST_IDX!==null) d.dist[EDITING_DIST_IDX]=item;
  else d.dist.push(item);

  saveData(); closeDistModal(); renderDrops(); calcAll()
}

function editDist(dropId, idx){ openDistModal(dropId, idx) }
function removeDist(dropId, idx){
  if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
  const d = DATA.drops.find(x=>x.id===dropId);
  d.dist.splice(idx,1);
  saveData(); renderDrops(); calcAll()
}

/* ================= RENDER ================= */
function renderDrops(){
  dropList.innerHTML='';
  DATA.drops.forEach(d=>{
    let distHtml='';
    d.dist.forEach((item,idx)=>{
      distHtml+=`
      <div class="modern-card">
        <div class="card-header-flex">
          üöõ ${item.truck} ‚Ä¢ ${item.type}
          <span>
            <button class="btn-edit-mini" onclick="editDist(${d.id},${idx})">‚úèÔ∏è</button>
            <button class="btn-del-mini" onclick="removeDist(${d.id},${idx})">üóëÔ∏è</button>
          </span>
        </div>
        <div class="card-body">
          ‡πÅ‡∏ñ‡∏ß: ${item.r1}/${item.r2}/${item.r3}<br>
          <b>${item.total}</b> ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö
        </div>
      </div>`;
    });

    dropList.innerHTML+=`
    <div class="modern-card">
      <div class="card-header-flex">
        ‡∏£‡∏≠‡∏ö ${d.time}
        <button class="btn" onclick="openDistModal(${d.id})">‚ûï ‡∏à‡πà‡∏≤‡∏¢</button>
      </div>
      <div class="card-body">${distHtml || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢'}</div>
    </div>`;
  });
}

/* ================= SUMMARY ================= */
function calcAll(){
  let used=0;
  DATA.drops.forEach(d=>{
    d.dist.forEach(x=>used+=x.total)
  });
  rpt_sack_used.innerText = used;
  rpt_rem_total_all.innerText = DATA.initStock - used;
}

/* ================= INIT ================= */
loadData();
renderDrops();
calcAll();
</script>
</body>
</html>
