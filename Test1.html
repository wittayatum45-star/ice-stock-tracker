<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Ice V35 (Perfect Logic)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- Global Theme --- */
        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 0; background: #f0f2f5; color: #37474f; padding-bottom: 100px; font-size: 14px; }
        * { box-sizing: border-box; }

        /* --- Sticky Dashboard (Top) --- */
        .dashboard {
            position: sticky; top: 0; z-index: 1000;
            background: #263238; color: white;
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; justify-content: space-around;
            border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;
        }
        .dash-item span { font-size: 0.7rem; color: #b0bec5; display: block; margin-bottom: 2px; }
        .dash-item div { font-size: 1.4rem; font-weight: 800; color: #69f0ae; line-height: 1; }

        /* Order Status Bar */
        .order-status-bar {
            background: #fff3e0; border-bottom: 1px solid #ffe0b2;
            padding: 8px; text-align: center; font-size: 0.9rem;
            color: #ef6c00; font-weight: bold;
            display: flex; justify-content: space-around;
            position: sticky; top: 65px; z-index: 950;
        }
        
        /* Navigation Tabs */
        .nav-bar { display: flex; background: white; margin: 10px; border-radius: 50px; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 105px; z-index: 900; }
        .nav-btn { flex: 1; padding: 10px; text-align: center; border: none; background: none; font-weight: bold; color: #90a4ae; cursor: pointer; border-radius: 40px; transition: 0.2s; }
        .nav-btn.active { background: #0277bd; color: white; box-shadow: 0 2px 8px rgba(2,119,189,0.4); }

        /* Pages */
        .page { display: none; padding: 10px; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }

        /* Cards */
        .modern-card { background: white; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; border: 1px solid #fff; }
        .card-body { padding: 15px; }
        h3, h4 { margin: 0 0 15px 0; color: #455a64; font-size: 1.1rem; border-bottom: 1px dashed #cfd8dc; padding-bottom: 5px; }

        /* Inputs (Force Numpad) */
        input[type="number"], input[type="tel"] {
            width: 100%; padding: 12px; font-size: 1.3rem; text-align: center; font-weight: 600;
            border: 1px solid #e0e0e0; border-radius: 10px; background: #fafafa;
            -moz-appearance: textfield; transition: 0.2s;
        }
        input[type="number"]:focus { border-color: #29b6f6; box-shadow: 0 0 0 3px rgba(41,182,246,0.1); outline: none; background: #fff; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        input[type="time"], input[type="date"] {
            width: 100%; padding: 10px; border: 1px solid #cfd8dc; border-radius: 8px; text-align: center; font-size: 1.1rem; background: white;
        }
        
        /* Grids */
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-label { font-size: 0.75rem; color: #78909c; margin-bottom: 4px; font-weight: 600; text-align: center; }

        /* --- Drop Card Styles (New Design) --- */
        .card-header-flex { display: flex; align-items: center; padding: 10px; gap: 10px; background: #f9fafb; border-bottom: 1px solid #eee; }
        .badge-box { 
            border-radius: 12px; padding: 5px; width: 70px; text-align: center; color: white; font-weight: bold; font-size: 0.75rem; 
            display: flex; flex-direction: column; justify-content: center; height: 50px; 
        }
        .bg-prod { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .bg-stock { background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; }
        .big-time-input { font-size: 1.8rem; font-weight: 800; color: #37474f; border: none; background: none; width: 100%; text-align: center; }
        .btn-close-red { width: 35px; height: 35px; border-radius: 8px; background: #ffebee; color: #c62828; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; }

        /* Sack Logic UI */
        .sack-row { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; 
            background: #e0f2f1; padding: 10px; border-radius: 12px; 
            margin-bottom: 15px; border: 1px solid #b2dfdb;
        }
        .sack-item { text-align: center; }
        .sack-label { font-size: 0.7rem; color: #00695c; font-weight: bold; margin-bottom: 2px; }
        .sack-val { font-size: 1.4rem; font-weight: 800; color: #004d40; }
        .val-remain { color: #d32f2f; }
        .val-remain.good { color: #2e7d32; }

        /* Distribution List */
        .dist-container { background: #fafafa; border-radius: 12px; padding: 10px; border: 1px dashed #cfd8dc; margin-top: 15px; }
        .dist-item { background: white; border: 1px solid #eee; padding: 10px; margin-top: 8px; border-radius: 8px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        
        .truck-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .truck-status { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; color: white; font-weight: bold; }
        .st-warn { background: #ffa726; } .st-ok { background: #66bb6a; } .st-over { background: #42a5f5; }

        /* Color Inputs */
        .input-green { background-color: #e8f5e9 !important; color: #2e7d32; }
        .input-blue { background-color: #e1f5fe !important; color: #0277bd; }

        /* FAB */
        .fab-container { position: fixed; bottom: 25px; right: 20px; z-index: 2000; display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
        .fab-main { width: 65px; height: 65px; border-radius: 50%; background: #00c853; color: white; border: none; font-size: 32px; box-shadow: 0 6px 20px rgba(0,200,83,0.4); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .fab-main.rotate { transform: rotate(45deg); background: #ff5252; }
        .fab-menu { display: none; flex-direction: column; gap: 12px; align-items: flex-end; }
        .fab-menu.show { display: flex; }
        .fab-item { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .fab-label { background: white; padding: 6px 12px; border-radius: 8px; font-weight: bold; color: #546e7a; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 0.9rem; }
        .fab-mini { width: 50px; height: 50px; border-radius: 50%; border: none; color: white; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; }
        .bg-green { background: #00c853; } .bg-orange { background: #ff9100; }

        /* Setup Table */
        .order-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .order-table th { background: #eceff1; padding: 8px; color: #546e7a; }
        .order-table td { padding: 5px; border-bottom: 1px solid #eee; }
        .order-table input { padding: 8px; font-size: 1.1rem; border: 1px solid #eee; }
        .col-total { font-weight: bold; color: #0277bd; background: #e1f5fe; text-align: center; }

        /* Summary Styles */
        .sum-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #cfd8dc; font-size: 1rem; }
        .sum-label { color: #455a64; font-weight: 600; }
        .sum-val { font-weight: 900; color: #263238; font-size: 1.1rem; }
        .divider-line { border-top: 2px dashed #b0bec5; margin: 15px 0; opacity: 0.5; }
        .truck-report-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        .truck-report-table th { background: #37474f; color: white; padding: 8px; text-align: center; }
        .truck-report-table td { border-bottom: 1px solid #eee; padding: 8px; text-align: center; }
        .val-missing { color: #d32f2f; font-weight: 900; }
        .val-ok { color: #388e3c; font-weight: 900; }
        .val-over { color: #1976d2; font-weight: 900; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="dash-item"><span>üßä ‡∏´‡∏•‡∏≠‡∏î</span><div id="dash_hl">0</div></div>
        <div class="dash-item"><span>üî® ‡∏´‡∏¢‡∏≤‡∏ö</span><div id="dash_bh">0</div></div>
        <div class="dash-item"><span>‚ùÑÔ∏è ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span><div id="dash_bl">0</div></div>
    </div>
    
    <div class="order-status-bar">
        <div class="os-item">‡∏™‡∏±‡πà‡∏á‡∏£‡∏ß‡∏°: <span id="os_total">0</span></div>
        <div class="os-item">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß: <span id="os_sent">0</span></div>
        <div class="os-item">‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á: <b id="os_remain">0</b></div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchPage('setup')">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        <button class="nav-btn" onclick="switchPage('production')">2. ‡∏ú‡∏•‡∏¥‡∏ï/‡∏à‡πà‡∏≤‡∏¢</button>
        <button class="nav-btn" onclick="switchPage('summary')">3. ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button>
    </div>

    <div id="page-setup" class="page active">
        <div class="modern-card card-body">
            <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</label>
            <input type="date" id="setup_date" onchange="changeDate()">
            <div class="setup-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                <div><label>üü¢ ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="time" id="time_start" value="22:00" onchange="saveData()"></div>
                <div><label>üî¥ ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="time" id="time_stop" value="06:00" onchange="saveData()"></div>
            </div>
        </div>
        <div class="modern-card card-body">
            <h3>üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ (‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á)</h3>
            <div class="grid-3">
                <div><div class="input-label">‡∏´‡∏•‡∏≠‡∏î</div><input type="number" inputmode="numeric" id="init_hl" value="0" oninput="saveData(); calcAll();" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                <div><div class="input-label">‡∏´‡∏¢‡∏≤‡∏ö</div><input type="number" inputmode="numeric" id="init_bh" value="0" oninput="saveData(); calcAll();" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                <div><div class="input-label">‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div><input type="number" inputmode="numeric" id="init_bl" value="0" oninput="saveData(); calcAll();" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
            </div>
        </div>
        <div class="modern-card card-body">
            <h3>üöö ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Master Order)</h3>
            <div id="order_inputs"></div>
        </div>
    </div>

    <div id="page-production" class="page">
        <div id="drops_list"></div>
        <div style="height: 100px;"></div>
    </div>

    <div class="fab-container">
        <div class="fab-menu" id="fab_menu">
            <div class="fab-item" onclick="addDrop('stock')">
                <span class="fab-label">üì¶ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏¢‡πá‡∏ô</span>
                <button class="fab-mini bg-orange">Stock</button>
            </div>
            <div class="fab-item" onclick="addDrop('prod')">
                <span class="fab-label">‚ùÑÔ∏è ‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ï‡∏Å</span>
                <button class="fab-mini bg-green">Prod</button>
            </div>
        </div>
        <button class="fab-main" onclick="toggleFab(this)">+</button>
    </div>

    <div id="page-summary" class="page">
        <div class="modern-card card-body">
            <h3>üè≠ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ú‡∏•‡∏¥‡∏ï</h3>
            <div class="sum-row"><span class="sum-label">‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà:</span> <span><span class="sum-val" id="rpt_hl">0</span> ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</span></div>
            <div class="sum-row"><span class="sum-label">‡∏ö‡∏î‡∏´‡∏¢‡∏≤‡∏ö:</span> <span><span class="sum-val" id="rpt_bh">0</span> ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</span></div>
            <div class="sum-row"><span class="sum-label">‡∏ö‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</span> <span><span class="sum-val" id="rpt_bl">0</span> ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</span></div>
            <div class="sum-row" style="padding-top:10px; color:#0277bd;"><span class="sum-label">‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏¥‡∏ï:</span> <span class="sum-val" id="rpt_total_prod">0</span></div>
            
            <div class="divider-line"></div>
            <h4>‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</h4>
            <div class="sum-row"><span class="sum-label">‡∏ô‡∏ô.‡∏£‡∏ß‡∏°:</span> <span class="sum-val" id="rpt_total_weight">0</span></div>

            <div class="divider-line"></div>
            <h4>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h4>
            <div class="sum-row"><span class="sum-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span><span class="sum-val" id="rpt_avg_time">0</span> ‡∏ô‡∏≤‡∏ó‡∏µ/‡∏ï‡∏Å</span></div>
            <div class="sum-row"><span class="sum-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï:</span> <span><span class="sum-val" id="rpt_tons">0</span> ‡∏ï‡∏±‡∏ô/‡∏ß‡∏±‡∏ô</span></div>
            <div class="sum-row"><span class="sum-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span><span class="sum-val" id="rpt_avg_qty">0</span> ‡πÉ‡∏ö/‡∏ï‡∏Å</span></div>

            <div class="divider-line"></div>
            <h4>üì• ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</h4>
            <div class="sum-row"><span class="sum-label">‡πÄ‡∏ö‡∏¥‡∏Å‡∏°‡∏≤:</span> <span class="sum-val" id="rpt_sack_withdraw">0</span></div>
            <div class="sum-row"><span class="sum-label">‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á:</span> <span class="sum-val" id="rpt_sack_used">0</span></div>
            <div class="sum-row" style="color:#d32f2f;"><span class="sum-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span> <span class="sum-val" id="rpt_sack_remain">0</span></div>
        </div>
        
        <div class="modern-card card-body">
             <h3>üöö ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Ñ‡∏±‡∏ô</h3>
             <div id="truck_report_container"></div>
        </div>
    </div>

<script>
    // --- CONFIG ---
    const TRUCKS = ["‡∏£‡∏ñ 1", "‡∏£‡∏ñ 2", "‡∏£‡∏ñ 3", "‡∏£‡∏ñ 4", "‡∏£‡∏ñ 5", "‡∏£‡∏ñ 6", "‡∏£‡∏ñ 7", "‡∏£‡∏ñ 8", "‡∏£‡∏ñ 9"];
    const ICE_TYPES = [
        { id: 'hl', label: '‡∏´‡∏•‡∏≠‡∏î' }, { id: 'bh', label: '‡∏´‡∏¢‡∏≤‡∏ö' }, { id: 'bl', label: '‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' }
    ];
    const WEIGHTS = { hl: 20, bh: 23, bl: 24 };

    // --- STATE ---
    let currentDate = new Date().toISOString().split('T')[0];
    let DATA = getEmptyData();

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('setup_date').value = currentDate;
        loadData(currentDate); // Load data for today
        renderOrderInputs();
        renderDrops();
        calcAll();
    });

    function getEmptyData() {
        return {
            times: { start: "22:00", stop: "06:00" },
            initStock: { hl: 0, bh: 0, bl: 0 },
            orders: {}, 
            drops: [] 
        };
    }

    function changeDate() {
        currentDate = document.getElementById('setup_date').value;
        loadData(currentDate); // Load new date's data
        // Re-render everything
        renderOrderInputs();
        renderDrops();
        calcAll();
    }

    function toggleFab(btn) {
        document.getElementById('fab_menu').classList.toggle('show');
        btn.classList.toggle('rotate');
    }

    function addDrop(type) {
        const now = new Date();
        const timeStr = now.toTimeString().substring(0, 5);
        DATA.drops.push({
            id: Date.now(),
            type: type,
            time: timeStr,
            sackWithdraw: type === 'prod' ? 80 : 0,
            // Note: prod_net values (hl, bh, bl) will be calculated
            p_in_room: { hl: 0, bh: 0, bl: 0 }, // New: User inputs how much goes to room
            dist: [] 
        });
        saveData();
        renderDrops();
        toggleFab(document.querySelector('.fab-main'));
        setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
    }

    function deleteDrop(id) {
        if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
            DATA.drops = DATA.drops.filter(d => d.id !== id);
            saveData();
            renderDrops();
            calcAll();
        }
    }

    // --- RENDER DROPS ---
    function renderDrops() {
        const container = document.getElementById('drops_list');
        container.innerHTML = '';
        const startTime = document.getElementById('time_start').value;
        let lastProdTime = startTime;

        DATA.drops.forEach((d, idx) => {
            const isProd = d.type === 'prod';
            const badgeHtml = isProd 
                ? `<div class="badge-box bg-prod"><span>‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á<br>‡∏ï‡∏Å<br>(‡∏ú‡∏•‡∏¥‡∏ï)</span></div>`
                : `<div class="badge-box bg-stock"><span>‡πÄ‡∏ö‡∏¥‡∏Å<br>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏¢‡πá‡∏ô<br>(‡πÄ‡∏Å‡πà‡∏≤)</span></div>`;

            // Time Badge
            let timeStatsHtml = '';
            if(isProd) {
                const sinceStart = getMinutesDiff(startTime, d.time);
                const sinceLast = getMinutesDiff(lastProdTime, d.time);
                timeStatsHtml = `<div class="stats-row"><div class="stat-pill">‚è±Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${sinceStart} ‡∏ô.</div><div class="stat-pill">üîÑ ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: ${sinceLast} ‡∏ô.</div></div>`;
                lastProdTime = d.time;
            }

            // üî• NEW LOGIC: Production = Room + Distributed üî•
            // Calculate Total Production for Display
            let distTotal = { hl:0, bh:0, bl:0 };
            d.dist.forEach(item => {
                 // Count only 'fresh' distribution towards production
                 if(item.type === 'hl') distTotal.hl += (item.fresh || 0);
                 if(item.type === 'bh') distTotal.bh += (item.fresh || 0);
                 if(item.type === 'bl') distTotal.bl += (item.fresh || 0);
            });

            // Display values are calculated, not stored directly in a single 'p' object anymore for input
            // We store 'p_in_room' (input) and 'dist' (input). 'Total Prod' is derived.
            const totalHL = (d.p_in_room?.hl || 0) + distTotal.hl;
            const totalBH = (d.p_in_room?.bh || 0) + distTotal.bh;
            const totalBL = (d.p_in_room?.bl || 0) + distTotal.bl;
            const totalAllProd = totalHL + totalBH + totalBL;

            const sackRemain = (d.sackWithdraw||0) - totalAllProd;
            const remainColor = sackRemain < 0 ? '#d32f2f' : '#2e7d32';

            let prodHtml = '';
            if(isProd) {
                prodHtml = `
                <div class="sack-row">
                    <div class="sack-item"><div class="sack-label">‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</div>
                        <input type="number" inputmode="numeric" value="${d.sackWithdraw}" oninput="updateDropValue(${d.id}, 'sackWithdraw', null, this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="font-size:1.4rem; font-weight:bold; color:#555;">
                    </div>
                    <div class="sack-item"><div class="sack-label">‡∏ú‡∏•‡∏¥‡∏ï‡∏£‡∏ß‡∏°</div>
                        <div class="sack-val" id="disp_total_prod_${d.id}" style="color:#333;">${totalAllProd}</div>
                    </div>
                    <div class="sack-item"><div class="sack-label">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∑‡∏ô</div>
                        <div class="sack-val" id="disp_sack_remain_${d.id}" style="color:${remainColor};">${sackRemain}</div>
                    </div>
                </div>
                <div class="grid-3" style="background:#f1f8e9; padding:10px; border-radius:8px; border:1px solid #c8e6c9; margin-bottom:10px;">
                    <div><div class="input-label" style="color:#2e7d32;">‡∏´‡∏•‡∏≠‡∏î (‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á)</div><input type="number" inputmode="numeric" class="input-green" value="${d.p_in_room?.hl||0}" oninput="updateDropValue(${d.id}, 'p_in_room', 'hl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                    <div><div class="input-label" style="color:#ef6c00;">‡∏´‡∏¢‡∏≤‡∏ö (‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á)</div><input type="number" inputmode="numeric" class="input-green" value="${d.p_in_room?.bh||0}" oninput="updateDropValue(${d.id}, 'p_in_room', 'bh', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                    <div><div class="input-label" style="color:#0277bd;">‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á)</div><input type="number" inputmode="numeric" class="input-green" value="${d.p_in_room?.bl||0}" oninput="updateDropValue(${d.id}, 'p_in_room', 'bl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                </div>
                `;
            }

            // Distribution UI
            let distHtml = '';
            d.dist.forEach((item, dIdx) => {
                const statusHtml = getTruckStatusHTML(item.truck, item.type);
                
                // Inputs: Fresh / Stock
                let inputs = '';
                if(isProd) {
                     inputs = `
                    <div><div class="input-label" style="color:#2e7d32;">üî• ‡∏™‡∏î</div><input type="number" inputmode="numeric" value="${item.fresh||''}" placeholder="0" oninput="updateDist(${d.id}, ${dIdx}, 'fresh', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="background:#e8f5e9; border-color:#a5d6a7;"></div>
                    <div><div class="input-label" style="color:#0277bd;">‚ùÑÔ∏è ‡πÄ‡∏Å‡πà‡∏≤</div><input type="number" inputmode="numeric" value="${item.stock||''}" placeholder="0" oninput="updateDist(${d.id}, ${dIdx}, 'stock', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="background:#e1f5fe; border-color:#81d4fa;"></div>`;
                } else {
                     inputs = `
                    <div style="grid-column:span 2;"><div class="input-label" style="color:#0277bd;">‚ùÑÔ∏è ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</div><input type="number" inputmode="numeric" value="${item.stock||''}" placeholder="0" oninput="updateDist(${d.id}, ${dIdx}, 'stock', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="background:#e1f5fe; border-color:#81d4fa;"></div>`;
                }

                distHtml += `
                <div class="dist-item">
                    <div class="dist-header">
                        <div style="flex:1; display:flex; gap:5px;">
                            <select onchange="updateDist(${d.id}, ${dIdx}, 'truck', this.value); renderDrops();" style="width:auto;">${TRUCKS.map((t,i) => `<option value="t${i+1}" ${item.truck===`t${i+1}`?'selected':''}>${t}</option>`).join('')}</select>
                            <select onchange="updateDist(${d.id}, ${dIdx}, 'type', this.value); renderDrops();" style="width:auto;">${ICE_TYPES.map(t => `<option value="${t.id}" ${item.type===t.id?'selected':''}>${t.label}</option>`).join('')}</select>
                        </div>
                        <button class="btn-del-dist" style="background:none; border:none; color:#ef5350; font-weight:bold; font-size:1.2rem;" onclick="removeDistRow(${d.id}, ${dIdx})">√ó</button>
                    </div>
                    <div style="margin-bottom:5px;">${statusHtml}</div>
                    <div class="grid-2">${inputs}</div>
                </div>`;
            });

            const html = `
            <div class="modern-card">
                <div class="card-header-flex">
                    ${badgeHtml}
                    <div class="time-box"><input type="time" class="big-time-input" value="${d.time}" onchange="updateDropTime(${d.id}, this.value)"></div>
                    <button class="btn-close-red" onclick="deleteDrop(${d.id})">√ó</button>
                </div>
                ${timeStatsHtml}
                <div class="card-body" style="padding-top:0;">
                    ${prodHtml}
                    <div class="dist-container">
                        <div style="font-size:0.8rem; color:#90a4ae; margin-bottom:5px; font-weight:bold;">‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ñ</div>
                        ${distHtml}
                        <button class="btn-add-dist" onclick="addDistRow(${d.id})">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</button>
                    </div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- HELPERS ---
    function getMinutesDiff(start, end) {
        if(!start || !end) return 0;
        const [h1, m1] = start.split(':').map(Number);
        const [h2, m2] = end.split(':').map(Number);
        let m = (h2*60+m2) - (h1*60+m1);
        if(m < 0) m += 1440;
        return m;
    }
    function getTruckStatusHTML(truckId, typeId) {
        const orderKey = `${truckId}_${typeId}`;
        const orderQty = DATA.orders[orderKey] || 0;
        if (orderQty === 0) return `<span class="truck-status" style="background:#9e9e9e">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏±‡πà‡∏á</span>`;
        let totalGiven = 0;
        DATA.drops.forEach(d => {
            d.dist.forEach(item => { if(item.truck===truckId && item.type===typeId) totalGiven += (item.fresh + item.stock); });
        });
        const remaining = orderQty - totalGiven;
        let statusClass = 'warn', statusText = `‡∏Ç‡∏≤‡∏î ${remaining}`;
        if (remaining === 0) { statusClass='ok'; statusText='‡∏Ñ‡∏£‡∏ö'; }
        else if (remaining < 0) { statusClass='over'; statusText=`‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(remaining)}`; }
        return `<span class="truck-status ${statusClass}">‡∏™‡∏±‡πà‡∏á: ${orderQty} | ${statusText}</span>`;
    }

    // --- RENDER ORDER INPUTS ---
    function renderOrderInputs() {
        const c = document.getElementById('order_inputs');
        let h = '<table class="order-table"><thead><tr><th>‡∏£‡∏ñ</th><th>‡∏´‡∏•‡∏≠‡∏î</th><th>‡∏´‡∏¢‡∏≤‡∏ö</th><th>‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th class="col-total">‡∏£‡∏ß‡∏°</th></tr></thead><tbody>';
        TRUCKS.forEach((t, i) => {
            const tid = `t${i+1}`;
            const hl = DATA.orders[tid+'_hl']||0;
            const bh = DATA.orders[tid+'_bh']||0;
            const bl = DATA.orders[tid+'_bl']||0;
            const total = hl + bh + bl;
            h += `<tr>
                <td>${t}</td>
                <td><input type="number" inputmode="numeric" pattern="[0-9]*" value="${hl===0?'':hl}" onchange="updateOrder('${tid}_hl',this.value)" placeholder="0" onfocus="clearZero(this)" onblur="fillZero(this)"></td>
                <td><input type="number" inputmode="numeric" pattern="[0-9]*" value="${bh===0?'':bh}" onchange="updateOrder('${tid}_bh',this.value)" placeholder="0" onfocus="clearZero(this)" onblur="fillZero(this)"></td>
                <td><input type="number" inputmode="numeric" pattern="[0-9]*" value="${bl===0?'':bl}" onchange="updateOrder('${tid}_bl',this.value)" placeholder="0" onfocus="clearZero(this)" onblur="fillZero(this)"></td>
                <td class="col-total">${total}</td>
            </tr>`;
        });
        h += '</tbody></table>';
        c.innerHTML = h;
    }

    // --- DATA UPDATERS ---
    function updateOrder(k, v) { DATA.orders[k] = parseFloat(v)||0; saveData(); calcAll(); renderOrderInputs(); }
    function updateDropTime(id, v) { const d=DATA.drops.find(x=>x.id===id); if(d){ d.time=v; saveData(); renderDrops(); } }
    
    function updateDropValue(id, type, key, val) { 
        const d = DATA.drops.find(x=>x.id===id); if(!d) return;
        const num = parseFloat(val)||0;
        
        if(type === 'sackWithdraw') {
             d.sackWithdraw = num;
        } else if(type === 'p_in_room') {
             if(!d.p_in_room) d.p_in_room = { hl:0, bh:0, bl:0 };
             d.p_in_room[key] = num;
        }
        saveData(); 
        
        // Live Calculation for UI update (No Full Re-render)
        let distTotal = { hl:0, bh:0, bl:0 };
        d.dist.forEach(i => {
            if(i.type==='hl') distTotal.hl += i.fresh;
            if(i.type==='bh') distTotal.bh += i.fresh;
            if(i.type==='bl') distTotal.bl += i.fresh;
        });
        
        const totalProd = (d.p_in_room.hl + distTotal.hl) + (d.p_in_room.bh + distTotal.bh) + (d.p_in_room.bl + distTotal.bl);
        const sackRemain = (d.sackWithdraw||0) - totalProd;
        
        const prodEl = document.getElementById(`disp_total_prod_${id}`);
        const remainEl = document.getElementById(`disp_sack_remain_${id}`);
        if(prodEl) prodEl.innerText = totalProd;
        if(remainEl) {
            remainEl.innerText = sackRemain;
            remainEl.style.color = sackRemain < 0 ? '#d32f2f' : '#2e7d32';
        }
        calcAll();
    }

    function addDistRow(id) { const d=DATA.drops.find(x=>x.id===id); if(d){ d.dist.push({truck:'t1',type:'hl',fresh:0,stock:0}); saveData(); renderDrops(); } }
    function removeDistRow(id, idx) { const d=DATA.drops.find(x=>x.id===id); if(d){ d.dist.splice(idx,1); saveData(); renderDrops(); calcAll(); } }
    function updateDist(id, idx, field, val) {
        const d=DATA.drops.find(x=>x.id===id); if(!d) return;
        if(field==='fresh'||field==='stock') val = parseFloat(val)||0;
        d.dist[idx][field] = val;
        saveData();
        
        // Trigger update for production total
        updateDropValue(id, 'dummy', 'dummy', 0); 
    }

    // --- CALCULATION ---
    function calcAll() {
        let sumProd = { hl:0, bh:0, bl:0 }; // Total Produced (Room + Fresh Dist)
        let sumSack = { w:0, u:0 };
        
        DATA.drops.forEach(d => {
            if(d.type === 'prod') {
                // Start with room input
                let p_hl = d.p_in_room?.hl || 0;
                let p_bh = d.p_in_room?.bh || 0;
                let p_bl = d.p_in_room?.bl || 0;

                // Add fresh distribution
                d.dist.forEach(i => {
                    if(i.type==='hl') p_hl += i.fresh;
                    if(i.type==='bh') p_bh += i.fresh;
                    if(i.type==='bl') p_bl += i.fresh;
                });

                sumProd.hl += p_hl; sumProd.bh += p_bh; sumProd.bl += p_bl;
                
                let totalThisDrop = p_hl + p_bh + p_bl;
                sumSack.w += (d.sackWithdraw || 0);
                sumSack.u += totalThisDrop;
            }
        });

        // Stock Logic: Init + (Produced_In_Room) - (Distributed_Stock)
        // No, simpler: Stock = Init + Total_Produced - Total_Distributed(Fresh+Stock)
        // Wait. 
        // Total Produced = Room_Input + Fresh_Dist
        // Total Distributed = Fresh_Dist + Stock_Dist
        // Balance = Init + (Room_Input + Fresh_Dist) - (Fresh_Dist + Stock_Dist)
        // Balance = Init + Room_Input - Stock_Dist
        // This logic holds perfectly! "Room Input" increases stock. "Stock Dist" decreases stock. "Fresh Dist" bypasses stock.

        let curHL = parseFloat(document.getElementById('init_hl').value)||0;
        let curBH = parseFloat(document.getElementById('init_bh').value)||0;
        let curBL = parseFloat(document.getElementById('init_bl').value)||0;

        // Add Room Inputs
        DATA.drops.forEach(d => {
            if(d.type === 'prod') {
                curHL += (d.p_in_room?.hl || 0);
                curBH += (d.p_in_room?.bh || 0);
                curBL += (d.p_in_room?.bl || 0);
            }
        });
        // Subtract Stock Distributions
        let totalSent = 0;
        DATA.drops.forEach(d => {
            d.dist.forEach(i => {
                totalSent += (i.fresh + i.stock);
                if(i.type==='hl') curHL -= i.stock;
                if(i.type==='bh') curBH -= i.stock;
                if(i.type==='bl') curBL -= i.stock;
            });
        });

        document.getElementById('dash_hl').textContent = curHL;
        document.getElementById('dash_bh').textContent = curBH; // Simple sum for dash
        document.getElementById('dash_bl').textContent = curBL;

        let totalOrdered = 0;
        for(let k in DATA.orders) totalOrdered += DATA.orders[k];
        document.getElementById('os_total').innerText = totalOrdered;
        document.getElementById('os_sent').innerText = totalSent;
        document.getElementById('os_remain').innerText = totalOrdered - totalSent;

        // Summary Report
        setText('rpt_hl', sumProd.hl); setText('rpt_bh', sumProd.bh); setText('rpt_bl', sumProd.bl);
        let totalProdVal = sumProd.hl + sumProd.bh + sumProd.bl;
        setText('rpt_total_prod', totalProdVal);

        let wHL = sumProd.hl * WEIGHTS.hl;
        let wBH = sumProd.bh * WEIGHTS.bh;
        let wBL = sumProd.bl * WEIGHTS.bl;
        let totalW = wHL + wBH + wBL;
        setText('rpt_w_hl', wHL); setText('rpt_w_bh', wBH); setText('rpt_w_bl', wBL);
        setText('rpt_total_weight', totalW);

        let start = timeToMins(document.getElementById('time_start').value);
        let stop = timeToMins(document.getElementById('time_stop').value);
        if(stop < start) stop += 1440;
        let mins = stop - start;
        
        let prodDrops = DATA.drops.filter(d => d.type==='prod').length;
        setText('rpt_avg_time', prodDrops>0 ? (mins/prodDrops).toFixed(1) : 0);
        setText('rpt_avg_qty', prodDrops>0 ? (totalProdVal/prodDrops).toFixed(1) : 0);
        let tons = (totalW * 1440 / mins / 1000).toFixed(2);
        if(!isFinite(tons)) tons = 0;
        setText('rpt_tons', tons);

        setText('rpt_sack_withdraw', sumSack.w);
        setText('rpt_sack_used', sumSack.u);
        setText('rpt_sack_remain', sumSack.w - sumSack.u);

        renderTruckSummary();
    }

    function renderTruckSummary() {
        const container = document.getElementById('truck_report_container');
        let truckTotals = {}; 
        TRUCKS.forEach((t, i) => { truckTotals[`t${i+1}`] = { hl:0, bh:0, bl:0 }; });

        DATA.drops.forEach(d => {
            d.dist.forEach(item => {
                if(truckTotals[item.truck]) {
                    truckTotals[item.truck][item.type] += (item.fresh + item.stock);
                }
            });
        });

        let html = `<table class="truck-report-table"><thead><tr><th>‡∏£‡∏ñ</th><th>‡∏ä‡∏ô‡∏¥‡∏î</th><th>‡∏™‡∏±‡πà‡∏á</th><th>‡∏™‡πà‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody>`;
        TRUCKS.forEach((t, i) => {
            const tid = `t${i+1}`;
            ICE_TYPES.forEach(type => {
                const order = DATA.orders[`${tid}_${type.id}`] || 0;
                const sent = truckTotals[tid][type.id];
                if(order > 0 || sent > 0) {
                    const diff = sent - order;
                    let stat = diff===0 ? '<span class="val-ok">‡∏Ñ‡∏£‡∏ö</span>' : (diff>0?`<span style="color:blue">+${diff}</span>`:`<span class="val-missing">${diff}</span>`);
                    html += `<tr><td>${t}</td><td>${type.label}</td><td>${order}</td><td>${sent}</td><td>${stat}</td></tr>`;
                }
            });
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    // --- UTILS & SAVE ---
    function setText(id, val) { document.getElementById(id).textContent = val; }
    function timeToMins(t) { if(!t)return 0; const [h,m]=t.split(':').map(Number); return h*60+m; }
    function switchPage(id) {
        document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
        document.getElementById('page-'+id).classList.add('active');
        const map = { setup:0, production:1, summary:2 };
        document.querySelectorAll('.nav-btn')[map[id]].classList.add('active');
        if(id==='summary') calcAll();
    }
    function clearZero(e){if(e.value=='0')e.value=''}
    function fillZero(e){if(e.value=='')e.value='0'}
    
    function saveData() { 
        const key = `ICE_V35_${DATA.date}`; // Save by Date Key!
        DATA.times = { start: document.getElementById('time_start').value, stop: document.getElementById('time_stop').value };
        DATA.initStock = {
             hl: parseFloat(document.getElementById('init_hl').value)||0,
             bh: parseFloat(document.getElementById('init_bh').value)||0,
             bl: parseFloat(document.getElementById('init_bl').value)||0
        };
        localStorage.setItem(key, JSON.stringify(DATA)); 
    }
    
    function loadData(dateStr) {
        const key = `ICE_V35_${dateStr}`;
        const d = localStorage.getItem(key);
        if(d) {
            DATA = JSON.parse(d);
        } else {
            // New Day -> Reset Drops but keep some config? No, clean slate for simplicity
            DATA = getEmptyData();
            DATA.date = dateStr;
        }
        
        // Populate UI
        document.getElementById('time_start').value = DATA.times.start;
        document.getElementById('time_stop').value = DATA.times.stop;
        document.getElementById('init_hl').value = DATA.initStock.hl;
        document.getElementById('init_bh').value = DATA.initStock.bh;
        document.getElementById('init_bl').value = DATA.initStock.bl;
    }
</script>
</body>
</html>
