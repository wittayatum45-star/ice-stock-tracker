<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Ice V27 (Dual Mode)</title>
    <style>
        /* --- Global Theme --- */
        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 0; background: #eceff1; color: #37474f; padding-bottom: 100px; font-size: 14px; }
        * { box-sizing: border-box; }

        /* --- Sticky Dashboard --- */
        .dashboard {
            position: sticky; top: 0; z-index: 1000;
            background: #263238; color: white;
            padding: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex; justify-content: space-around;
        }
        .dash-item span { font-size: 0.8rem; color: #b0bec5; }
        .dash-item div { font-size: 1.2rem; font-weight: bold; color: #69f0ae; }

        /* --- Navigation --- */
        .nav-bar { display: flex; background: white; border-bottom: 1px solid #cfd8dc; position: sticky; top: 60px; z-index: 900; }
        .nav-btn { flex: 1; padding: 12px; text-align: center; border: none; background: none; font-weight: bold; color: #78909c; cursor: pointer; }
        .nav-btn.active { color: #0277bd; border-bottom: 3px solid #0277bd; background: #e1f5fe; }

        /* --- Pages --- */
        .page { display: none; padding: 10px; max-width: 800px; margin: 0 auto; }
        .page.active { display: block; }

        /* --- Components --- */
        .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* Input Styles */
        input[type="number"], input[type="time"], input[type="date"] {
            width: 100%; padding: 8px; font-size: 1.2rem; text-align: center;
            border: 1px solid #cfd8dc; border-radius: 4px; background: #fafafa;
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        input[type="number"]:focus { background: #fff8e1; border-color: #ffa000; outline: none; }

        /* --- Page 2 Styles --- */
        .drop-card { border-left: 6px solid #ddd; margin-bottom: 20px; padding-bottom: 10px; position: relative; }
        
        /* Type specific card styles */
        .card-prod { border-left-color: #00e676; } /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
        .card-stock { border-left-color: #ff9100; } /* ‡∏™‡πâ‡∏° */

        .drop-header { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 5px; border-radius: 4px; }
        .card-prod .drop-header { background: #e8f5e9; }
        .card-stock .drop-header { background: #fff3e0; }
        
        .type-label { font-size: 0.8rem; font-weight: bold; padding: 2px 8px; border-radius: 10px; color: white; display: inline-block; margin-right: 5px;}
        .card-prod .type-label { background: #2e7d32; }
        .card-stock .type-label { background: #ef6c00; }

        .sack-calc-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; background: #fff3e0; padding: 8px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #ffe0b2; text-align: center; }
        .sack-calc-item label { font-size: 0.75rem; color: #e65100; display: block; }
        .sack-calc-item div { font-weight: bold; font-size: 1.1rem; }
        .val-remain { color: #d32f2f; }
        .val-remain.good { color: #2e7d32; }

        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }

        .input-green { background-color: #e8f5e9 !important; border-color: #a5d6a7 !important; }
        .input-yellow { background-color: #fffde7 !important; border-color: #fff59d !important; }
        .input-fresh { background-color: #e8f5e9 !important; border: 1px solid #a5d6a7 !important; }
        .input-stock { background-color: #e1f5fe !important; border: 1px solid #81d4fa !important; }

        .dist-item { background: #f9f9f9; border: 1px solid #eee; padding: 10px; margin-top: 10px; border-radius: 6px; position: relative; }
        .dist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        
        .truck-status { font-size: 0.85rem; padding: 3px 8px; border-radius: 12px; color: white; font-weight: bold; display: inline-block; margin-bottom: 5px; }
        .truck-status.warn { background: #ff9800; }
        .truck-status.ok { background: #4caf50; }
        .truck-status.over { background: #2962ff; }

        /* --- FAB Menu Styles --- */
        .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .fab-main { width: 65px; height: 65px; border-radius: 50%; background: #263238; color: white; border: none; font-size: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; justify-content: center; }
        .fab-main.rotate { transform: rotate(45deg); background: #ef5350; }
        .fab-menu { display: none; flex-direction: column; gap: 10px; align-items: flex-end; }
        .fab-menu.show { display: flex; }
        .fab-btn { display: flex; align-items: center; gap: 10px; border: none; background: none; cursor: pointer; }
        .fab-btn span { background: white; padding: 5px 10px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-weight: bold; color: #455a64; font-size: 0.9rem; }
        .fab-icon { width: 50px; height: 50px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 3px 8px rgba(0,0,0,0.3); }
        .bg-green { background: #00e676; color: #004d40; }
        .bg-orange { background: #ff9100; color: #3e2723; }

        .btn-del { background: #ffcdd2; color: #c62828; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .btn-add-dist { width: 100%; padding: 10px; background: #eceff1; border: 1px dashed #90a4ae; border-radius: 8px; color: #546e7a; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-del-dist { background: none; border: none; color: #ef5350; font-weight: bold; cursor: pointer; font-size: 1.2rem; }

        /* --- Page 3 Summary --- */
        .summary-container { background: white; padding: 15px; border-radius: 8px; border: 1px solid #ccc; }
        .sum-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #eee; }
        .sum-label { font-weight: bold; color: #455a64; }
        .sum-val { font-weight: 900; color: #37474f; }
        .sum-total { color: #0d47a1; border-top: 2px solid #eee; margin-top: 5px; padding-top: 5px; }
        .sum-blue { color: #0277bd; }
        .divider { margin: 15px 0; border-top: 2px dotted #cfd8dc; }
        
        /* Order Table */
        .order-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .order-table th { background: #eee; padding: 5px; }
        .order-table td { padding: 5px; border-bottom: 1px solid #eee; }
        
        .truck-report-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        .truck-report-table th { background: #37474f; color: white; padding: 8px; text-align: center; }
        .truck-report-table td { border-bottom: 1px solid #eee; padding: 8px; text-align: center; }
        .val-missing { color: #d32f2f; font-weight: bold; }
        .val-ok { color: #388e3c; font-weight: bold; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="dash-item"><span>üßä ‡∏´‡∏•‡∏≠‡∏î</span><div id="dash_hl">0</div></div>
        <div class="dash-item"><span>üî® ‡∏´‡∏¢‡∏≤‡∏ö</span><div id="dash_bh">0</div></div>
        <div class="dash-item"><span>‚ùÑÔ∏è ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span><div id="dash_bl">0</div></div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchPage('setup')">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        <button class="nav-btn" onclick="switchPage('production')">2. ‡∏ú‡∏•‡∏¥‡∏ï/‡∏à‡πà‡∏≤‡∏¢</button>
        <button class="nav-btn" onclick="switchPage('summary')">3. ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button>
    </div>

    <div id="page-setup" class="page active">
        <div class="card">
            <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="setup_date" onchange="saveData()">
            <div class="grid-2" style="margin-top:10px;">
                <div><label>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="time" id="time_start" value="22:00" onchange="saveData()"></div>
                <div><label>‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="time" id="time_stop" value="06:00" onchange="saveData()"></div>
            </div>
        </div>
        <div class="card">
            <h3>üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏¢‡∏Å‡∏°‡∏≤ (‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á)</h3>
            <div class="grid-3">
                <div><label>‡∏´‡∏•‡∏≠‡∏î</label><input type="number" inputmode="numeric" id="init_hl" value="0" oninput="saveData(); calcAll();" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                <div><label>‡∏´‡∏¢‡∏≤‡∏ö</label><input type="number" inputmode="numeric" id="init_bh" value="0" oninput="saveData(); calcAll();" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                <div><label>‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><input type="number" inputmode="numeric" id="init_bl" value="0" oninput="saveData(); calcAll();" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
            </div>
        </div>
        <div class="card">
            <h3>üöö ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Master Order)</h3>
            <div id="order_inputs"></div>
        </div>
    </div>

    <div id="page-production" class="page">
        <div id="drops_list"></div>
        <div style="height: 100px;"></div>
    </div>

    <div class="fab-container">
        <div class="fab-menu" id="fab_menu">
            <button class="fab-btn" onclick="addDrop('stock')">
                <span>‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏¢‡πá‡∏ô (‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤)</span>
                <div class="fab-icon bg-orange">üì¶</div>
            </button>
            <button class="fab-btn" onclick="addDrop('prod')">
                <span>‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ï‡∏Å (‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà)</span>
                <div class="fab-icon bg-green">‚ùÑÔ∏è</div>
            </button>
        </div>
        <button class="fab-main" onclick="toggleFab(this)">+</button>
    </div>

    <div id="page-summary" class="page">
        <div class="summary-container">
            <h4>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ú‡∏•‡∏¥‡∏ï</h4>
            <div class="sum-row"><span class="sum-label">‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡∏ç‡πà:</span> <span class="sum-val" id="rpt_hl">0</span></div>
            <div class="sum-row"><span class="sum-label">‡∏ö‡∏î‡∏´‡∏¢‡∏≤‡∏ö:</span> <span class="sum-val" id="rpt_bh">0</span></div>
            <div class="sum-row"><span class="sum-label">‡∏ö‡∏î‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</span> <span class="sum-val" id="rpt_bl">0</span></div>
            <div class="sum-row sum-total"><span class="sum-label sum-blue">‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏¥‡∏ï:</span> <span class="sum-val sum-blue" id="rpt_total_prod">0</span></div>
            
            <div class="divider"></div>
            <h4>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</h4>
            <div class="sum-row"><span class="sum-label">‡∏ô‡∏ô.‡∏´‡∏•‡∏≠‡∏î (x20):</span> <span class="sum-val" id="rpt_w_hl">0</span></div>
            <div class="sum-row"><span class="sum-label">‡∏ô‡∏ô.‡∏´‡∏¢‡∏≤‡∏ö (x23):</span> <span class="sum-val" id="rpt_w_bh">0</span></div>
            <div class="sum-row"><span class="sum-label">‡∏ô‡∏ô.‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (x24):</span> <span class="sum-val" id="rpt_w_bl">0</span></div>
            <div class="sum-row sum-total"><span class="sum-label sum-blue">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°:</span> <span class="sum-val sum-blue" id="rpt_total_weight">0</span></div>

            <div class="divider"></div>
            <h4>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h4>
            <div class="sum-row"><span class="sum-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span><span class="sum-val" id="rpt_avg_time">0</span> ‡∏ô‡∏≤‡∏ó‡∏µ/‡∏ï‡∏Å</span></div>
            <div class="sum-row"><span class="sum-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï:</span> <span><span class="sum-val" id="rpt_tons">0</span> ‡∏ï‡∏±‡∏ô/‡∏ß‡∏±‡∏ô</span></div>
            <div class="sum-row"><span class="sum-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span><span class="sum-val" id="rpt_avg_qty">0</span> ‡πÉ‡∏ö/‡∏ï‡∏Å</span></div>

            <div class="divider"></div>
            <h4>‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö‡πÄ‡∏õ‡∏•‡πà‡∏≤</h4>
            <div class="sum-row"><span class="sum-label">‡πÄ‡∏ö‡∏¥‡∏Å‡∏°‡∏≤:</span> <span class="sum-val" id="rpt_sack_withdraw">0</span></div>
            <div class="sum-row"><span class="sum-label">‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á:</span> <span class="sum-val" id="rpt_sack_used">0</span></div>
            <div class="sum-row" style="color:#d32f2f; border-top:2px solid #eee; margin-top:5px; padding-top:5px;"><span class="sum-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span> <span class="sum-val" id="rpt_sack_remain">0</span></div>
        </div>
        
        <div class="card" style="margin-top:15px;">
            <h4>üöö ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á (‡∏£‡∏≤‡∏¢‡∏Ñ‡∏±‡∏ô)</h4>
            <div id="truck_report_container"></div>
        </div>
    </div>

<script>
    // --- CONFIG ---
    const TRUCKS = ["‡∏£‡∏ñ 1", "‡∏£‡∏ñ 2", "‡∏£‡∏ñ 3", "‡∏£‡∏ñ 4", "‡∏£‡∏ñ 5", "‡∏£‡∏ñ 6", "‡∏£‡∏ñ 7", "‡∏£‡∏ñ 8", "‡∏£‡∏ñ 9"];
    const ICE_TYPES = [
        { id: 'hl', label: '‡∏´‡∏•‡∏≠‡∏î' }, { id: 'bh', label: '‡∏´‡∏¢‡∏≤‡∏ö' }, { id: 'bl', label: '‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' }
    ];
    const WEIGHTS = { hl: 20, bh: 23, bl: 24 };

    // --- STATE ---
    let DATA = {
        date: new Date().toISOString().split('T')[0],
        times: { start: "22:00", stop: "06:00" },
        initStock: { hl: 0, bh: 0, bl: 0 },
        orders: {}, 
        drops: [] 
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        renderOrderInputs();
        renderDrops();
        calcAll();
    });

    function toggleFab(btn) {
        document.getElementById('fab_menu').classList.toggle('show');
        btn.classList.toggle('rotate');
    }

    // üî• Add Drop with TYPE üî•
    function addDrop(type) {
        const now = new Date();
        const timeStr = now.toTimeString().substring(0, 5);
        DATA.drops.push({
            id: Date.now(),
            type: type, // 'prod' or 'stock'
            time: timeStr,
            sackWithdraw: type === 'prod' ? 80 : 0, // Auto 80 if production
            p: { hl: 0, bh: 0, bl: 0 },
            dist: [] 
        });
        saveData();
        renderDrops();
        toggleFab(document.querySelector('.fab-main')); // Close menu
        setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
    }

    function deleteDrop(id) {
        if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
            DATA.drops = DATA.drops.filter(d => d.id !== id);
            saveData();
            renderDrops();
            calcAll();
        }
    }

    function addDistRow(dropId) {
        const drop = DATA.drops.find(d => d.id === dropId);
        if(drop) {
            drop.dist.push({ truck: "t1", type: "hl", fresh: 0, stock: 0 });
            saveData();
            renderDrops();
        }
    }

    function removeDistRow(dropId, idx) {
        const drop = DATA.drops.find(d => d.id === dropId);
        if(drop) {
            drop.dist.splice(idx, 1);
            saveData();
            renderDrops();
            calcAll();
        }
    }

    function getTruckStatusHTML(truckId, typeId) {
        const orderKey = `${truckId}_${typeId}`;
        const orderQty = DATA.orders[orderKey] || 0;
        
        if (orderQty === 0) return `<span class="truck-status" style="background:#9e9e9e">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏±‡πà‡∏á</span>`;

        let totalGiven = 0;
        DATA.drops.forEach(d => {
            d.dist.forEach(item => {
                if(item.truck === truckId && item.type === typeId) {
                    totalGiven += (item.fresh + item.stock);
                }
            });
        });

        const remaining = orderQty - totalGiven;
        let statusClass = 'warn';
        let statusText = `‡∏Ç‡∏≤‡∏î ${remaining}`;

        if (remaining === 0) {
            statusClass = 'ok';
            statusText = '‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
        } else if (remaining < 0) {
            statusClass = 'over';
            statusText = `‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(remaining)}`;
        }

        return `<span class="truck-status ${statusClass}">‡∏™‡∏±‡πà‡∏á: ${orderQty} | ${statusText}</span>`;
    }

    // --- TIME CALCULATION HELPERS ---
    function getMinutesDiff(startStr, endStr) {
        if(!startStr || !endStr) return 0;
        const [h1, m1] = startStr.split(':').map(Number);
        const [h2, m2] = endStr.split(':').map(Number);
        let mins1 = h1 * 60 + m1;
        let mins2 = h2 * 60 + m2;
        if (mins2 < mins1) mins2 += 1440; 
        return mins2 - mins1;
    }

    // --- RENDER DROPS ---
    function renderDrops() {
        const container = document.getElementById('drops_list');
        container.innerHTML = '';
        
        const startTime = document.getElementById('time_start').value;
        let lastProdTime = startTime;

        DATA.drops.forEach((d, idx) => {
            const isProd = d.type === 'prod';
            const cardClass = isProd ? 'card-prod' : 'card-stock';
            const typeLabel = isProd ? '‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ï‡∏Å (‡∏ú‡∏•‡∏¥‡∏ï)' : '‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏¢‡πá‡∏ô (Stock)';
            const badgeClass = isProd ? 'type-label' : 'type-label';
            
            const totalProd = (d.p.hl||0) + (d.p.bh||0) + (d.p.bl||0);
            const sackRemain = (d.sackWithdraw||0) - totalProd;
            
            // Time Logic
            let timeHtml = '';
            if (isProd) {
                const sinceStart = getMinutesDiff(startTime, d.time);
                const sinceLast = getMinutesDiff(lastProdTime, d.time);
                timeHtml = `<span style="font-size:0.8rem; color:#546e7a;">(‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${sinceStart}‡∏ô. | ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: ${sinceLast}‡∏ô.)</span>`;
                lastProdTime = d.time; 
            }

            // Production Inputs (Only for Prod)
            let productionHTML = '';
            if(isProd) {
                productionHTML = `
                <div class="sack-calc-row">
                    <div class="sack-calc-item"><label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</label><input type="number" inputmode="numeric" value="${d.sackWithdraw}" oninput="updateDropValue(${d.id}, 'sackWithdraw', null, this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="padding:5px;"></div>
                    <div class="sack-calc-item"><label>‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏î‡πâ</label><div style="margin-top:5px;" id="prod_total_${d.id}">${totalProd}</div></div>
                    <div class="sack-calc-item"><label>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∑‡∏ô</label><div class="${sackRemain<0?'val-missing':'val-ok'}" style="margin-top:5px;" id="sack_remain_${d.id}">${sackRemain}</div></div>
                </div>
                <div class="grid-3">
                    <input type="number" inputmode="numeric" class="input-green" placeholder="‡∏´‡∏•‡∏≠‡∏î" value="${d.p.hl||''}" oninput="updateDropValue(${d.id}, 'p', 'hl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)">
                    <input type="number" inputmode="numeric" class="input-green" placeholder="‡∏´‡∏¢‡∏≤‡∏ö" value="${d.p.bh||''}" oninput="updateDropValue(${d.id}, 'p', 'bh', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)">
                    <input type="number" inputmode="numeric" class="input-green" placeholder="‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" value="${d.p.bl||''}" oninput="updateDropValue(${d.id}, 'p', 'bl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)">
                </div>`;
            }

            // Distribution Rows
            let distHtml = '';
            d.dist.forEach((item, dIdx) => {
                // If Stock Type: Hide Fresh Input
                let inputsHtml = '';
                if (isProd) {
                    inputsHtml = `
                    <div><label style="font-size:0.7rem; color:#2e7d32;">üî• ‡∏™‡∏î</label><input type="number" inputmode="numeric" class="input-fresh" value="${item.fresh||''}" oninput="updateDist(${d.id}, ${dIdx}, 'fresh', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)"></div>
                    <div><label style="font-size:0.7rem; color:#0277bd;">‚ùÑÔ∏è ‡πÄ‡∏Å‡πà‡∏≤</label><input type="number" inputmode="numeric" class="input-stock" value="${item.stock||''}" oninput="updateDist(${d.id}, ${dIdx}, 'stock', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)"></div>`;
                } else {
                    // Stock Type: Show only Stock input (Full width)
                    inputsHtml = `
                    <div style="grid-column: span 2;"><label style="font-size:0.7rem; color:#0277bd;">‚ùÑÔ∏è ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</label><input type="number" inputmode="numeric" class="input-stock" value="${item.stock||''}" oninput="updateDist(${d.id}, ${dIdx}, 'stock', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)"></div>`;
                }

                distHtml += `
                <div class="dist-item">
                    <div class="dist-header">
                        <div style="flex:1; display:flex; gap:5px;">
                            <select onchange="updateDist(${d.id}, ${dIdx}, 'truck', this.value); renderDrops();" style="width:auto;">${TRUCKS.map((t,i) => `<option value="t${i+1}" ${item.truck===`t${i+1}`?'selected':''}>${t}</option>`).join('')}</select>
                            <select onchange="updateDist(${d.id}, ${dIdx}, 'type', this.value); renderDrops();" style="width:auto;">${ICE_TYPES.map(t => `<option value="${t.id}" ${item.type===t.id?'selected':''}>${t.label}</option>`).join('')}</select>
                        </div>
                        <button class="btn-del-dist" onclick="removeDistRow(${d.id}, ${dIdx})">‚úñ</button>
                    </div>
                    <div style="margin-bottom:5px;">${getTruckStatusHTML(item.truck, item.type)}</div>
                    <div class="grid-2" ${!isProd ? 'style="display:block;"' : ''}>
                        ${inputsHtml}
                    </div>
                </div>`;
            });

            const html = `
            <div class="card drop-card ${cardClass}">
                <div class="drop-header">
                    <div>
                        <span class="type-label">${typeLabel}</span>
                        <b>#${idx+1}</b> <input type="time" value="${d.time}" onchange="updateDropTime(${d.id}, this.value)" style="width:auto; border:none; background:none; font-weight:bold;">
                    </div>
                    <button class="btn-del" onclick="deleteDrop(${d.id})">‡∏•‡∏ö</button>
                </div>
                <div style="text-align:center; margin-bottom:10px;">${timeHtml}</div>
                
                ${productionHTML}

                <div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:5px;">
                    ${distHtml}
                    <button class="btn-add-dist" onclick="addDistRow(${d.id})">+ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ñ</button>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- UPDATERS ---
    function updateOrder(key, val) {
        DATA.orders[key] = parseFloat(val) || 0;
        saveData();
    }
    function updateDropTime(id, val) {
        const drop = DATA.drops.find(d => d.id === id);
        if (drop) { drop.time = val; saveData(); renderDrops(); }
    }
    function updateDropValue(id, type, key, val) {
        const drop = DATA.drops.find(d => d.id === id);
        if(!drop) return;
        const numVal = parseFloat(val) || 0;
        if(type === 'p') drop.p[key] = numVal;
        else if(type === 'sackWithdraw') drop.sackWithdraw = numVal;
        saveData();
        
        const totalProd = (drop.p.hl||0) + (drop.p.bh||0) + (drop.p.bl||0);
        const sackRemain = (drop.sackWithdraw||0) - totalProd;
        const prodEl = document.getElementById(`prod_total_${id}`);
        const remainEl = document.getElementById(`sack_remain_${id}`);
        if(prodEl) prodEl.innerText = totalProd;
        if(remainEl) {
            remainEl.innerText = sackRemain;
            remainEl.className = sackRemain < 0 ? 'val-remain' : 'val-remain good';
        }
        calcAll();
    }
    function updateDist(dropId, distIdx, field, val) {
        const drop = DATA.drops.find(d => d.id === dropId);
        if(!drop || !drop.dist[distIdx]) return;
        if(field === 'fresh' || field === 'stock') val = parseFloat(val) || 0;
        drop.dist[distIdx][field] = val;
        saveData();
        calcAll();
    }

    // --- RENDER ORDER TABLE ---
    function renderOrderInputs() {
        const container = document.getElementById('order_inputs');
        let html = '<table class="order-table"><thead><tr><th>‡∏£‡∏ñ</th><th>‡∏´‡∏•‡∏≠‡∏î</th><th>‡∏´‡∏¢‡∏≤‡∏ö</th><th>‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr></thead><tbody>';
        TRUCKS.forEach((t, i) => {
            const tid = `t${i+1}`;
            html += `<tr>
                <td>${t}</td>
                <td><input type="number" inputmode="numeric" value="${DATA.orders[tid+'_hl']||''}" onchange="updateOrder('${tid}_hl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="padding:5px;"></td>
                <td><input type="number" inputmode="numeric" value="${DATA.orders[tid+'_bh']||''}" onchange="updateOrder('${tid}_bh', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="padding:5px;"></td>
                <td><input type="number" inputmode="numeric" value="${DATA.orders[tid+'_bl']||''}" onchange="updateOrder('${tid}_bl', this.value)" onfocus="clearZero(this)" onblur="fillZero(this)" style="padding:5px;"></td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // --- CALCULATION ---
    function calcAll() {
        let sumP = { hl:0, bh:0, bl:0 };
        let sumSack = { withdraw: 0 };
        
        // Only count production from 'prod' type drops
        DATA.drops.forEach(d => {
            if(d.type === 'prod') {
                sumP.hl += d.p.hl; sumP.bh += d.p.bh; sumP.bl += d.p.bl;
                sumSack.withdraw += (d.sackWithdraw || 0);
            }
        });

        let curHL = (parseFloat(document.getElementById('init_hl').value)||0) + sumP.hl;
        let curCrush = (parseFloat(document.getElementById('init_bh').value)||0) + (parseFloat(document.getElementById('init_bl').value)||0) + sumP.bh + sumP.bl;
        
        DATA.drops.forEach(d => {
            d.dist.forEach(item => {
                // Deduct distribution from stock
                if(item.type === 'hl') curHL -= (item.fresh + item.stock);
                else curCrush -= (item.fresh + item.stock);
            });
        });

        document.getElementById('dash_hl').textContent = curHL;
        document.getElementById('dash_bh').textContent = curCrush; 
        document.getElementById('dash_bl').textContent = (parseFloat(document.getElementById('init_bl').value)||0) + sumP.bl; 

        setText('rpt_hl', sumP.hl); setText('rpt_bh', sumP.bh); setText('rpt_bl', sumP.bl);
        let totalProd = sumP.hl + sumP.bh + sumP.bl;
        setText('rpt_total_prod', totalProd);

        let wHL = sumP.hl * WEIGHTS.hl;
        let wBH = sumP.bh * WEIGHTS.bh;
        let wBL = sumP.bl * WEIGHTS.bl;
        let totalW = wHL + wBH + wBL;
        setText('rpt_w_hl', wHL); setText('rpt_w_bh', wBH); setText('rpt_w_bl', wBL);
        setText('rpt_total_weight', totalW);

        let start = timeToMins(document.getElementById('time_start').value);
        let stop = timeToMins(document.getElementById('time_stop').value);
        if(stop < start) stop += 1440;
        let mins = stop - start;
        
        // Count only prod drops for stats
        let prodDrops = DATA.drops.filter(d => d.type === 'prod').length;
        setText('rpt_avg_time', prodDrops>0 ? (mins/prodDrops).toFixed(1) : 0);
        setText('rpt_avg_qty', prodDrops>0 ? (totalProd/prodDrops).toFixed(1) : 0);
        let tons = (totalW * 1440 / mins / 1000).toFixed(2);
        if(!isFinite(tons)) tons = 0;
        setText('rpt_tons', tons);

        setText('rpt_sack_withdraw', sumSack.withdraw);
        setText('rpt_sack_used', totalProd);
        setText('rpt_sack_remain', sumSack.withdraw - totalProd);

        renderTruckSummary();
    }

    function renderTruckSummary() {
        const container = document.getElementById('truck_report_container');
        let truckTotals = {}; 
        TRUCKS.forEach((t, i) => { truckTotals[`t${i+1}`] = { hl:0, bh:0, bl:0 }; });

        DATA.drops.forEach(d => {
            d.dist.forEach(item => {
                if(truckTotals[item.truck]) {
                    truckTotals[item.truck][item.type] += (item.fresh + item.stock);
                }
            });
        });

        let html = `<table class="truck-report-table"><thead><tr><th>‡∏£‡∏ñ</th><th>‡∏ä‡∏ô‡∏¥‡∏î</th><th>‡∏™‡∏±‡πà‡∏á</th><th>‡∏™‡πà‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody>`;
        TRUCKS.forEach((t, i) => {
            const tid = `t${i+1}`;
            ICE_TYPES.forEach(type => {
                const order = DATA.orders[`${tid}_${type.id}`] || 0;
                const sent = truckTotals[tid][type.id];
                if(order > 0 || sent > 0) {
                    const diff = sent - order;
                    let stat = diff===0 ? '<span class="val-ok">‡∏Ñ‡∏£‡∏ö</span>' : (diff>0?`<span style="color:blue">+${diff}</span>`:`<span class="val-missing">${diff}</span>`);
                    html += `<tr><td>${t}</td><td>${type.label}</td><td>${order}</td><td>${sent}</td><td>${stat}</td></tr>`;
                }
            });
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    function setText(id, val) { document.getElementById(id).textContent = val; }
    function timeToMins(t) { if(!t)return 0; const [h,m]=t.split(':').map(Number); return h*60+m; }
    function switchPage(pid) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('page-'+pid).classList.add('active');
        const map = { setup:0, production:1, summary:2 };
        document.querySelectorAll('.nav-btn')[map[pid]].classList.add('active');
        if(pid === 'summary') calcAll();
    }
    function clearZero(el) { if(el.value=='0') el.value=''; }
    function fillZero(el) { if(el.value=='') el.value='0'; }
    function saveData() { 
        DATA.times.start = document.getElementById('time_start').value;
        DATA.times.stop = document.getElementById('time_stop').value;
        localStorage.setItem('ICE_V27', JSON.stringify(DATA)); 
    }
    function loadData() {
        const d = localStorage.getItem('ICE_V27');
        if(d) {
            DATA = JSON.parse(d);
            DATA.drops.forEach(dr => { 
                if(!dr.type) dr.type = 'prod';
                if(dr.type === 'prod' && !dr.sackWithdraw) dr.sackWithdraw = 80; 
            });
            document.getElementById('time_start').value = DATA.times.start;
            document.getElementById('time_stop').value = DATA.times.stop;
            document.getElementById('init_hl').value = DATA.initStock.hl;
            document.getElementById('init_bh').value = DATA.initStock.bh;
            document.getElementById('init_bl').value = DATA.initStock.bl;
        }
    }
</script>
</body>
</html>
