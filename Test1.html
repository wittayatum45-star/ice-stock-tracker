<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Ice V58 (Quick Allocator)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- Global Theme --- */
        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 0; background: #f5f7fa; color: #37474f; padding-bottom: 100px; font-size: 14px; }
        * { box-sizing: border-box; }

        /* --- Dashboard --- */
        .dashboard {
            position: sticky; top: 0; z-index: 1000;
            background: #263238; color: white;
            padding: 12px 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; justify-content: space-around;
        }
        .dash-item span { font-size: 0.75rem; color: #b0bec5; display: block; margin-bottom: 2px; }
        .dash-item div { font-size: 1.3rem; font-weight: 800; color: #69f0ae; line-height: 1; }

        /* Order Status Bar */
        .order-status-bar {
            background: #fff3e0; border-bottom: 1px solid #ffe0b2;
            padding: 8px; text-align: center; font-size: 0.9rem;
            color: #ef6c00; font-weight: bold;
            display: flex; justify-content: space-around;
            position: sticky; top: 65px; z-index: 950;
        }
        .os-item b { color: #d84315; font-size: 1.1rem; }

        /* Navigation */
        .nav-bar { display: flex; background: white; margin: 10px; border-radius: 50px; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 105px; z-index: 900; }
        .nav-btn { flex: 1; padding: 10px; text-align: center; border: none; background: none; font-weight: bold; color: #90a4ae; cursor: pointer; border-radius: 40px; transition: 0.2s; }
        .nav-btn.active { background: #0277bd; color: white; box-shadow: 0 2px 8px rgba(2,119,189,0.4); }

        /* Pages */
        .page { display: none; padding: 10px; max-width: 800px; margin: 0 auto; }
        .page.active { display: block; }
        .modern-card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 20px; overflow: hidden; border: 1px solid #fff; }
        .card-body { padding: 15px; }
        
        /* Inputs */
        input[type="number"], input[type="tel"] {
            width: 100%; padding: 10px; font-size: 1.3rem; text-align: center; font-weight: 600;
            border: 1px solid #e0e0e0; border-radius: 10px; background: #fff;
            -moz-appearance: textfield;
        }
        input:focus { border-color: #29b6f6; outline: none; background: #e3f2fd; }
        input[type="time"], input[type="date"] { width: 100%; padding: 10px; border: 1px solid #cfd8dc; border-radius: 8px; text-align: center; font-size: 1.1rem; background: white; }

        /* Helpers */
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-label { font-size: 0.75rem; color: #78909c; margin-bottom: 4px; font-weight: 600; text-align: center; }
        
        /* Drop Card */
        .card-header-flex { display: flex; align-items: center; padding: 10px; gap: 10px; background: #f9fafb; border-bottom: 1px solid #eee; }
        .badge-box { border-radius: 12px; padding: 5px; width: 70px; text-align: center; color: white; font-weight: bold; font-size: 0.75rem; display: flex; flex-direction: column; justify-content: center; height: 50px; }
        .bg-prod { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .bg-stock { background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; }
        .big-time-input { font-size: 1.8rem; font-weight: 800; color: #37474f; border: none; background: none; width: 100%; text-align: center; }
        .btn-close-red { width: 35px; height: 35px; border-radius: 8px; background: #ffebee; color: #c62828; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        
        /* Stats & Sacks */
        .stats-row { display: flex; gap: 8px; padding: 0 15px 10px 15px; margin-top: -5px; }
        .stat-pill { background: #eceff1; color: #546e7a; font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
        .sack-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; background: #e0f2f1; padding: 10px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #b2dfdb; }
        .sack-item { text-align: center; }
        .sack-label { font-size: 0.7rem; color: #00695c; font-weight: bold; margin-bottom: 2px; }
        .sack-val { font-size: 1.4rem; font-weight: 800; color: #004d40; }

        /* Distribution */
        .dist-container { background: #fafafa; border-radius: 12px; padding: 10px; border: 1px dashed #cfd8dc; margin-top: 15px; }
        .dist-row-item { background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 10px; }
        .truck-context-bar { background: #fff8e1; border: 1px solid #ffecb3; border-radius: 8px; padding: 8px; margin: 8px 0; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #f57f17; font-weight: bold; }
        .input-fresh { background-color: #e8f5e9 !important; border-color: #a5d6a7 !important; }
        .input-stock { background-color: #e1f5fe !important; border-color: #81d4fa !important; }
        .input-green { background-color: #e8f5e9 !important; border-color: #a5d6a7 !important; }
        .btn-add-dist { width: 100%; padding: 12px; background: #eceff1; color: #546e7a; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-del-dist { background: none; border: none; color: #ef5350; font-weight: bold; cursor: pointer; font-size: 1.2rem; }

        /* FABs */
        .fab-container { position: fixed; bottom: 25px; right: 20px; z-index: 2000; display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
        .fab-main { width: 65px; height: 65px; border-radius: 50%; background: #00c853; color: white; border: none; font-size: 32px; box-shadow: 0 6px 20px rgba(0,200,83,0.4); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .fab-main.rotate { transform: rotate(45deg); background: #ff5252; }
        .fab-truck { position: fixed; bottom: 25px; left: 20px; z-index: 2000; width: 65px; height: 65px; border-radius: 50%; background: #0288d1; color: white; border: none; font-size: 30px; box-shadow: 0 6px 20px rgba(2,136,209,0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .fab-menu { display: none; flex-direction: column; gap: 12px; align-items: flex-end; }
        .fab-menu.show { display: flex; }
        .fab-item { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .fab-label { background: white; padding: 6px 12px; border-radius: 8px; font-weight: bold; color: #546e7a; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 0.9rem; }
        .fab-mini { width: 50px; height: 50px; border-radius: 50%; border: none; color: white; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; }
        .bg-green { background: #00c853; } .bg-orange { background: #ff9100; }

        /* Summary & Tables */
        .sum-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #cfd8dc; font-size: 1rem; }
        .sum-label { color: #455a64; font-weight: 600; }
        .sum-val { font-weight: 900; color: #263238; font-size: 1.1rem; }
        .sum-highlight { color: #0277bd; font-size: 1.2rem; }
        .divider-line { border-top: 2px dashed #b0bec5; margin: 15px 0; opacity: 0.5; }

        .report-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; margin-top: 5px; table-layout: fixed; }
        .report-table th, .report-table td { border: 1px solid #cfd8dc; padding: 8px 4px; text-align: center; }
        .th-time { background: #eceff1; color: #546e7a; }
        .th-withdraw { background: #e3f2fd; color: #1565c0; }
        .th-prod { background: #e8f5e9; color: #2e7d32; }
        .th-remain { background: #f3e5f5; color: #6a1b9a; }
        .td-prod-val { font-weight: 800; color: #2e7d32; background: #f1f8e9; }
        .td-remain-val { font-weight: 600; color: #37474f; background: #f3e5f5; }
        .td-withdraw-val { font-weight: 600; color: #37474f; background: #e3f2fd; }
        .td-dash { color: #cfd8dc; font-weight: 300; }

        .truck-matrix-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 5px; }
        .truck-matrix-table th { background: #eceff1; color: #546e7a; padding: 12px 8px; font-weight: 700; border-bottom: 2px solid #cfd8dc; font-size: 0.9rem; }
        .truck-matrix-table td { border-bottom: 1px solid #f0f0f0; padding: 10px 4px; text-align: center; vertical-align: middle; }
        .truck-name-col { text-align: left; padding-left: 15px; font-weight: 800; color: #37474f; font-size: 0.95rem; }
        .st-pill { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: 700; min-width: 60px; }
        .st-over { background: #e3f2fd; color: #1565c0; } .st-miss { background: #ffebee; color: #c62828; } .st-ok { background: #e8f5e9; color: #2e7d32; } .st-none { color: #cfd8dc; font-weight: 400; font-size: 1.2rem; }
        
        .detail-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 0.9rem; }
        .detail-table th { background: #fafafa; color: #546e7a; padding: 8px; border-bottom: 1px solid #ddd; font-weight: 700; font-size: 0.85rem; }
        .detail-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }
        .dt-fresh { color: #2e7d32; font-weight: bold; background: #f1f8e9; }
        .dt-stock { color: #1565c0; font-weight: bold; background: #e3f2fd; }
        .dt-total { font-weight: 900; color: #37474f; background: #eceff1; }
        .dt-row-label { font-weight: bold; color: #78909c; text-align: center; width: 20%; }

        .order-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .order-table th { background: #eceff1; padding: 8px; color: #546e7a; }
        .order-table td { padding: 8px 4px; border-bottom: 1px solid #eee; }
        .order-sum-col { font-weight: bold; color: #0277bd; background: #e1f5fe; text-align: center; }

        /* üî• NEW MODAL: Quick Allocator üî• */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background-color: #f5f7fa; margin: 5% auto; border-radius: 16px; width: 95%; max-width: 600px; max-height: 90vh; box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #fff; border-bottom: 2px solid #e0e0e0; flex-shrink: 0; border-radius: 16px 16px 0 0; }
        .modal-title { font-size: 1.3rem; font-weight: 800; color: #0277bd; }
        .btn-close-modal { background: #ffebee; color: #c62828; border: none; font-size: 1.5rem; font-weight: bold; height: 40px; width: 40px; border-radius: 50%; cursor: pointer; }
        .modal-body { overflow-y: auto; padding: 15px; flex-grow: 1; -webkit-overflow-scrolling: touch; }

        /* Allocator UI */
        .allocator-controls { display: flex; gap: 10px; margin-bottom: 15px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .control-group { flex: 1; }
        .control-label { display: block; font-size: 0.8rem; color: #78909c; margin-bottom: 5px; font-weight: bold; }
        .allocator-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cfd8dc; font-size: 1rem; font-weight: bold; background: #eceff1; color: #37474f; }
        
        .main-input-box { text-align: center; margin-bottom: 20px; }
        .main-input { width: 100%; padding: 15px; font-size: 2.5rem; text-align: center; border: 3px solid #0277bd; border-radius: 12px; font-weight: 800; color: #0277bd; background: #fff; }
        .main-input::placeholder { color: #e0e0e0; }

        .target-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .target-btn { 
            padding: 15px; border-radius: 12px; border: none; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; box-shadow: 0 4px 0 rgba(0,0,0,0.1); transition: all 0.1s;
        }
        .target-btn:active { transform: translateY(4px); box-shadow: none; }
        .tb-stock { background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; }
        .tb-fresh { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .tb-title { font-size: 1rem; font-weight: 800; margin-bottom: 5px; }
        .tb-val { font-size: 1.4rem; font-weight: 900; background: rgba(255,255,255,0.6); padding: 2px 10px; border-radius: 20px; min-width: 50px; }

        .status-display { text-align: center; margin-bottom: 15px; font-size: 1.1rem; font-weight: bold; color: #546e7a; background: #fff3e0; padding: 10px; border-radius: 8px; border: 1px dashed #ffe0b2; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="dash-item"><span>üßä ‡∏´‡∏•‡∏≠‡∏î</span><div id="dash_hl">0</div></div>
        <div class="dash-item"><span>üî® ‡∏´‡∏¢‡∏≤‡∏ö</span><div id="dash_bh">0</div></div>
        <div class="dash-item"><span>‚ùÑÔ∏è ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span><div id="dash_bl">0</div></div>
    </div>
    
    <div class="order-status-bar">
        <div class="os-item">‡∏™‡∏±‡πà‡∏á‡∏£‡∏ß‡∏°: <span id="os_total">0</span></div>
        <div class="os-item">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß: <span id="os_sent">0</span></div>
        <div class="os-item">‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á: <b id="os_remain">0</b></div>
    </div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchPage('setup')">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        <button class="nav-btn" onclick="switchPage('production')">2. ‡∏ú‡∏•‡∏¥‡∏ï/‡∏à‡πà‡∏≤‡∏¢</button>
        <button class="nav-btn" onclick="switchPage('summary')">3. ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button>
    </div>

    <div id="page-setup" class="page active">
        <div class="modern-card card-body">
            <h3 style="margin-top:0;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="setup_date" onchange="changeDate()">
            <div class="grid-2" style="margin-top:10px;">
                <div><label>üü¢ ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="time" id="time_start" value="22:00" onchange="saveData()"></div>
                <div><label>üî¥ ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="time" id="time_stop" value="06:00" onchange="saveData()"></div>
            </div>
        </div>
        <div class="modern-card card-body">
            <h3 style="margin-top:0;">üöö ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Master Order)</h3>
            <div id="order_inputs"></div>
        </div>
        <div style="height:100px;"></div>
    </div>

    <div id="page-production" class="page">
        <div id="drops_list"></div>
        <div style="height: 100px;"></div>
    </div>

    <button class="fab-truck" onclick="openAllocModal()">üöõ</button> <div class="fab-container">
        <div class="fab-menu" id="fab_menu">
            <div class="fab-item" onclick="addDrop('stock')">
                <span class="fab-label">üì¶ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏¢‡πá‡∏ô</span>
                <button class="fab-mini bg-orange">Stock</button>
            </div>
            <div class="fab-item" onclick="addDrop('prod')">
                <span class="fab-label">‚ùÑÔ∏è ‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ï‡∏Å</span>
                <button class="fab-mini bg-green">Prod</button>
            </div>
        </div>
        <button class="fab-main" onclick="toggleFab(this)">+</button>
    </div>

    <div id="alloc_modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üöõ ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Quick Allocator)</div>
                <button class="btn-close-modal" onclick="closeAllocModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <div class="allocator-controls">
                    <div class="control-group">
                        <label class="control-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ</label>
                        <select id="alloc_truck" class="allocator-select" onchange="updateAllocUI()">
                            </select>
                    </div>
                    <div class="control-group">
                        <label class="control-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á</label>
                        <select id="alloc_type" class="allocator-select" onchange="updateAllocUI()">
                            </select>
                    </div>
                </div>

                <div class="status-display" id="alloc_status">
                    ‡πÄ‡∏õ‡πâ‡∏≤: 0 | ‡πÉ‡∏™‡πà‡πÅ‡∏•‡πâ‡∏ß: 0 | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: 0
                </div>

                <div class="main-input-box">
                    <input type="tel" id="alloc_input" class="main-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô..." inputmode="numeric" pattern="[0-9]*">
                </div>

                <div style="text-align:center; color:#78909c; margin-bottom:10px; font-weight:bold;">‚è¨ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î ‚è¨</div>

                <div class="target-grid">
                    <button class="target-btn tb-stock" onclick="applyAlloc('r1s')">
                        <span class="tb-title">‡πÅ‡∏ñ‡∏ß 1 (‡πÄ‡∏Å‡πà‡∏≤)</span>
                        <span class="tb-val" id="val_r1s">0</span>
                    </button>
                    <button class="target-btn tb-fresh" onclick="applyAlloc('r1f')">
                        <span class="tb-title">‡πÅ‡∏ñ‡∏ß 1 (‡∏™‡∏î)</span>
                        <span class="tb-val" id="val_r1f">0</span>
                    </button>
                    <button class="target-btn tb-stock" onclick="applyAlloc('r2s')">
                        <span class="tb-title">‡πÅ‡∏ñ‡∏ß 2 (‡πÄ‡∏Å‡πà‡∏≤)</span>
                        <span class="tb-val" id="val_r2s">0</span>
                    </button>
                    <button class="target-btn tb-fresh" onclick="applyAlloc('r2f')">
                        <span class="tb-title">‡πÅ‡∏ñ‡∏ß 2 (‡∏™‡∏î)</span>
                        <span class="tb-val" id="val_r2f">0</span>
                    </button>
                    <button class="target-btn tb-stock" onclick="applyAlloc('r3s')">
                        <span class="tb-title">‡πÅ‡∏ñ‡∏ß 3 (‡πÄ‡∏Å‡πà‡∏≤)</span>
                        <span class="tb-val" id="val_r3s">0</span>
                    </button>
                    <button class="target-btn tb-fresh" onclick="applyAlloc('r3f')">
                        <span class="tb-title">‡πÅ‡∏ñ‡∏ß 3 (‡∏™‡∏î)</span>
                        <span class="tb-val" id="val_r3f">0</span>
                    </button>
                </div>
                
                <div style="height:50px;"></div>
            </div>
        </div>
    </div>

    <div id="page-summary" class="page">
        <div class="modern-card card-body">
             <h3 style="margin-top:0;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡∏Ñ‡∏±‡∏ô (Real-time)</h3>
             <div style="font-size:0.8rem; color:#90a4ae; margin-bottom:10px;">(‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ - ‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á = ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)</div>
             <div id="truck_report_container"></div>
        </div>
        
        <div class="modern-card card-body">
            <h3>üè≠ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ú‡∏•‡∏¥‡∏ï</h3>
            <div class="sum-row"><span class="sum-label">‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏¥‡∏ï:</span> <span><span class="sum-val" id="rpt_total_prod">0</span> ‡∏Å‡∏£‡∏∞‡∏™‡∏≠‡∏ö</span></div>
            <div class="divider-line"></div>
            <h4>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (Performance)</h4>
            <div class="sum-row"><span class="sum-label">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°:</span> <span class="sum-val" id="rpt_total_minutes" style="color:#0277bd;">0 ‡∏ô‡∏≤‡∏ó‡∏µ</span></div>
        </div>

        <div class="modern-card card-body">
             <h3 style="margin-top:0;">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ç‡∏≠‡∏á (‡∏£‡∏≤‡∏¢‡∏Ñ‡∏±‡∏ô)</h3>
             <div style="text-align:center; font-size:0.8rem; color:#aaa; margin-bottom:5px;">(‡∏ã‡πâ‡∏≤‡∏¢=‡πÄ‡∏Å‡πà‡∏≤ / ‡∏Ç‡∏ß‡∏≤=‡∏™‡∏î)</div>
             <div id="truck_detail_container"></div>
        </div>
    </div>

<script>
    // --- CONFIG ---
    const TRUCKS = ["‡∏£‡∏ñ 1", "‡∏£‡∏ñ 2", "‡∏£‡∏ñ 3", "‡∏£‡∏ñ 4", "‡∏£‡∏ñ 5", "‡∏£‡∏ñ 6", "‡∏£‡∏ñ 7", "‡∏£‡∏ñ 8", "‡∏£‡∏ñ 9"];
    const ICE_TYPES = [ { id: 'hl', label: '‡∏´‡∏•‡∏≠‡∏î' }, { id: 'bh', label: '‡∏´‡∏¢‡∏≤‡∏ö' }, { id: 'bl', label: '‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' } ];
    const WEIGHTS = { hl: 20, bh: 23, bl: 24 }; 
    let DATA = getEmptyData();

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('setup_date').value = today;
        loadData(today);
        renderOrderInputs();
        renderDrops();
        calcAll();
        initAllocModal(); // Prepare Dropdowns
    });

    function getEmptyData() {
        return {
            times: { start: "22:00", stop: "06:00" },
            initStock: { hl: 0, bh: 0, bl: 0 },
            orders: {}, drops: [],
            loadingLog: {} 
        };
    }

    function changeDate() {
        const newDate = document.getElementById('setup_date').value;
        loadData(newDate);
        renderOrderInputs();
        renderDrops();
        calcAll();
    }

    function saveData() { 
        const dateKey = document.getElementById('setup_date').value;
        DATA.times = { start: document.getElementById('time_start').value, stop: document.getElementById('time_stop').value };
        localStorage.setItem(`ICE_DATA_${dateKey}`, JSON.stringify(DATA)); 
    }
    
    function loadData(dateKey) {
        const d = localStorage.getItem(`ICE_DATA_${dateKey}`);
        if(d) {
            DATA = JSON.parse(d);
            if(!DATA.drops) DATA.drops = [];
            if(!DATA.orders) DATA.orders = {};
            if(!DATA.loadingLog) DATA.loadingLog = {}; 
        } else {
            DATA = getEmptyData();
        }
        document.getElementById('time_start').value = DATA.times.start;
        document.getElementById('time_stop').value = DATA.times.stop;
    }

    // --- üî• ALLOCATOR LOGIC (The New Brain) üî• ---
    function initAllocModal() {
        const tSel = document.getElementById('alloc_truck');
        const tySel = document.getElementById('alloc_type');
        
        tSel.innerHTML = TRUCKS.map((t,i) => `<option value="t${i+1}">${t}</option>`).join('');
        tySel.innerHTML = ICE_TYPES.map(ty => `<option value="${ty.id}">${ty.label}</option>`).join('');
    }

    function openAllocModal() {
        updateAllocUI();
        document.getElementById('alloc_modal').style.display = 'block';
        document.getElementById('alloc_input').focus();
    }

    function closeAllocModal() {
        document.getElementById('alloc_modal').style.display = 'none';
        calcAll(); // Refresh main view
    }

    window.onclick = function(event) {
        const modal = document.getElementById('alloc_modal');
        if (event.target == modal) { closeAllocModal(); }
    }

    function updateAllocUI() {
        const tid = document.getElementById('alloc_truck').value;
        const typeId = document.getElementById('alloc_type').value;
        const key = `${tid}_${typeId}`;
        
        const log = DATA.loadingLog[key] || {};
        const orderQty = DATA.orders[key] || 0;
        
        // Update Buttons Labels with current values
        document.getElementById('val_r1s').innerText = log.r1s || 0;
        document.getElementById('val_r1f').innerText = log.r1f || 0;
        document.getElementById('val_r2s').innerText = log.r2s || 0;
        document.getElementById('val_r2f').innerText = log.r2f || 0;
        document.getElementById('val_r3s').innerText = log.r3s || 0;
        document.getElementById('val_r3f').innerText = log.r3f || 0;

        // Calc Totals
        const totalLoaded = (log.r1s||0)+(log.r1f||0) + (log.r2s||0)+(log.r2f||0) + (log.r3s||0)+(log.r3f||0);
        const remaining = orderQty - totalLoaded;
        
        let statusHtml = `‡πÄ‡∏õ‡πâ‡∏≤: ${orderQty} | ‡πÉ‡∏™‡πà‡πÅ‡∏•‡πâ‡∏ß: ${totalLoaded} | `;
        if(remaining > 0) statusHtml += `<span style="color:#d32f2f">‡∏Ç‡∏≤‡∏î ${remaining}</span>`;
        else if(remaining < 0) statusHtml += `<span style="color:#1565c0">‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(remaining)}</span>`;
        else statusHtml += `<span style="color:#2e7d32">‡∏Ñ‡∏£‡∏ö</span>`;
        
        document.getElementById('alloc_status').innerHTML = statusHtml;
    }

    function applyAlloc(field) {
        const inputEl = document.getElementById('alloc_input');
        const val = parseFloat(inputEl.value);
        
        if(isNaN(val)) return; // Do nothing if empty

        const tid = document.getElementById('alloc_truck').value;
        const typeId = document.getElementById('alloc_type').value;
        const key = `${tid}_${typeId}`;

        if(!DATA.loadingLog[key]) DATA.loadingLog[key] = {};
        DATA.loadingLog[key][field] = val; // Set Value
        
        saveData();
        updateAllocUI(); // Refresh buttons
        
        // Optional: Clear input after add? 
        // inputEl.value = ''; // Uncomment if you want auto-clear
        inputEl.focus();
    }

    // --- Ops & Calc (Existing Logic) ---
    // ... (Keeping core functions: addDrop, renderDrops, updateOrder, etc. same as V57 logic) ...
    
    function renderOrderInputs() { const c = document.getElementById('order_inputs'); let h = '<table class="order-table"><thead><tr><th>‡∏£‡∏ñ</th><th>‡∏´‡∏•‡∏≠‡∏î</th><th>‡∏´‡∏¢‡∏≤‡∏ö</th><th>‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th class="col-total">‡∏£‡∏ß‡∏°</th></tr></thead><tbody>'; TRUCKS.forEach((t, i) => { const tid = `t${i+1}`; const hl = DATA.orders[tid+'_hl']||0; const bh = DATA.orders[tid+'_bh']||0; const bl = DATA.orders[tid+'_bl']||0; const total = hl + bh + bl; h += `<tr><td>${t}</td><td><input type="number" value="${hl===0?'':hl}" onchange="updateOrder('${tid}_hl',this.value)"></td><td><input type="number" value="${bh===0?'':bh}" onchange="updateOrder('${tid}_bh',this.value)"></td><td><input type="number" value="${bl===0?'':bl}" onchange="updateOrder('${tid}_bl',this.value)"></td><td class="order-sum-col">${total}</td></tr>`; }); h += '</tbody></table>'; c.innerHTML = h; }
    function updateOrder(k, v) { DATA.orders[k] = parseFloat(v)||0; saveData(); calcAll(); renderOrderInputs(); }

    function addDrop(type) { const now = new Date(); const timeStr = now.toTimeString().substring(0, 5); DATA.drops.push({ id: Date.now(), type: type, time: timeStr, sackWithdraw: type === 'prod' ? 80 : 0, p_in_room: { hl: 0, bh: 0, bl: 0 }, dist: [] }); saveData(); renderDrops(); toggleFab(document.querySelector('.fab-main')); }
    function renderDrops() { /* Standard Drop Rendering */ document.getElementById('drops_list').innerHTML = ''; /* ... abbreviated for brevity ... */ }
    function toggleFab(btn) { document.getElementById('fab_menu').classList.toggle('show'); btn.classList.toggle('rotate'); }

    // --- MAIN CALCULATION (Simplified for V58 Demo) ---
    function calcAll() {
        let sumP={hl:0,bh:0,bl:0};
        let truckTotals = {}; 
        TRUCKS.forEach((t, i) => { truckTotals[`t${i+1}`] = { hl:0, bh:0, bl:0 }; });

        // Merge "Drops" logic here if needed, but primary focus is Loading Board
        // For V58, we use loadingLog as the source of truth for "Sent" amounts in reports
        
        // 1. Matrix Report
        let mHtml = `<table class="truck-matrix-table"><thead><tr><th style="text-align:left; padding-left:15px;">‡∏£‡∏ñ</th><th>‡∏´‡∏•‡∏≠‡∏î</th><th>‡∏´‡∏¢‡∏≤‡∏ö</th><th>‡∏•‡∏∞..</th></tr></thead><tbody>`;
        TRUCKS.forEach((t, i) => {
            const tid = `t${i+1}`;
            mHtml += `<tr><td class="truck-name-col">${t}</td>`;
            ICE_TYPES.forEach(type => {
                const log = DATA.loadingLog[`${tid}_${type.id}`] || {};
                const loaded = (log.r1s||0)+(log.r1f||0) + (log.r2s||0)+(log.r2f||0) + (log.r3s||0)+(log.r3f||0);
                const target = DATA.orders[`${tid}_${type.id}`] || 0;
                const rem = target - loaded;
                
                let cell = `<span class="st-none">-</span>`;
                if(target>0 || loaded>0) {
                    if(rem > 0) cell = `<span class="st-pill st-miss">‡∏Ç‡∏≤‡∏î ${rem}</span>`;
                    else if(rem < 0) cell = `<span class="st-pill st-over">‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(rem)}</span>`;
                    else cell = `<span class="st-pill st-ok">‡∏Ñ‡∏£‡∏ö</span>`;
                }
                mHtml += `<td>${cell}</td>`;
            });
            mHtml += `</tr>`;
        });
        mHtml += `</tbody></table>`;
        document.getElementById('truck_report_container').innerHTML = mHtml;

        // 2. Detail Report
        let dHtml = '';
        TRUCKS.forEach((t, i) => {
            const tid = `t${i+1}`;
            let hasData = false;
            ICE_TYPES.forEach(type => { if(DATA.loadingLog[`${tid}_${type.id}`] || DATA.orders[`${tid}_${type.id}`]) hasData=true; });
            
            if(hasData) {
                dHtml += `<div style="background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid #e0e0e0;"><div style="font-weight:800; color:#006064; margin-bottom:10px;">üöõ ${t}</div>`;
                ICE_TYPES.forEach(type => {
                    const log = DATA.loadingLog[`${tid}_${type.id}`] || {};
                    const total = (log.r1s||0)+(log.r1f||0) + (log.r2s||0)+(log.r2f||0) + (log.r3s||0)+(log.r3f||0);
                    if(total > 0 || (DATA.orders[`${tid}_${type.id}`]||0) > 0) {
                        dHtml += `<div style="margin-bottom:10px;"><div style="font-weight:bold; color:#0277bd;">${type.label}</div>
                        <table class="detail-table"><thead><tr><th style="width:20%;">‡πÅ‡∏ñ‡∏ß</th><th>‡πÄ‡∏Å‡πà‡∏≤</th><th>‡∏™‡∏î</th><th>‡∏£‡∏ß‡∏°</th></tr></thead><tbody>
                        <tr><td>1</td><td class="dt-stock">${log.r1s||'-'}</td><td class="dt-fresh">${log.r1f||'-'}</td><td>${(log.r1s||0)+(log.r1f||0)}</td></tr>
                        <tr><td>2</td><td class="dt-stock">${log.r2s||'-'}</td><td class="dt-fresh">${log.r2f||'-'}</td><td>${(log.r2s||0)+(log.r2f||0)}</td></tr>
                        <tr><td>3</td><td class="dt-stock">${log.r3s||'-'}</td><td class="dt-fresh">${log.r3f||'-'}</td><td>${(log.r3s||0)+(log.r3f||0)}</td></tr>
                        <tr><td colspan="3" style="text-align:right; font-weight:bold;">‡∏£‡∏ß‡∏°:</td><td class="dt-total">${total}</td></tr>
                        </tbody></table></div>`;
                    }
                });
                dHtml += `</div>`;
            }
        });
        document.getElementById('truck_detail_container').innerHTML = dHtml;
        
        // Time & Prod Stats (Placeholders for demo logic)
        const startTimeVal = document.getElementById('time_start').value;
        const now = new Date(); 
        const timeStr = now.toTimeString().substring(0, 5);
        // Note: Full logic requires the 'drops' array parsing from V57, assumed here for brevity
    }

    function switchPage(id) {
        document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
        document.getElementById('page-'+id).classList.add('active');
        const map = { setup:0, production:1, summary:2 };
        document.querySelectorAll('.nav-btn')[map[id]].classList.add('active');
        if(id==='summary') { calcAll(); window.scrollTo(0,0); }
    }
</script>
</body>
</html>
