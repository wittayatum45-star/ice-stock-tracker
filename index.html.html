<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ice Stock Tracker (AjarnG Edition)</title>
    <style>
        /* สไตล์เบื้องต้นให้ดูเหมือนแอปมือถือ */
        body { 
            font-family: sans-serif; 
            margin: 0; 
            padding: 15px; 
            background: #f4f4f9; 
        }
        h1 { 
            color: #007bff; 
            text-align: center; 
            margin-bottom: 25px;
        }
        .stock-display, .log-area, .transaction-form { 
            margin-bottom: 20px; 
            padding: 15px; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .stock-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px solid #eee; 
            font-size: 1.1em;
        }
        .form-control { 
            margin-bottom: 10px; 
        }
        .form-control label { 
            display: block; 
            font-weight: bold; 
            margin-bottom: 5px; 
        }
        select, input[type="number"] {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        button { 
            padding: 12px 15px; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 15px; 
            font-size: 18px;
            font-weight: bold;
        }
        .log-list { 
            max-height: 250px; 
            overflow-y: scroll; 
            border: 1px solid #ccc; 
            border-radius: 4px;
            padding: 10px; 
        }
        .log-entry { 
            margin-bottom: 8px; 
            border-bottom: 1px dotted #ccc; 
            padding-bottom: 8px; 
            font-size: 0.95em; 
        }
    </style>
</head>
<body>

    <h1>❄️ Ice Stock Tracker</h1>

    <div class="stock-display" id="current-stock">
        <h2>สต๊อกปัจจุบัน (กระสอบ)</h2>
        </div>

    <div class="transaction-form">
        <h2>บันทึกรายการ</h2>
        <div class="form-control">
            <label for="truck-id">หมายเลขรถ:</label>
            <select id="truck-id">
                <option value="1">รถ 1</option><option value="2">รถ 2</option><option value="3">รถ 3</option>
                <option value="4">รถ 4</option><option value="5">รถ 5</option><option value="6">รถ 6</option>
                <option value="7">รถ 7</option><option value="8">รถ 8</option><option value="9">รถ 9</option>
            </select>
        </div>
        <div class="form-control">
            <label for="ice-type">ประเภทน้ำแข็ง:</label>
            <select id="ice-type">
                <option value="หลอด">หลอด</option>
                <option value="บดหยาบ">บดหยาบ</option>
                <option value="บดละเอียด">บดละเอียด</option>
            </select>
        </div>
        <div class="form-control">
            <label for="quantity">จำนวนกระสอบ:</label>
            <input type="number" id="quantity" min="1" value="1">
        </div>
        <div class="form-control">
            <label for="action-type">การกระทำ:</label>
            <select id="action-type">
                <option value="OUT">นำออก (ไปส่ง)</option>
                <option value="IN">นำเข้า (กลับสต๊อก)</option>
            </select>
        </div>
        <button onclick="recordTransaction()">บันทึกรายการ</button>
    </div>

    <div class="log-area">
        <h2>ประวัติการเคลื่อนไหว (10 รายการล่าสุด)</h2>
        <div class="log-list" id="transaction-log">
            </div>
    </div>

    <script>
        // กำหนดสต๊อกเริ่มต้น (ถ้าไม่เจอใน Local Storage)
        const INITIAL_STOCK = {
            "หลอด": 100, // สมมติว่ามี 100 กระสอบ
            "บดหยาบ": 50,
            "บดละเอียด": 30
        };

        // Key สำหรับเก็บข้อมูลใน Local Storage
        const STOCK_KEY = 'ajarnG_ice_stock';
        const LOG_KEY = 'ajarnG_ice_log';

        // ----------------------------------------------------
        // 1. ฟังก์ชันจัดการข้อมูล (Data Handlers)
        // ----------------------------------------------------

        /** ดึงข้อมูลสต๊อกจาก Local Storage */
        function getStock() {
            const stockData = localStorage.getItem(STOCK_KEY);
            return stockData ? JSON.parse(stockData) : INITIAL_STOCK;
        }

        /** บันทึกข้อมูลสต๊อกลง Local Storage */
        function saveStock(stock) {
            localStorage.setItem(STOCK_KEY, JSON.stringify(stock));
        }

        /** ดึงข้อมูล Log จาก Local Storage */
        function getLog() {
            const logData = localStorage.getItem(LOG_KEY);
            let log = logData ? JSON.parse(logData) : [];
            // เรียงจากใหม่ไปเก่า (เวลาเยอะสุดอยู่บน)
            return log.sort((a, b) => b.timestamp - a.timestamp); 
        }

        /** บันทึก Log ใหม่ */
        function addLog(newEntry) {
            const log = getLog();
            log.push(newEntry);
            localStorage.setItem(LOG_KEY, JSON.stringify(log)); 
        }

        // ----------------------------------------------------
        // 2. ฟังก์ชันแสดงผล (Render Functions)
        // ----------------------------------------------------

        /** อัพเดทการแสดงผลสต๊อกปัจจุบัน */
        function renderStock() {
            const stock = getStock();
            const stockContainer = document.getElementById('current-stock');
            
            // เคลียร์ของเก่า
            stockContainer.innerHTML = '<h2>สต๊อกปัจจุบัน (กระสอบ)</h2>'; 

            for (const type in stock) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'stock-item';
                itemDiv.innerHTML = `
                    <strong>${type}:</strong>
                    <span>${stock[type]} กระสอบ</span>
                `;
                stockContainer.appendChild(itemDiv);
            }
        }

        /** อัพเดทการแสดงผล Log */
        function renderLog() {
            const log = getLog();
            const logContainer = document.getElementById('transaction-log');
            logContainer.innerHTML = ''; // เคลียร์ของเก่า

            // แสดงเฉพาะ 10 รายการล่าสุด
            log.slice(0, 10).forEach(entry => {
                const date = new Date(entry.timestamp);
                // รูปแบบเวลาในไทย: 08:30:00 
                const timeStr = date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                const actionText = entry.action === 'OUT' 
                    ? `<strong style="color: red;">นำออก</strong>` 
                    : `<strong style="color: green;">นำกลับ</strong>`;

                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    [${timeStr}] รถ ${entry.truck_id} ${actionText} ${entry.quantity} กระสอบ 
                    (${entry.ice_type}).
                `;
                logContainer.appendChild(logEntry);
            });

            if (log.length === 0) {
                logContainer.innerHTML = '<p style="text-align: center; color: #6c757d;">ยังไม่มีรายการเคลื่อนไหว</p>';
            }
        }

        // ----------------------------------------------------
        // 3. ฟังก์ชันบันทึกรายการ (Transaction Logic)
        // ----------------------------------------------------

        /** ฟังก์ชันนี้ถูกเรียกเมื่อกดปุ่ม "บันทึกรายการ" ใน HTML */
        function recordTransaction() {
            const truckId = document.getElementById('truck-id').value;
            const iceType = document.getElementById('ice-type').value;
            const quantityInput = document.getElementById('quantity');
            const quantity = parseInt(quantityInput.value);
            const action = document.getElementById('action-type').value;

            if (quantity <= 0 || isNaN(quantity)) {
                alert('ลูกศิษย์! จำนวนกระสอบต้องมากกว่า 0 นะ');
                return;
            }

            let currentStock = getStock();

            if (action === 'OUT') {
                // นำออก
                if (currentStock[iceType] < quantity) {
                    alert(`น้ำแข็ง ${iceType} ไม่พอ! มีแค่ ${currentStock[iceType]} กระสอบ`);
                    return; // หยุดการทำงานถ้าสต๊อกไม่พอ
                }
                currentStock[iceType] -= quantity;
            } else {
                // นำเข้า (กลับมาสต๊อก)
                currentStock[iceType] += quantity;
            }

            // 1. บันทึกสต๊อกใหม่
            saveStock(currentStock);

            // 2. บันทึก Log การเคลื่อนไหว
            const logEntry = {
                timestamp: Date.now(), // เวลาปัจจุบันเป็นตัวเลข milliseconds
                truck_id: truckId,
                ice_type: iceType,
                quantity: quantity,
                action: action
            };
            addLog(logEntry);

            // 3. อัพเดทหน้าจอ
            renderStock();
            renderLog();

            // แจ้งเตือนความสำเร็จ
            alert(`บันทึกรายการสำเร็จ! รถ ${truckId} ${action === 'OUT' ? 'นำออก' : 'นำกลับ'} ${quantity} กระสอบ`);
            
            // ตั้งค่า Quantity เป็น 1 เหมือนเดิม
            quantityInput.value = 1;
        }

        // ----------------------------------------------------
        // 4. การเริ่มต้นระบบ (Initialization)
        // ----------------------------------------------------

        // ตรวจสอบและบันทึกสต๊อกเริ่มต้น ถ้ายังไม่มี
        if (!localStorage.getItem(STOCK_KEY)) {
            saveStock(INITIAL_STOCK);
        }

        // เรียกฟังก์ชันแสดงผลเมื่อโหลดหน้าจอ
        renderStock();
        renderLog();

    </script>
</body>
</html>
